---
phase: 07-images-in-editor
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - electron-app/src/renderer/components/knowledge/editor/node-views/resizable-image-view.tsx
  - electron-app/src/renderer/components/knowledge/editor/extensions/resizable-image.ts
  - electron-app/src/renderer/components/knowledge/editor-styles.css
autonomous: false

must_haves:
  truths:
    - "Images can be resized by dragging corner handles when selected"
    - "Images show a skeleton/pulse animation while loading (data-loading='true')"
    - "Resized dimensions persist in document JSON (width/height attributes survive save/reload)"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/editor/node-views/resizable-image-view.tsx"
      provides: "React NodeView with resize handles and loading placeholder"
      contains: "ResizableImageView"
      min_lines: 60
    - path: "electron-app/src/renderer/components/knowledge/editor/extensions/resizable-image.ts"
      provides: "Custom image extension with ReactNodeViewRenderer"
      contains: "ReactNodeViewRenderer"
  key_links:
    - from: "editor/extensions/resizable-image.ts"
      to: "editor/node-views/resizable-image-view.tsx"
      via: "ReactNodeViewRenderer(ResizableImageView) in addNodeView()"
      pattern: "ReactNodeViewRenderer.*ResizableImageView"
    - from: "resizable-image-view.tsx"
      to: "TipTap NodeViewProps"
      via: "updateAttributes({ width, height }) persists resize to document JSON"
      pattern: "updateAttributes.*width.*height"
---

<objective>
Add image resize handles and loading placeholder animation to the TipTap editor images.

Purpose: Users need to resize images to fit their document layout, and see visual feedback while images upload. This plan adds a React NodeView with drag handles for resizing and a skeleton animation for loading state.
Output: Resizable images with corner drag handles and a pulse/skeleton animation during upload.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-images-in-editor/07-RESEARCH.md
@.planning/phases/07-images-in-editor/07-01-SUMMARY.md

# Key existing files to reference
@electron-app/src/renderer/components/knowledge/editor/extensions/resizable-image.ts
@electron-app/src/renderer/components/knowledge/editor-styles.css
@electron-app/src/renderer/components/knowledge/editor-extensions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ResizableImageView React NodeView with resize handles and loading placeholder</name>
  <files>
    electron-app/src/renderer/components/knowledge/editor/node-views/resizable-image-view.tsx
    electron-app/src/renderer/components/knowledge/editor/extensions/resizable-image.ts
    electron-app/src/renderer/components/knowledge/editor-styles.css
  </files>
  <action>
**Create `editor/node-views/resizable-image-view.tsx`:**

Build a React component that receives TipTap `NodeViewProps` and renders the image with resize handles and loading state.

```tsx
import { NodeViewWrapper } from '@tiptap/react'
import type { NodeViewProps } from '@tiptap/react'
import { useCallback, useRef, useState } from 'react'
```

Component: `ResizableImageView({ node, updateAttributes, selected }: NodeViewProps)`

Extract from `node.attrs`: `src`, `alt`, `title`, `width`, `height`, and `data-loading` (rename to `isLoading`).

State: `const [isResizing, setIsResizing] = useState(false)`
Ref: `const imgRef = useRef<HTMLImageElement>(null)`

**Loading state:** When `isLoading === 'true'`, render a skeleton overlay. Use a `div` with `className="absolute inset-0 bg-muted/50 animate-pulse rounded flex items-center justify-center"` over the image. Include a small image icon (Lucide `ImageIcon`) centered in the skeleton for visual clarity. The image itself should still be rendered underneath with reduced opacity (`opacity-50`) so the user sees a preview.

**Resize handles:** Only show when `selected` is true and `isLoading` is falsy. Render four corner handles (se, sw, ne, nw) as small circular divs positioned absolutely at each corner.

Each handle: `className="absolute w-3 h-3 bg-primary border-2 border-background rounded-full"` with appropriate positioning classes:
- `se`: `bottom-0 right-0 translate-x-1/2 translate-y-1/2 cursor-se-resize`
- `sw`: `bottom-0 left-0 -translate-x-1/2 translate-y-1/2 cursor-sw-resize`
- `ne`: `top-0 right-0 translate-x-1/2 -translate-y-1/2 cursor-ne-resize`
- `nw`: `top-0 left-0 -translate-x-1/2 -translate-y-1/2 cursor-nw-resize`

**Resize logic:** `handleResizeStart(e: React.MouseEvent, corner: string)`:
1. `e.preventDefault()` and `e.stopPropagation()`.
2. `setIsResizing(true)`.
3. Capture `startX`, `startY` from `e.clientX/Y`.
4. Capture `startWidth` from `imgRef.current?.offsetWidth || 200` and `startHeight` from `imgRef.current?.offsetHeight || 200`.
5. Compute `aspectRatio = startWidth / startHeight`.
6. Attach `mousemove` and `mouseup` listeners to `document`.
7. On `mousemove`: calculate `dx` based on corner direction (positive for `se`/`ne`, negative for `sw`/`nw`). Compute `newWidth = Math.max(50, startWidth + dx)`, `newHeight = Math.round(newWidth / aspectRatio)`. Apply to `imgRef.current.style.width` and `imgRef.current.style.height` for live preview.
8. On `mouseup`: `setIsResizing(false)`, remove listeners, call `updateAttributes({ width: imgRef.current.offsetWidth, height: imgRef.current.offsetHeight })` to persist to document JSON.

**Selection ring:** When `selected` and not resizing, show `ring-2 ring-primary ring-offset-2` on the image.

**Wrapper:** Use `<NodeViewWrapper className="relative inline-block max-w-full" data-drag-handle>`.

**Image element:** `<img ref={imgRef} src={src} alt={alt || ''} title={title || undefined} width={width || undefined} height={height || undefined} className="max-w-full block" style={{ width: width ? \`${width}px\` : undefined, height: height ? \`${height}px\` : undefined }} draggable={false} />`

Note: Set both the `width` attribute AND `style.width` -- the attribute stores the value, the style ensures it renders at that size even when first loaded.

**Update `editor/extensions/resizable-image.ts`:**

Import `{ ReactNodeViewRenderer }` from `@tiptap/react` and `{ ResizableImageView }` from `../node-views/resizable-image-view`.

Add `addNodeView()` method to the extension:
```typescript
addNodeView() {
  return ReactNodeViewRenderer(ResizableImageView)
},
```

**Update `editor-styles.css`:**

Add CSS for the resizable image NodeView wrapper to prevent ProseMirror's default image handling from conflicting:

```css
/* Resizable image NodeView */
.ProseMirror .node-image {
  display: inline-block;
  max-width: 100%;
}

/* Prevent drag ghost when resizing */
.ProseMirror .node-image[data-drag-handle] img {
  -webkit-user-drag: none;
}

/* Loading skeleton pulse for images */
.ProseMirror .node-image .image-loading-overlay {
  pointer-events: none;
}
```
  </action>
  <verify>
Run `cd D:/FTX_CODE/pm-project/electron-app && npx tsc --noEmit` to confirm TypeScript compiles.
Run `npm run dev` and open the Notes screen. Insert an image, then click on it to see resize handles appear at corners. Drag a corner handle to resize. Verify the resized dimensions persist after clicking away and back.
  </verify>
  <done>
Images in the editor show resize handles at four corners when selected. Dragging a handle resizes the image while maintaining aspect ratio. Dimensions are persisted as width/height attributes in document JSON. Images with data-loading='true' show a skeleton/pulse animation overlay.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Image paste/drop/upload with resize handles and loading placeholder in the TipTap editor</what-built>
  <how-to-verify>
    1. Run `cd D:/FTX_CODE/pm-project/electron-app && npm run dev` and open the Notes screen
    2. Open or create a document
    3. **Paste test**: Copy an image from another app (e.g., screenshot, browser image), paste into the editor. Image should appear at cursor position with a brief loading animation, then resolve to the uploaded image.
    4. **Drag-and-drop test**: Drag an image file from the file explorer into the editor. Image should appear where dropped.
    5. **Toolbar upload test**: Click the image button in the toolbar. File picker dialog should open. Select an image. It should appear in the document.
    6. **Resize test**: Click on an inserted image. Four corner handles should appear. Drag the bottom-right handle to resize. Aspect ratio should be maintained. Click away, then click back -- the image should retain its resized dimensions.
    7. **Loading placeholder test**: While an image uploads (use a large image or throttle network), you should see a skeleton/pulse animation overlay on the image.
    8. **Persistence test**: After inserting and resizing an image, reload the document. The image should appear at the resized dimensions.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in electron-app
2. Images show resize handles at four corners when selected
3. Dragging a corner handle resizes the image maintaining aspect ratio
4. Loading state shows skeleton/pulse animation
5. Resized dimensions persist in document JSON (width/height attributes)
6. All three insertion methods work: paste, drag-and-drop, toolbar button
</verification>

<success_criteria>
- Resize handles appear at four corners when an image is selected
- Dragging any corner handle resizes the image while maintaining aspect ratio (minimum width: 50px)
- Resized width/height values are stored as node attributes and persist across save/reload
- Images with data-loading='true' show a skeleton/pulse animation overlay
- Human verification confirms all image features work end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/07-images-in-editor/07-02-SUMMARY.md`
</output>
