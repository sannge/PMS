---
phase: 07-images-in-editor
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - electron-app/src/renderer/components/knowledge/extensions/resizable-image.ts
  - electron-app/src/renderer/components/knowledge/node-views/resizable-image-view.tsx
  - electron-app/src/renderer/components/knowledge/editor-extensions.ts
  - electron-app/src/renderer/components/knowledge/editor-styles.css
autonomous: true

must_haves:
  truths:
    - "Selecting an image in the editor shows resize handles at the four corners"
    - "Dragging a corner handle resizes the image while maintaining aspect ratio"
    - "Resized dimensions persist as node attributes (width/height) and survive save/reload"
    - "Images show a pulsing skeleton placeholder while loading (data-loading='true')"
    - "After upload completes, the skeleton is replaced by the actual image"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/extensions/resizable-image.ts"
      provides: "Custom ResizableImage extension extending @tiptap/extension-image"
      exports: ["ResizableImage"]
    - path: "electron-app/src/renderer/components/knowledge/node-views/resizable-image-view.tsx"
      provides: "React NodeView component with resize handles and loading skeleton"
      exports: ["ResizableImageView"]
  key_links:
    - from: "electron-app/src/renderer/components/knowledge/extensions/resizable-image.ts"
      to: "electron-app/src/renderer/components/knowledge/node-views/resizable-image-view.tsx"
      via: "ReactNodeViewRenderer(ResizableImageView)"
      pattern: "ReactNodeViewRenderer"
    - from: "electron-app/src/renderer/components/knowledge/editor-extensions.ts"
      to: "electron-app/src/renderer/components/knowledge/extensions/resizable-image.ts"
      via: "ResizableImage replaces Image in extensions array"
      pattern: "ResizableImage"
---

<objective>
Add image resize handles via a custom React NodeView and loading placeholder animation for images being uploaded.

Purpose: Complete the image experience -- users can resize images to fit their document layout, and see immediate visual feedback during upload.
Output: ResizableImage extension with drag-handle resizing and skeleton loading state.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-images-in-editor/07-RESEARCH.md
@.planning/phases/07-images-in-editor/07-01-SUMMARY.md

Key codebase files:
@electron-app/src/renderer/components/knowledge/editor-extensions.ts — Extension factory (replace Image with ResizableImage)
@electron-app/src/renderer/components/knowledge/editor-styles.css — Editor CSS (add resize handle styles)
@electron-app/src/renderer/components/knowledge/document-editor.tsx — DocumentEditor component
</context>

<tasks>

<task type="auto">
  <name>Task 1: ResizableImage extension and React NodeView component</name>
  <files>
    electron-app/src/renderer/components/knowledge/extensions/resizable-image.ts
    electron-app/src/renderer/components/knowledge/node-views/resizable-image-view.tsx
  </files>
  <action>
    1. Create directories: `electron-app/src/renderer/components/knowledge/extensions/` and `electron-app/src/renderer/components/knowledge/node-views/`

    2. Create `extensions/resizable-image.ts`:
    - Import `Image` from `@tiptap/extension-image` and `ReactNodeViewRenderer` from `@tiptap/react`
    - Import `ResizableImageView` from the node-views file
    - Export `ResizableImage = Image.extend({ ... })` that:
      - Overrides `addAttributes()`: call `this.parent?.()` to get base attrs, add `width` (default: null, renderHTML returns `{ width }` if set, parseHTML reads `element.getAttribute('width')` or `element.style.width`) and `height` (same pattern)
      - Overrides `addNodeView()`: return `ReactNodeViewRenderer(ResizableImageView)`
      - Configure: `inline: false`, `allowBase64: false`

    3. Create `node-views/resizable-image-view.tsx`:
    - Import `NodeViewWrapper` and `NodeViewProps` from `@tiptap/react`
    - Import `useCallback`, `useRef`, `useState` from `react`
    - Implement `ResizableImageView` component:

    Props (from NodeViewProps): `node`, `updateAttributes`, `selected`

    State: `isResizing` boolean

    Extract from `node.attrs`: `src`, `alt`, `title`, `width`, `height`
    Check `isLoading = node.attrs['data-loading'] === 'true'`

    Resize logic (`handleResizeStart`):
    - On mousedown on a corner handle: capture startX, startWidth, startHeight, aspectRatio
    - On mousemove: calculate newWidth from delta, derive newHeight from aspectRatio, apply to imgRef style (live preview)
    - On mouseup: call `updateAttributes({ width: imgRef.current.offsetWidth, height: imgRef.current.offsetHeight })` to persist, remove event listeners, set isResizing false
    - Minimum width: 50px
    - All four corners resize proportionally (only horizontal delta matters for aspect-ratio resize)

    Render:
    ```tsx
    <NodeViewWrapper className="resizable-image-wrapper" data-drag-handle>
      {isLoading && (
        <div className="resizable-image-skeleton" />
      )}
      <img
        ref={imgRef}
        src={src}
        alt={alt || ''}
        title={title || undefined}
        width={width || undefined}
        height={height || undefined}
        className={`resizable-image ${selected ? 'resizable-image--selected' : ''} ${isLoading ? 'resizable-image--loading' : ''}`}
        draggable={false}
        onLoad={() => { /* if was loading, could clear loading state here if needed */ }}
      />
      {selected && !isLoading && (
        <>
          {['nw', 'ne', 'sw', 'se'].map(corner => (
            <div
              key={corner}
              className={`resizable-image-handle resizable-image-handle--${corner}`}
              onMouseDown={(e) => handleResizeStart(e, corner)}
            />
          ))}
        </>
      )}
    </NodeViewWrapper>
    ```

    IMPORTANT design notes:
    - Set `draggable={false}` on the img to prevent browser native drag from conflicting with resize
    - Use `e.preventDefault()` and `e.stopPropagation()` in handleResizeStart to prevent ProseMirror selection changes during resize
    - Add document-level mousemove/mouseup listeners (not on the handle element) so resize works even when cursor leaves the handle
  </action>
  <verify>
    - `cd electron-app && npx tsc --noEmit` — TypeScript compilation succeeds
    - Both new files exist and export their symbols
  </verify>
  <done>
    - ResizableImage extension extends Image with width/height attributes and React NodeView
    - ResizableImageView renders image with resize handles on selection
    - Drag handles resize proportionally (aspect ratio maintained)
    - Loading skeleton shown when data-loading='true'
    - Resized dimensions persisted as node attributes via updateAttributes
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ResizableImage into editor and add CSS styles</name>
  <files>
    electron-app/src/renderer/components/knowledge/editor-extensions.ts
    electron-app/src/renderer/components/knowledge/editor-styles.css
  </files>
  <action>
    1. Update `editor-extensions.ts`:
    - Remove: `import Image from '@tiptap/extension-image'` (if it was added in plan 07-01)
    - Add: `import { ResizableImage } from './extensions/resizable-image'`
    - In `createDocumentExtensions`, replace `Image.configure({ inline: false, allowBase64: false })` with `ResizableImage` (the extension already has inline: false, allowBase64: false configured internally)
    - Keep all other extensions (FileHandler, etc.) as-is

    2. Add CSS to `editor-styles.css` for resize handles and loading skeleton:

    ```css
    /* Resizable Image */
    .resizable-image-wrapper {
      position: relative;
      display: inline-block;
      max-width: 100%;
      line-height: 0;
    }

    .resizable-image {
      max-width: 100%;
      display: block;
      cursor: default;
    }

    .resizable-image--selected {
      outline: 2px solid hsl(var(--primary));
      outline-offset: 2px;
      border-radius: 2px;
    }

    .resizable-image--loading {
      opacity: 0.5;
    }

    /* Loading skeleton overlay */
    .resizable-image-skeleton {
      position: absolute;
      inset: 0;
      background: hsl(var(--muted));
      border-radius: 4px;
      animation: image-skeleton-pulse 1.5s ease-in-out infinite;
    }

    @keyframes image-skeleton-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    /* Resize handles */
    .resizable-image-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: hsl(var(--primary));
      border: 2px solid hsl(var(--background));
      border-radius: 50%;
      z-index: 10;
    }

    .resizable-image-handle--nw {
      top: -5px;
      left: -5px;
      cursor: nwse-resize;
    }

    .resizable-image-handle--ne {
      top: -5px;
      right: -5px;
      cursor: nesw-resize;
    }

    .resizable-image-handle--sw {
      bottom: -5px;
      left: -5px;
      cursor: nesw-resize;
    }

    .resizable-image-handle--se {
      bottom: -5px;
      right: -5px;
      cursor: nwse-resize;
    }
    ```

    Design notes:
    - Use CSS custom properties (hsl(var(--primary)), hsl(var(--muted)), hsl(var(--background))) for theme consistency with shadcn/ui
    - The skeleton pulse animation matches the common loading pattern in the app
    - Handles are 10px circles positioned at corners with z-index: 10 to stay above editor content
    - outline-offset prevents the selection ring from overlapping the image
  </action>
  <verify>
    - `cd electron-app && npx tsc --noEmit` — TypeScript compilation succeeds
    - editor-styles.css contains resizable-image classes
    - editor-extensions.ts imports ResizableImage (not plain Image)
  </verify>
  <done>
    - ResizableImage replaces Image in the editor extensions array
    - CSS styles provide: selection outline, resize handle circles at corners, loading skeleton pulse animation
    - Theme-consistent colors using CSS custom properties
    - Editor renders images with resize handles when selected
  </done>
</task>

</tasks>

<verification>
1. `cd electron-app && npx tsc --noEmit` passes
2. ResizableImage extension exists and is registered in createDocumentExtensions
3. ResizableImageView component renders with resize handles
4. CSS includes skeleton animation and handle styles
5. Selected images show corner handles; unselected images show no handles
6. Images with data-loading='true' show skeleton overlay
</verification>

<success_criteria>
- Selecting an image shows four corner resize handles
- Dragging a handle resizes the image proportionally
- Width and height are persisted as node attributes (survive save/reload)
- Images being uploaded show a pulsing skeleton placeholder
- Skeleton disappears when the permanent URL loads
- All styles use theme-consistent CSS custom properties
</success_criteria>

<output>
After completion, create `.planning/phases/07-images-in-editor/07-02-SUMMARY.md`
</output>
