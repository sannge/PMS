---
phase: 07-images-in-editor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fastapi-backend/app/routers/document_images.py
  - fastapi-backend/app/routers/__init__.py
  - fastapi-backend/app/main.py
  - electron-app/src/renderer/components/knowledge/editor-extensions.ts
  - electron-app/src/renderer/components/knowledge/image-upload.ts
  - electron-app/src/renderer/components/knowledge/editor-toolbar.tsx
  - fastapi-backend/app/services/content_converter.py

must_haves:
  truths:
    - "POST /api/documents/images/upload accepts an image file and document_id, stores in MinIO, returns URL"
    - "Non-image MIME types are rejected with 400"
    - "Images over 10MB are rejected with 413"
    - "Pasting an image from clipboard inserts it at cursor position in the editor"
    - "Dragging and dropping an image file into the editor inserts it at drop position"
    - "Toolbar upload button opens file picker and inserts selected image at cursor"
    - "Image nodes in TipTap JSON are converted to Markdown ![alt](src) by content converter"
  artifacts:
    - path: "fastapi-backend/app/routers/document_images.py"
      provides: "Document image upload endpoint"
      contains: "upload_document_image"
    - path: "electron-app/src/renderer/components/knowledge/image-upload.ts"
      provides: "Upload helper function for document images"
      exports: ["uploadDocumentImage"]
    - path: "electron-app/src/renderer/components/knowledge/editor-extensions.ts"
      provides: "FileHandler extension configured for image paste/drop"
      contains: "FileHandler"
  key_links:
    - from: "electron-app/src/renderer/components/knowledge/editor-extensions.ts"
      to: "electron-app/src/renderer/components/knowledge/image-upload.ts"
      via: "FileHandler onPaste/onDrop calls uploadDocumentImage"
      pattern: "uploadDocumentImage"
    - from: "electron-app/src/renderer/components/knowledge/image-upload.ts"
      to: "fastapi-backend/app/routers/document_images.py"
      via: "POST /api/documents/images/upload"
      pattern: "documents/images/upload"
    - from: "fastapi-backend/app/routers/document_images.py"
      to: "fastapi-backend/app/services/minio_service.py"
      via: "MinIOService.upload_bytes and get_presigned_download_url"
      pattern: "minio\\.upload_bytes"
---

<objective>
Create the backend image upload endpoint and wire TipTap's FileHandler extension to support image paste, drag-and-drop, and toolbar upload button.

Purpose: Enable users to insert images into documents via any method (paste, drop, upload button) with images stored in MinIO and referenced by URL in the document JSON.
Output: Working image insertion flow from editor to MinIO storage, plus content converter support for image nodes.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-images-in-editor/07-RESEARCH.md

Key codebase files:
@fastapi-backend/app/services/minio_service.py — Existing MinIO service with upload_bytes, generate_object_name, get_presigned_download_url, IMAGES_BUCKET
@fastapi-backend/app/routers/files.py — Existing file upload pattern (read for upload_file endpoint structure, content validation, MinIO integration)
@fastapi-backend/app/routers/__init__.py — Router registration barrel file
@fastapi-backend/app/main.py — App startup with include_router calls
@fastapi-backend/app/services/content_converter.py — TipTap JSON to Markdown/plain text converter (needs image node handling)
@electron-app/src/renderer/components/knowledge/editor-extensions.ts — Extension factory (add FileHandler + Image here)
@electron-app/src/renderer/components/knowledge/editor-toolbar.tsx — Toolbar component (add image upload button)
@electron-app/src/renderer/components/knowledge/document-editor.tsx — DocumentEditor component (pass documentId prop for upload)
@electron-app/src/renderer/components/knowledge/editor-types.ts — Editor type definitions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend image upload endpoint and content converter update</name>
  <files>
    fastapi-backend/app/routers/document_images.py
    fastapi-backend/app/routers/__init__.py
    fastapi-backend/app/main.py
    fastapi-backend/app/services/content_converter.py
  </files>
  <action>
    1. Create `fastapi-backend/app/routers/document_images.py` with a single POST endpoint:

    ```python
    router = APIRouter(prefix="/documents/images", tags=["document-images"])

    ALLOWED_IMAGE_TYPES = {"image/jpeg", "image/png", "image/gif", "image/webp", "image/svg+xml"}
    MAX_IMAGE_SIZE = 10 * 1024 * 1024  # 10MB

    @router.post("/upload")
    async def upload_document_image(
        file: UploadFile = File(...),
        document_id: UUID = Query(..., description="Document this image belongs to"),
        current_user: User = Depends(get_current_user),
        minio: MinIOService = Depends(get_minio_service),
    ) -> dict:
    ```

    Implementation:
    - Validate `file.content_type` is in ALLOWED_IMAGE_TYPES, else raise HTTPException 400
    - Read content with `await file.read()`, check `len(content) > MAX_IMAGE_SIZE`, else raise HTTPException 413
    - Generate object_name: `minio.generate_object_name("document", str(document_id), file.filename or "image.png")`
    - Upload: `minio.upload_bytes(MinIOService.IMAGES_BUCKET, object_name, content, file.content_type)`
    - Generate presigned download URL with 7-day expiry: `minio.get_presigned_download_url(MinIOService.IMAGES_BUCKET, object_name, timedelta(days=7))`
    - Return: `{"url": download_url, "object_name": object_name, "file_name": file.filename, "file_size": len(content), "content_type": file.content_type}`
    - Wrap MinIO calls in try/except for MinIOServiceError -> HTTPException 500
    - Import pattern: follow existing files.py pattern (Annotated, Depends, File, HTTPException, Query, UploadFile, status)
    - Use `from ..services.auth_service import get_current_user` and `from ..services.minio_service import MinIOService, MinIOServiceError, get_minio_service`

    2. Register the router:
    - In `__init__.py`: add `from .document_images import router as document_images_router` and add to `__all__`
    - In `main.py`: add `document_images_router` to import and `app.include_router(document_images_router, prefix="/api", tags=["document-images"])`

    3. Update content converter to handle image nodes:
    - In `content_converter.py`, add handling for the `"image"` node type in the Markdown converter:
      - Extract `src` and `alt` from `node.get("attrs", {})`, default alt to empty string
      - Output: `![{alt}]({src})`
    - In the plain text converter, output `[Image: {alt}]` or `[Image]` if no alt
    - This is a small addition to the existing node-type dispatch (look for how other block nodes like `horizontalRule` are handled)
  </action>
  <verify>
    - `cd fastapi-backend && python -c "from app.routers.document_images import router; print('Router imported successfully')"` succeeds
    - `cd fastapi-backend && python -c "from app.routers import document_images_router; print('Barrel import OK')"` succeeds
    - `cd fastapi-backend && python -m pytest tests/ -v -k "content_convert" --no-header 2>&1 | tail -5` — existing converter tests still pass
    - `cd fastapi-backend && ruff check app/routers/document_images.py app/services/content_converter.py` passes
  </verify>
  <done>
    - POST /api/documents/images/upload endpoint exists and validates image type + size
    - Router is registered in main.py
    - Content converter handles image nodes in both Markdown and plain text output
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend FileHandler extension, upload helper, and toolbar button</name>
  <files>
    electron-app/src/renderer/components/knowledge/image-upload.ts
    electron-app/src/renderer/components/knowledge/editor-extensions.ts
    electron-app/src/renderer/components/knowledge/editor-toolbar.tsx
    electron-app/src/renderer/components/knowledge/document-editor.tsx
    electron-app/src/renderer/components/knowledge/editor-types.ts
  </files>
  <action>
    First, install @tiptap/extension-file-handler:
    ```bash
    cd electron-app && npm install @tiptap/extension-file-handler
    ```

    1. Create `image-upload.ts`:
    ```typescript
    /**
     * Document image upload helper.
     * Uploads an image file to the backend and returns the permanent URL.
     */

    export async function uploadDocumentImage(
      file: File,
      documentId: string,
    ): Promise<{ url: string; objectName: string }> {
      const token = localStorage.getItem('auth_token')
      if (!token) throw new Error('Not authenticated')

      const formData = new FormData()
      formData.append('file', file)

      const response = await window.electronAPI.uploadFile<{
        url: string
        object_name: string
        file_name: string
        file_size: number
        content_type: string
      }>(`/documents/images/upload?document_id=${documentId}`, formData)

      return { url: response.url, objectName: response.object_name }
    }
    ```

    IMPORTANT: Check how `window.electronAPI` handles file uploads by looking at existing upload code in the codebase (e.g., task attachment uploads). If `window.electronAPI` does not have an `uploadFile` method, use a direct `fetch` call instead:
    ```typescript
    const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:8001'
    const response = await fetch(`${apiUrl}/api/documents/images/upload?document_id=${documentId}`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${token}` },
      body: formData,
    })
    if (!response.ok) throw new Error(`Upload failed: ${response.status}`)
    const data = await response.json()
    return { url: data.url, objectName: data.object_name }
    ```

    2. Update `editor-extensions.ts`:
    - Add imports: `import Image from '@tiptap/extension-image'` and `import { FileHandler } from '@tiptap/extension-file-handler'`
    - Update `createDocumentExtensions` signature to accept `documentId?: string` in the options
    - Import `uploadDocumentImage` from `./image-upload`
    - Create a helper function `createImageInsertHandler(editor, documentId)` that:
      - Takes files array, filters for image/* MIME types
      - For each file: creates temp URL via `URL.createObjectURL(file)`, inserts image node at position with `data-loading: 'true'` attr, uploads via `uploadDocumentImage`, then uses a transaction to find and replace the temp src with permanent URL and remove data-loading attr. Revoke temp URL in finally block.
    - Add `Image.configure({ inline: false, allowBase64: false })` to the extensions array
    - Add `FileHandler.configure({ allowedMimeTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'], onPaste: (editor, files, htmlContent) => { if (htmlContent) return false; /* call insert handler */ }, onDrop: (editor, files, pos) => { /* call insert handler at pos */ } })` to the extensions array
    - NOTE: FileHandler's onPaste must return false when htmlContent contains images to prevent duplicate insertion (see research pitfall #1)

    3. Update `editor-types.ts`:
    - Add `documentId?: string` to `DocumentEditorProps` interface

    4. Update `document-editor.tsx`:
    - Accept `documentId` prop and pass it through to `createDocumentExtensions({ placeholder, documentId })`

    5. Update `editor-toolbar.tsx`:
    - Add an image upload button (use `ImagePlus` or `Image` icon from lucide-react) after the existing toolbar sections
    - The button should trigger a hidden `<input type="file" accept="image/*">` that on change calls the same upload + insert flow
    - Place it in a new toolbar section with separator
    - The button needs access to the editor instance (already available via props) and the documentId (pass via new prop or use a ref)
    - Add `documentId` prop to the toolbar props type
  </action>
  <verify>
    - `cd electron-app && npx tsc --noEmit` — TypeScript compilation succeeds
    - `cd electron-app && node -e "require('./node_modules/@tiptap/extension-file-handler/dist/index.cjs')" 2>&1` — package installed correctly
    - Manually verify: open the editor, the toolbar shows an image upload button
  </verify>
  <done>
    - @tiptap/extension-file-handler is installed
    - FileHandler extension is configured in createDocumentExtensions with paste and drop handlers
    - Image extension is registered (inline: false, allowBase64: false)
    - Upload helper sends images to backend and returns permanent URL
    - Toolbar has an image upload button that opens a file picker
    - Pasting an image from clipboard triggers upload and insertion
    - Dropping an image file triggers upload and insertion at drop position
  </done>
</task>

</tasks>

<verification>
1. Backend: `cd fastapi-backend && ruff check .` passes
2. Frontend: `cd electron-app && npx tsc --noEmit` passes
3. Image upload endpoint importable and registered
4. Content converter tests still pass
5. Editor toolbar renders image button without errors
</verification>

<success_criteria>
- Image upload endpoint exists at POST /api/documents/images/upload
- Images are validated (type + size) and stored in MinIO pm-images bucket
- Pasting an image inserts it in the editor (via FileHandler)
- Dropping an image inserts it at the drop position
- Toolbar button opens file picker and inserts selected image
- Content converter outputs ![alt](src) for image nodes in Markdown
</success_criteria>

<output>
After completion, create `.planning/phases/07-images-in-editor/07-01-SUMMARY.md`
</output>
