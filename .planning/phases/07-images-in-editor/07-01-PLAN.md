---
phase: 07-images-in-editor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fastapi-backend/app/schemas/file.py
  - fastapi-backend/app/services/content_converter.py
  - fastapi-backend/tests/test_content_converter.py
  - electron-app/src/renderer/components/knowledge/editor-extensions.ts
  - electron-app/src/renderer/components/knowledge/ResizableImageView.tsx
  - electron-app/src/renderer/components/knowledge/use-image-upload.ts
autonomous: true

must_haves:
  truths:
    - "Image nodes in TipTap JSON convert to Markdown ![alt](url) syntax"
    - "Image nodes in TipTap JSON extract alt text for plain text output"
    - "ResizableImage extension is registered in createDocumentExtensions() with width attribute and ReactNodeViewRenderer"
    - "useImageUpload hook uploads files to MinIO via POST /api/files/upload and returns presigned download URL"
    - "EntityType enum includes 'document' for image uploads scoped to documents"
  artifacts:
    - path: "fastapi-backend/app/schemas/file.py"
      provides: "EntityType.DOCUMENT enum value"
      contains: "DOCUMENT"
    - path: "fastapi-backend/app/services/content_converter.py"
      provides: "Image node handlers for Markdown and plain text"
      contains: "image"
    - path: "fastapi-backend/tests/test_content_converter.py"
      provides: "Test cases for image node conversion"
      contains: "image"
    - path: "electron-app/src/renderer/components/knowledge/editor-extensions.ts"
      provides: "ResizableImage extension in factory"
      contains: "ResizableImage"
    - path: "electron-app/src/renderer/components/knowledge/ResizableImageView.tsx"
      provides: "React NodeView with resize handle"
      contains: "ResizableImageView"
    - path: "electron-app/src/renderer/components/knowledge/use-image-upload.ts"
      provides: "Upload hook for document images"
      contains: "useImageUpload"
  key_links:
    - from: "editor-extensions.ts"
      to: "ResizableImageView.tsx"
      via: "ReactNodeViewRenderer import"
      pattern: "ReactNodeViewRenderer.*ResizableImageView"
    - from: "content_converter.py"
      to: "test_content_converter.py"
      via: "pytest test coverage"
      pattern: "image"
---

<objective>
Build the image foundation: backend content converter image handlers, ResizableImage TipTap extension with React NodeView for resize handles, and useImageUpload hook for MinIO uploads.

Purpose: Provides all building blocks needed for Plan 07-02 to wire image paste/drop/upload into the editor UI.
Output: Backend image support (EntityType, converter), frontend extension + upload hook, ResizableImageView component.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-images-in-editor/07-RESEARCH.md

@electron-app/src/renderer/components/knowledge/editor-extensions.ts
@fastapi-backend/app/services/content_converter.py
@fastapi-backend/tests/test_content_converter.py
@fastapi-backend/app/schemas/file.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend -- EntityType enum + content converter image handlers + tests</name>
  <files>
    fastapi-backend/app/schemas/file.py
    fastapi-backend/app/services/content_converter.py
    fastapi-backend/tests/test_content_converter.py
  </files>
  <action>
**1. Add DOCUMENT to EntityType enum** in `file.py`:
```python
class EntityType(str, Enum):
    TASK = "task"
    COMMENT = "comment"
    DOCUMENT = "document"  # ADD THIS
```

**2. Add image node handler to `_md_nodes()`** in `content_converter.py`, before the `else` clause:
```python
elif t == "image":
    attrs = node.get("attrs", {})
    src = attrs.get("src", "")
    alt = attrs.get("alt", "")
    title = attrs.get("title", "")
    if title:
        parts.append(f'![{alt}]({src} "{title}")\n\n')
    else:
        parts.append(f"![{alt}]({src})\n\n")
```

**3. Add image node handler to `_extract_text_from_nodes()`** in `content_converter.py`, before the `elif "content" in node:` clause:
```python
elif node.get("type") == "image":
    alt = node.get("attrs", {}).get("alt", "")
    if alt:
        parts.append(f"[Image: {alt}]")
```

**4. Update module docstring** to include `image` in the node types list.

**5. Add test cases** to `test_content_converter.py`:
- Add helper: `def image(src, alt="", title="") -> dict`
- Test: image with alt text -> `![alt](url)\n\n` in Markdown
- Test: image with alt + title -> `![alt](url "title")\n\n` in Markdown
- Test: image with no alt -> `![](url)\n\n` in Markdown
- Test: image plain text extraction with alt -> `[Image: alt]`
- Test: image plain text extraction without alt -> empty string (no output)
- Test: image between paragraphs (integration test)
  </action>
  <verify>
Run `cd D:/FTX_CODE/pm-project/fastapi-backend && python -m pytest tests/test_content_converter.py -v` -- all tests pass including new image tests.
  </verify>
  <done>
EntityType.DOCUMENT exists. Image nodes convert to `![alt](url)` in Markdown and `[Image: alt]` in plain text. All existing + new tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend -- ResizableImage extension, NodeView component, and useImageUpload hook</name>
  <files>
    electron-app/src/renderer/components/knowledge/ResizableImageView.tsx
    electron-app/src/renderer/components/knowledge/use-image-upload.ts
    electron-app/src/renderer/components/knowledge/editor-extensions.ts
  </files>
  <action>
**1. Create `ResizableImageView.tsx`** -- React NodeView component for image nodes with SE corner resize handle. Port from `RichTextEditor.tsx` lines 147-201 as documented in 07-RESEARCH.md:

```typescript
import { useCallback, useRef, useState } from 'react'
import { NodeViewWrapper, type NodeViewProps } from '@tiptap/react'
import { cn } from '@/lib/utils'

export function ResizableImageView({ node, updateAttributes, selected }: NodeViewProps) {
  const [isResizing, setIsResizing] = useState(false)
  const imageRef = useRef<HTMLImageElement>(null)
  const startXRef = useRef(0)
  const startWidthRef = useRef(0)

  const handleMouseDown = useCallback((e: React.MouseEvent) => {
    e.preventDefault()
    e.stopPropagation()
    setIsResizing(true)
    startXRef.current = e.clientX
    startWidthRef.current = imageRef.current?.offsetWidth || 0

    const handleMouseMove = (moveEvent: MouseEvent) => {
      const diff = moveEvent.clientX - startXRef.current
      const newWidth = Math.max(50, startWidthRef.current + diff)
      updateAttributes({ width: newWidth })
    }

    const handleMouseUp = () => {
      setIsResizing(false)
      document.removeEventListener('mousemove', handleMouseMove)
      document.removeEventListener('mouseup', handleMouseUp)
    }

    document.addEventListener('mousemove', handleMouseMove)
    document.addEventListener('mouseup', handleMouseUp)
  }, [updateAttributes])

  return (
    <NodeViewWrapper className="inline-block relative" data-drag-handle>
      <div className={cn(
        'inline-block relative group',
        selected && 'ring-2 ring-primary/50 rounded'
      )}>
        <img
          ref={imageRef}
          src={node.attrs.src}
          alt={node.attrs.alt || ''}
          title={node.attrs.title || ''}
          width={node.attrs.width || undefined}
          className="max-w-full h-auto rounded-md block"
          style={node.attrs.width ? { width: `${node.attrs.width}px` } : undefined}
          draggable={false}
        />
        <div
          onMouseDown={handleMouseDown}
          className={cn(
            'absolute bottom-0 right-0 w-4 h-4 cursor-se-resize',
            'bg-primary/60 rounded-tl-sm opacity-0 group-hover:opacity-100 transition-opacity',
            isResizing && 'opacity-100'
          )}
          title="Drag to resize"
        />
      </div>
    </NodeViewWrapper>
  )
}
```

Key details:
- Single SE corner resize handle with mouse drag
- Min width: 50px (prevents collapse)
- Selection ring when node is selected
- `data-drag-handle` on wrapper for ProseMirror DnD
- `draggable={false}` on img to prevent browser's native image drag

**2. Create `use-image-upload.ts`** -- hook encapsulating the upload flow:
- Accept `documentId: string | null` parameter
- Use `useAuthStore` from `@/contexts/auth-context` for token (same pattern as `use-attachments.ts`)
- 10MB max image size (larger than task descriptions' 5MB, per research recommendation)
- Upload via `POST /api/files/upload` with `entity_type=document` and `entity_id={documentId}` query params
- Fetch presigned download URL via `GET /api/files/{attachment.id}`
- Return `{ uploadImage: (file: File) => Promise<string | null> }`
- Return `null` (not throw) on size limit exceeded or missing token

**3. Update `editor-extensions.ts`** -- add ResizableImage to factory:
- Import `Image` from `@tiptap/extension-image`
- Import `{ ReactNodeViewRenderer }` from `@tiptap/react`
- Import `{ ResizableImageView }` from `./ResizableImageView`
- Create `ResizableImage` by extending Image:
  ```typescript
  const ResizableImage = Image.extend({
    addAttributes() {
      return {
        ...this.parent?.(),
        width: {
          default: null,
          parseHTML: element => {
            const width = element.getAttribute('width') || element.style.width
            return width ? parseInt(String(width), 10) : null
          },
          renderHTML: attributes => {
            if (!attributes.width) return {}
            return { width: attributes.width, style: `width: ${attributes.width}px` }
          },
        },
      }
    },
    addNodeView() {
      return ReactNodeViewRenderer(ResizableImageView)
    },
  })
  ```
- Add `ResizableImage` to the extensions array returned by `createDocumentExtensions()`, after `Placeholder` (last entry).
- Do NOT add the base `Image` extension -- `ResizableImage` extends it and registers the image node type.
  </action>
  <verify>
Run `cd D:/FTX_CODE/pm-project/electron-app && npx tsc --noEmit` -- typecheck passes with no new errors.
  </verify>
  <done>
ResizableImageView.tsx exists with resize handle. useImageUpload hook uploads to MinIO and returns presigned URL. ResizableImage extension registered in createDocumentExtensions(). Typecheck passes.
  </done>
</task>

</tasks>

<verification>
1. `cd D:/FTX_CODE/pm-project/fastapi-backend && python -m pytest tests/test_content_converter.py -v` -- all tests pass
2. `cd D:/FTX_CODE/pm-project/electron-app && npx tsc --noEmit` -- no type errors
3. Grep `ResizableImage` in editor-extensions.ts confirms registration
4. Grep `DOCUMENT` in file.py confirms EntityType addition
</verification>

<success_criteria>
- EntityType.DOCUMENT exists in file.py
- Content converter handles image nodes (Markdown + plain text) with passing tests
- ResizableImageView.tsx exists with resize drag handle
- useImageUpload.ts exports hook that uploads to MinIO
- ResizableImage registered in createDocumentExtensions() array
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-images-in-editor/07-01-SUMMARY.md`
</output>
