---
phase: 02.1-onenote-knowledge-tree-redesign
plan: 05
type: execute
wave: 4
depends_on: ["02.1-04"]
files_modified:
  - electron-app/src/renderer/components/knowledge/knowledge-panel.tsx
  - electron-app/src/renderer/pages/applications/[id].tsx
  - electron-app/src/renderer/pages/projects/[id].tsx
autonomous: false

must_haves:
  truths:
    - "Application detail page has a 'Knowledge' tab that shows the same tree as the app tab in Notes"
    - "Project detail page has a 'Knowledge' tab showing only that project's docs"
    - "Clicking a document in a detail page Knowledge tab opens the editor inline"
    - "Full CRUD works in embedded Knowledge tabs (create, rename, delete folders and docs)"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/knowledge-panel.tsx"
      provides: "Reusable KnowledgePanel with tree + inline editor"
      exports: ["KnowledgePanel"]
    - path: "electron-app/src/renderer/pages/applications/[id].tsx"
      provides: "Knowledge tab in application detail page"
      contains: "Knowledge"
    - path: "electron-app/src/renderer/pages/projects/[id].tsx"
      provides: "Knowledge tab in project detail page"
      contains: "Knowledge"
  key_links:
    - from: "knowledge-panel.tsx"
      to: "knowledge-base-context.tsx"
      via: "KnowledgeBaseProvider with fixed scope and storagePrefix"
      pattern: "KnowledgeBaseProvider"
    - from: "applications/[id].tsx"
      to: "knowledge-panel.tsx"
      via: "renders KnowledgePanel in Knowledge tab content"
      pattern: "KnowledgePanel"
    - from: "projects/[id].tsx"
      to: "knowledge-panel.tsx"
      via: "renders KnowledgePanel in Knowledge tab content"
      pattern: "KnowledgePanel"
---

<objective>
Create the reusable KnowledgePanel component (tree + inline editor) and embed it as a "Knowledge" tab in both the Application and Project detail pages.

Purpose: This completes the EMBED-01 and EMBED-02 requirements from CONTEXT.md. Users can access and edit documents directly within detail pages without navigating to the Notes screen.
Output: KnowledgePanel component, Knowledge tabs in both detail pages.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-CONTEXT.md
@.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-RESEARCH.md
@.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-04-SUMMARY.md
@electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
@electron-app/src/renderer/components/knowledge/folder-tree.tsx
@electron-app/src/renderer/components/knowledge/application-tree.tsx
@electron-app/src/renderer/components/knowledge/document-editor.tsx
@electron-app/src/renderer/contexts/knowledge-base-context.tsx
@electron-app/src/renderer/pages/applications/[id].tsx
@electron-app/src/renderer/pages/projects/[id].tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: KnowledgePanel reusable component</name>
  <files>
    electron-app/src/renderer/components/knowledge/knowledge-panel.tsx
  </files>
  <action>
    Create `knowledge-panel.tsx` — a composable panel that renders tree (left) + editor (right) in a two-panel layout:

    ```typescript
    interface KnowledgePanelProps {
      /** The scope type for this panel */
      scope: 'personal' | 'application' | 'project'
      /** The scope ID (userId, applicationId, or projectId) */
      scopeId: string
      /** Whether to show project folder sections (true for application scope) */
      showProjectFolders?: boolean
      /** Optional className for the outer container */
      className?: string
    }
    ```

    Implementation:

    1. Wrap everything in a `KnowledgeBaseProvider` with:
       - `initialScope={scope}`
       - `initialScopeId={scopeId}`
       - `storagePrefix={`kb-${scope}-${scopeId}-`}` (namespaced to avoid conflicts — Pitfall 1 from research)
    2. Inner layout: `flex h-full` container
       - Left panel (w-64, border-r): SearchBar at top, then tree in ScrollArea, tag filter at bottom
       - Right panel (flex-1): DocumentEditor for selected document, or empty state placeholder
    3. The tree depends on scope:
       - If `scope === 'application' && showProjectFolders`: render `ApplicationTree applicationId={scopeId}`
       - If `scope === 'project'`: render `FolderTree` (which reads scope from context = 'project')
       - If `scope === 'personal'`: render `FolderTree` (scope from context = 'personal')
    4. The editor section reads `selectedDocumentId` from `useKnowledgeBase()`:
       - If selectedDocumentId: render `DocumentEditor documentId={selectedDocumentId}`
       - Otherwise: render empty state ("Select a document to start editing" with FileText icon)
    5. Include the '+' creation button at the top of the tree panel (same pattern as the sidebar)

    This component is the single reusable unit used in:
    - Application detail Knowledge tab (scope='application', showProjectFolders=true)
    - Project detail Knowledge tab (scope='project')
    - Could also be used for personal notes in the future

    IMPORTANT: The KnowledgeBaseProvider creates a SEPARATE context instance for each embedding. This means the Notes page's context and the detail page's context are independent (no state leaking). The `storagePrefix` ensures localStorage keys don't conflict.
  </action>
  <verify>
    1. `cd electron-app && npx tsc --noEmit --pretty 2>&1 | head -30` — zero errors
    2. `grep -n "export.*KnowledgePanel" electron-app/src/renderer/components/knowledge/knowledge-panel.tsx` — exported
  </verify>
  <done>
    KnowledgePanel component renders tree + inline editor in a two-panel layout. Wraps in its own KnowledgeBaseProvider with storagePrefix. Supports application, project, and personal scopes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Knowledge tab to Application and Project detail pages</name>
  <files>
    electron-app/src/renderer/pages/applications/[id].tsx
    electron-app/src/renderer/pages/projects/[id].tsx
  </files>
  <action>
    **Application detail page ([id].tsx):**

    The page currently has a tab bar with "Projects" and "Archive" tabs (lines 862-897). Add a third "Knowledge" tab:

    1. Add state for the active tab (if not already managed — currently the page uses `showArchive` boolean). Refactor to use a string state:
       ```typescript
       const [activeView, setActiveView] = useState<'projects' | 'archive' | 'knowledge'>('projects')
       ```
    2. Replace the existing `showArchive` logic with `activeView`:
       - `showArchive` → `activeView === 'archive'`
       - The existing toggle buttons become three tabs
    3. Add a "Knowledge" tab button between "Archive" and the end of the tab bar:
       ```tsx
       <button
         onClick={() => setActiveView('knowledge')}
         className={cn(
           'relative flex items-center gap-1.5 px-3 py-2 text-xs font-medium transition-colors',
           activeView === 'knowledge'
             ? 'text-foreground'
             : 'text-muted-foreground hover:text-foreground'
         )}
       >
         <FileText className="h-3 w-3" />
         Knowledge
         {activeView === 'knowledge' && (
           <span className="absolute bottom-0 left-0 right-0 h-0.5 bg-primary" />
         )}
       </button>
       ```
    4. Add the Knowledge tab content (alongside existing Projects and Archive content):
       ```tsx
       {activeView === 'knowledge' && (
         <div className="flex-1 min-h-0">
           <KnowledgePanel
             scope="application"
             scopeId={applicationId}
             showProjectFolders
             className="h-full"
           />
         </div>
       )}
       ```
    5. Import `KnowledgePanel` and `FileText` icon.

    **Project detail page ([id].tsx):**

    The project page currently doesn't have sub-tabs (it's all kanban board). Add a tab bar at the top of the board section:

    1. Add state: `const [activeView, setActiveView] = useState<'board' | 'knowledge'>('board')`
    2. Add a small tab bar above the board content (between the header and the KanbanBoard):
       ```tsx
       <div className="flex items-center gap-1 border-b border-border mb-2">
         <button
           onClick={() => setActiveView('board')}
           className={cn(
             'relative px-3 py-1.5 text-xs font-medium transition-colors',
             activeView === 'board'
               ? 'text-foreground'
               : 'text-muted-foreground hover:text-foreground'
           )}
         >
           Board
           {activeView === 'board' && (
             <span className="absolute bottom-0 left-0 right-0 h-0.5 bg-primary" />
           )}
         </button>
         <button
           onClick={() => setActiveView('knowledge')}
           className={cn(
             'relative flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium transition-colors',
             activeView === 'knowledge'
               ? 'text-foreground'
               : 'text-muted-foreground hover:text-foreground'
           )}
         >
           <FileText className="h-3 w-3" />
           Knowledge
           {activeView === 'knowledge' && (
             <span className="absolute bottom-0 left-0 right-0 h-0.5 bg-primary" />
           )}
         </button>
       </div>
       ```
    3. Conditionally render board vs knowledge content:
       ```tsx
       {activeView === 'board' ? (
         <KanbanBoard ... />  {/* existing */}
       ) : (
         <KnowledgePanel
           scope="project"
           scopeId={projectId}
           className="h-full"
         />
       )}
       ```
    4. Import `KnowledgePanel` and `FileText` icon.

    IMPORTANT: When refactoring the Application page from `showArchive` boolean to `activeView` string, make sure ALL conditional rendering is updated:
    - Line 900: `{!showArchive ? (` → `{activeView === 'projects' ? (`
    - Line 1059: `showArchive` in the ternary → `activeView === 'archive'`
    - All `setShowArchive(true/false)` calls → `setActiveView('archive'/'projects')`
  </action>
  <verify>
    1. `cd electron-app && npx tsc --noEmit --pretty 2>&1 | head -30` — zero errors
    2. `grep -n "Knowledge" electron-app/src/renderer/pages/applications/\\[id\\].tsx` — tab and panel references found
    3. `grep -n "Knowledge" electron-app/src/renderer/pages/projects/\\[id\\].tsx` — tab and panel references found
  </verify>
  <done>
    Application detail page has Projects / Archive / Knowledge tabs with KnowledgePanel embedded. Project detail page has Board / Knowledge tabs with KnowledgePanel embedded. Both pages compile without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete OneNote-style Knowledge Tree Redesign (Phase 2.1):
    - Horizontal tabs on Notes page (My Notes + application tabs)
    - OneNote-style tree items (no chevrons, lock indicators)
    - Application tabs show mixed app-scoped + project-scoped tree
    - Knowledge tab embedded in Application detail page
    - Knowledge tab embedded in Project detail page
    - Inline editor in all three contexts
    - Old scope-filter and scope-picker removed
  </what-built>
  <how-to-verify>
    1. Start the backend: `cd fastapi-backend && uvicorn app.main:app --reload --port 8001`
    2. Start the frontend: `cd electron-app && npm run dev`
    3. Navigate to Notes page:
       a. Verify "My Notes" tab appears first
       b. Create a document — it should appear in My Notes tree
       c. If you have applications with existing docs, verify app tabs appear
       d. Verify tree items have no chevron arrows (click to expand)
       e. Verify '+' button at top of tree creates new document/folder
    4. Navigate to an Application detail page:
       a. Verify "Projects / Archive / Knowledge" tabs
       b. Click "Knowledge" tab
       c. Verify tree shows app-level docs + project folders
       d. Click a document — verify editor opens inline
       e. Create a new document — verify it appears in the tree
    5. Navigate to a Project detail page:
       a. Verify "Board / Knowledge" tabs
       b. Click "Knowledge" tab
       c. Verify tree shows only that project's docs
       d. Create and edit a document inline
    6. Verify search bar has global/scoped toggle button
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `cd electron-app && npx tsc --noEmit --pretty` — zero errors
2. KnowledgePanel component exists and is reusable
3. Application detail page has Knowledge tab with full CRUD
4. Project detail page has Knowledge tab with full CRUD
5. Inline editor works in both embedded Knowledge tabs
</verification>

<success_criteria>
- KnowledgePanel renders tree + editor, parameterized by scope
- Application detail page Knowledge tab shows identical tree to app tab in Notes
- Project detail page Knowledge tab shows only that project's docs
- Inline editor opens on document click in both detail pages
- Full CRUD (create, rename, delete) works in embedded Knowledge tabs
- Multiple KnowledgeBaseProvider instances don't share localStorage state
- Zero TypeScript compilation errors
- Human verifies the complete feature works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-05-SUMMARY.md`
</output>
