---
phase: 02.1-onenote-knowledge-tree-redesign
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
  - electron-app/src/renderer/components/knowledge/folder-tree.tsx
  - electron-app/src/renderer/components/knowledge/application-tree.tsx
  - electron-app/src/renderer/components/knowledge/knowledge-panel.tsx
  - electron-app/src/renderer/components/knowledge/create-dialog.tsx
  - electron-app/src/renderer/components/knowledge/delete-dialog.tsx
  - electron-app/src/renderer/components/ui/dialog.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Create document shows popup dialog to enter name"
    - "Create folder shows popup dialog to enter name"
    - "Delete shows confirmation popup before deleting"
    - "Quick create respects current selection (creates under selected folder)"
    - "Right-click 'New Folder' creates inside the clicked folder"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/create-dialog.tsx"
      provides: "Reusable create document/folder dialog with name input"
    - path: "electron-app/src/renderer/components/knowledge/delete-dialog.tsx"
      provides: "Reusable delete confirmation dialog"
  key_links:
    - from: "knowledge-sidebar.tsx"
      to: "CreateDialog"
      via: "Dialog state management"
      pattern: "showCreateDialog"
    - from: "folder-tree.tsx"
      to: "DeleteDialog"
      via: "Delete confirmation flow"
      pattern: "showDeleteDialog"
---

<objective>
Fix UX gaps: no popup dialogs for create/delete operations, quick create ignoring selection.

Purpose: Users need confirmation dialogs and name input for CRUD operations, and the quick create buttons should respect the current tree selection.

Output: Create/delete dialogs with proper UX and selection-aware quick create buttons.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
@electron-app/src/renderer/components/knowledge/folder-tree.tsx
@electron-app/src/renderer/components/knowledge/application-tree.tsx
@electron-app/src/renderer/components/knowledge/knowledge-panel.tsx
@electron-app/src/renderer/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable CreateDialog and DeleteDialog components</name>
  <files>electron-app/src/renderer/components/knowledge/create-dialog.tsx, electron-app/src/renderer/components/knowledge/delete-dialog.tsx</files>
  <action>
Create two dialog components using shadcn/ui Dialog pattern:

**CreateDialog** (create-dialog.tsx):
```tsx
import { useState } from 'react'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Button } from '@/components/ui/button'
import { Loader2 } from 'lucide-react'

export interface CreateDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  type: 'document' | 'folder'
  onSubmit: (name: string) => Promise<void>
}

export function CreateDialog({ open, onOpenChange, type, onSubmit }: CreateDialogProps) {
  const [name, setName] = useState(type === 'document' ? 'Untitled' : 'New Folder')
  const [isSubmitting, setIsSubmitting] = useState(false)

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!name.trim()) return
    setIsSubmitting(true)
    try {
      await onSubmit(name.trim())
      onOpenChange(false)
      setName(type === 'document' ? 'Untitled' : 'New Folder')
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[400px]">
        <form onSubmit={handleSubmit}>
          <DialogHeader>
            <DialogTitle>
              Create {type === 'document' ? 'Document' : 'Folder'}
            </DialogTitle>
            <DialogDescription>
              Enter a name for your new {type}.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <Label htmlFor="name">Name</Label>
            <Input
              id="name"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder={type === 'document' ? 'Document name' : 'Folder name'}
              autoFocus
              disabled={isSubmitting}
            />
          </div>
          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
              disabled={isSubmitting}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={isSubmitting || !name.trim()}>
              {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              {isSubmitting ? 'Creating...' : 'Create'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

**DeleteDialog** (delete-dialog.tsx):
```tsx
import { useState } from 'react'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog'
import { Loader2 } from 'lucide-react'

export interface DeleteDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  itemName: string
  itemType: 'document' | 'folder'
  onConfirm: () => Promise<void>
}

export function DeleteDialog({ open, onOpenChange, itemName, itemType, onConfirm }: DeleteDialogProps) {
  const [isDeleting, setIsDeleting] = useState(false)

  const handleConfirm = async () => {
    setIsDeleting(true)
    try {
      await onConfirm()
      onOpenChange(false)
    } finally {
      setIsDeleting(false)
    }
  }

  return (
    <AlertDialog open={open} onOpenChange={onOpenChange}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Delete {itemType}?</AlertDialogTitle>
          <AlertDialogDescription>
            Are you sure you want to delete "{itemName}"?
            {itemType === 'folder' && ' This will also delete all documents inside.'}
            This action cannot be undone.
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel disabled={isDeleting}>Cancel</AlertDialogCancel>
          <AlertDialogAction
            onClick={handleConfirm}
            disabled={isDeleting}
            className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
          >
            {isDeleting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            {isDeleting ? 'Deleting...' : 'Delete'}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  )
}
```

Note: May need to add AlertDialog components to ui/ if not present. Check if @/components/ui/alert-dialog exists, if not, install via shadcn CLI or create manually.
  </action>
  <verify>
Run `npm run typecheck` - zero errors.
Both files exist and export their components.
  </verify>
  <done>
CreateDialog and DeleteDialog components exist with proper UX (loading states, form validation).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate dialogs into KnowledgeSidebar quick create buttons</name>
  <files>electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx</files>
  <action>
Update the quick create buttons to:
1. Show CreateDialog instead of immediately creating
2. Respect the currently selected folder from context

Changes:
1. Import CreateDialog
2. Add state for dialog:
   ```tsx
   const [createDialogOpen, setCreateDialogOpen] = useState(false)
   const [createType, setCreateType] = useState<'document' | 'folder'>('document')
   ```

3. Get selectedFolderId from context:
   ```tsx
   const { ..., selectedFolderId } = useKnowledgeBase()
   ```

4. Update button handlers to open dialog:
   ```tsx
   const handleCreateDocClick = () => {
     setCreateType('document')
     setCreateDialogOpen(true)
   }

   const handleCreateFolderClick = () => {
     setCreateType('folder')
     setCreateDialogOpen(true)
   }
   ```

5. Add submit handler that uses selectedFolderId:
   ```tsx
   const handleCreateSubmit = async (name: string) => {
     const { scope, scopeId } = resolveScope()
     if (!scopeId) return

     if (createType === 'document') {
       await createDocument.mutateAsync({
         title: name,
         scope,
         scope_id: scopeId,
         folder_id: selectedFolderId || null, // Use selected folder!
       })
     } else {
       await createFolder.mutateAsync({
         name,
         scope,
         scope_id: scopeId,
         parent_id: selectedFolderId || null, // Create inside selected folder!
       })
     }
   }
   ```

6. Render CreateDialog:
   ```tsx
   <CreateDialog
     open={createDialogOpen}
     onOpenChange={setCreateDialogOpen}
     type={createType}
     onSubmit={handleCreateSubmit}
   />
   ```
  </action>
  <verify>
Run `npm run typecheck` - zero errors.
Grep for "CreateDialog" in knowledge-sidebar.tsx - should find import and usage.
Grep for "selectedFolderId" in knowledge-sidebar.tsx - should find usage in create handlers.
  </verify>
  <done>
Quick create buttons show dialog and respect selected folder for nested creation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate dialogs into FolderTree and ApplicationTree</name>
  <files>electron-app/src/renderer/components/knowledge/folder-tree.tsx, electron-app/src/renderer/components/knowledge/application-tree.tsx</files>
  <action>
Add CreateDialog for context menu "New Folder"/"New Document" actions and DeleteDialog for delete actions.

For BOTH files, make similar changes:

1. Import dialogs:
   ```tsx
   import { CreateDialog } from './create-dialog'
   import { DeleteDialog } from './delete-dialog'
   ```

2. Add state:
   ```tsx
   const [createDialogOpen, setCreateDialogOpen] = useState(false)
   const [createType, setCreateType] = useState<'document' | 'folder'>('document')
   const [createParentId, setCreateParentId] = useState<string | null>(null)

   const [deleteDialogOpen, setDeleteDialogOpen] = useState(false)
   const [deleteTarget, setDeleteTarget] = useState<{id: string; type: 'document' | 'folder'; name: string} | null>(null)
   ```

3. Update context menu handlers to open dialogs instead of immediate action:

   For handleNewFolder:
   ```tsx
   const handleNewFolder = useCallback((parentId: string) => {
     handleCloseContextMenu()
     setCreateType('folder')
     setCreateParentId(parentId)
     setCreateDialogOpen(true)
   }, [handleCloseContextMenu])
   ```

   For handleNewDocument:
   ```tsx
   const handleNewDocument = useCallback((folderId: string) => {
     handleCloseContextMenu()
     setCreateType('document')
     setCreateParentId(folderId)
     setCreateDialogOpen(true)
   }, [handleCloseContextMenu])
   ```

   For handleDelete:
   ```tsx
   const handleDelete = useCallback((id: string, type: 'folder' | 'document') => {
     handleCloseContextMenu()
     // Find the name from the tree data
     const name = type === 'folder'
       ? folders.find(f => f.id === id)?.name || 'this folder'
       : unfiledDocs.find(d => d.id === id)?.title || 'this document'
     setDeleteTarget({ id, type, name })
     setDeleteDialogOpen(true)
   }, [folders, unfiledDocs, handleCloseContextMenu])
   ```

4. Add submit handlers:
   ```tsx
   const handleCreateSubmit = async (name: string) => {
     const resolvedScopeId = scope === 'personal' ? (userId ?? '') : (scopeId ?? '')
     if (createType === 'document') {
       const doc = await createDocument.mutateAsync({
         title: name,
         scope,
         scope_id: resolvedScopeId,
         folder_id: createParentId,
       })
       selectDocument(doc.id)
       if (createParentId) expandFolder(createParentId)
     } else {
       const folder = await createFolder.mutateAsync({
         name,
         scope,
         scope_id: resolvedScopeId,
         parent_id: createParentId,
       })
       if (createParentId) expandFolder(createParentId)
     }
   }

   const handleDeleteConfirm = async () => {
     if (!deleteTarget) return
     if (deleteTarget.type === 'folder') {
       await deleteFolder.mutateAsync(deleteTarget.id)
       if (selectedFolderId === deleteTarget.id) selectFolder(null)
     } else {
       await deleteDocument.mutateAsync(deleteTarget.id)
       if (selectedDocumentId === deleteTarget.id) selectDocument(null)
     }
   }
   ```

5. Render dialogs at end of component:
   ```tsx
   <CreateDialog
     open={createDialogOpen}
     onOpenChange={setCreateDialogOpen}
     type={createType}
     onSubmit={handleCreateSubmit}
   />
   <DeleteDialog
     open={deleteDialogOpen}
     onOpenChange={setDeleteDialogOpen}
     itemName={deleteTarget?.name || ''}
     itemType={deleteTarget?.type || 'document'}
     onConfirm={handleDeleteConfirm}
   />
   ```

Do this for BOTH folder-tree.tsx and application-tree.tsx (ApplicationTree has slightly different scope handling - use the existing scope-aware patterns).
  </action>
  <verify>
Run `npm run typecheck` - zero errors.
Grep for "CreateDialog" in folder-tree.tsx and application-tree.tsx - should find in both.
Grep for "DeleteDialog" in both files - should find in both.
  </verify>
  <done>
Context menu actions show confirmation/input dialogs with proper UX before executing.
  </done>
</task>

</tasks>

<verification>
1. `cd electron-app && npm run typecheck` passes
2. CreateDialog and DeleteDialog components exist
3. All tree components (sidebar, folder-tree, application-tree) use dialogs
4. Quick create respects selectedFolderId from context
</verification>

<success_criteria>
- Clicking create document button shows dialog to enter name
- Clicking create folder button shows dialog to enter name
- Right-click "New Folder" on a folder opens dialog, creates inside that folder
- Delete shows confirmation dialog with item name before proceeding
- Dialog shows loading state during operation
- Quick create creates under selected folder when one is selected
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-08-SUMMARY.md`
</output>
