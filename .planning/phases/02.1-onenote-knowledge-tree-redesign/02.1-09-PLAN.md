---
phase: 02.1-onenote-knowledge-tree-redesign
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - electron-app/src/renderer/components/knowledge/folder-tree.tsx
  - electron-app/src/renderer/components/knowledge/application-tree.tsx
  - electron-app/src/renderer/components/knowledge/folder-context-menu.tsx
  - electron-app/src/renderer/hooks/use-document-folders.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Folders can be nested inside other folders (not just at root)"
    - "Right-click context menu creates inside the target folder"
    - "Nested folders appear correctly in tree hierarchy"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/folder-tree.tsx"
      provides: "Tree with proper folder nesting support"
  key_links:
    - from: "folder-tree.tsx"
      to: "handleNewFolder"
      via: "Context menu callback"
      pattern: "onNewFolder.*parentId"
---

<objective>
Fix folder nesting: users cannot nest folders inside other folders (only root level creation works).

Purpose: Users need unlimited folder nesting within any scope, matching the CONTEXT.md decision for "unlimited nesting".

Output: Folders can be created inside other folders at any depth via context menu.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-CONTEXT.md
@electron-app/src/renderer/components/knowledge/folder-tree.tsx
@electron-app/src/renderer/components/knowledge/folder-context-menu.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and fix context menu parent_id passing</name>
  <files>electron-app/src/renderer/components/knowledge/folder-context-menu.tsx, electron-app/src/renderer/components/knowledge/folder-tree.tsx</files>
  <action>
The root cause is likely that when "New Folder" is clicked in the context menu, the parent_id being passed is the folder's own ID (correct for creating INSIDE it), but somewhere in the chain it's being ignored or set to null.

Investigation:
1. Check FolderContextMenu - it calls `onNewFolder(target.id)` when target is a folder
   - This is CORRECT - target.id should be the parent for the new folder

2. Check folder-tree.tsx handleNewFolder:
   - The parentId parameter should be passed directly to createFolder.mutate
   - Verify it's not being overwritten to null

Current code in handleNewFolder:
```tsx
const handleNewFolder = useCallback(
  (parentId: string) => {
    handleCloseContextMenu()
    const resolvedScopeId = scopeId ?? ''
    createFolder.mutate(
      {
        name: 'New Folder',
        parent_id: parentId,  // <-- This should be the folder ID, not null
        scope,
        scope_id: resolvedScopeId,
      },
      ...
    )
  },
  [scope, scopeId, createFolder, expandFolder, handleCloseContextMenu]
)
```

If the code looks correct, the issue might be:
a) The API is ignoring parent_id
b) The tree rendering isn't showing nested folders properly
c) The handleNewFolder is receiving empty string instead of parent ID

Add logging temporarily to verify the parentId value:
```tsx
console.log('Creating folder with parent_id:', parentId)
```

If parentId IS being passed correctly, check:
- The backend API (might need to verify parent_id is saved)
- The useFolderTree query response structure (children array handling)
- The tree rendering recursion (renderFolderNode should handle children)

The renderFolderNode already recursively renders children:
```tsx
{isExpanded && node.children.map((child) => renderFolderNode(child, depth + 1))}
```

This suggests the issue is either:
1. The API isn't saving parent_id
2. The API isn't returning children in the tree response
3. The handleNewFolder isn't being called with correct parentId

Fix: Ensure the entire flow passes parentId correctly:
- Context menu target.id -> onNewFolder(target.id) -> handleNewFolder(parentId) -> createFolder.mutate({ parent_id: parentId })
  </action>
  <verify>
Grep for "parent_id" in folder-tree.tsx - should find it in createFolder.mutate call.
Grep for "handleNewFolder" - should find it passing parentId to mutation.
  </verify>
  <done>
Context menu "New Folder" action correctly passes parent folder ID to create mutation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure ApplicationTree has proper nested folder support</name>
  <files>electron-app/src/renderer/components/knowledge/application-tree.tsx</files>
  <action>
ApplicationTree has similar nested folder handling. Verify:

1. The handleNewFolder callback uses contextMenuTarget to get the correct parent:
   ```tsx
   const handleNewFolder = useCallback(
     (parentId: string) => {
       handleCloseContextMenu()
       const target = contextMenuTarget
       const scope = target?.scope ?? 'application'
       const scopeId = target?.scopeId ?? applicationId

       createFolder.mutate(
         {
           name: 'New Folder',
           parent_id: parentId,  // <-- Should be the target folder ID
           scope,
           scope_id: scopeId,
         },
         ...
       )
     },
     [contextMenuTarget, applicationId, createFolder, expandFolder, handleCloseContextMenu]
   )
   ```

2. The ProjectSection's nested folder rendering handles children:
   ```tsx
   const renderFolderNode = useCallback(
     (node: FolderTreeNode, depth: number): JSX.Element => {
       ...
       {nodeExpanded && node.children.map((child) => renderFolderNode(child, depth + 1))}
     },
     ...
   )
   ```

3. The context menu is passing the correct ID:
   - For app-level items: `onContextMenu(e, node.id, 'folder', node.name, 'application', applicationId)`
   - For project items: `onContextMenu(e, node.id, 'folder', node.name, 'project', project.id)`

4. Verify FolderContextMenu calls `onNewFolder(target.id)` where target.id is the folder we right-clicked on.

If all looks correct, the issue might be at the API level or the create mutation hook. Check if parent_id is being included in the POST request body.
  </action>
  <verify>
Grep for "parent_id" in application-tree.tsx - should find in createFolder.mutate.
Code review confirms parent_id flow is intact.
  </verify>
  <done>
ApplicationTree properly supports nested folder creation via context menu.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify frontend mutation includes parent_id in POST body</name>
  <files>electron-app/src/renderer/hooks/use-document-folders.ts</files>
  <action>
**Note: This task is VERIFICATION ONLY - read and verify existing code, do not modify backend files.**

If the frontend is passing parent_id correctly but nesting still doesn't work, the issue might be in the frontend mutation hook.

Verify the frontend hook (use-document-folders.ts):
- useCreateFolder mutation should include parent_id in the POST body
- Verify the mutation payload matches the schema

In use-document-folders.ts, the createFolder mutation should POST:
```typescript
const createFolder = useMutation({
  mutationFn: async (data: FolderCreateData) => {
    const response = await api.post('/document-folders', {
      name: data.name,
      scope: data.scope,
      scope_id: data.scope_id,
      parent_id: data.parent_id,  // <-- Must be included!
    })
    return response.data
  },
  ...
})
```

FIX if missing: Ensure parent_id is explicitly included in the POST body, not filtered out.

If the frontend hook looks correct, check the backend (verification only):
1. Check the backend schema (document_folder.py) for DocumentFolderCreate:
   - Should have `parent_id: Optional[str] = None`

2. Check the backend router (document_folders.py) for POST endpoint:
   - Should use folder_data.parent_id when creating

These backend files are for reference only to diagnose if the issue is frontend or backend. The fix should be made to the frontend mutation if parent_id is not being sent.
  </action>
  <verify>
Grep for "parent_id" in use-document-folders.ts - should find in mutation payload.
Run typecheck to ensure no errors after any fixes.
  </verify>
  <done>
Frontend mutation correctly includes parent_id in the POST body for nested folder creation.
  </done>
</task>

</tasks>

<verification>
1. `cd electron-app && npm run typecheck` passes
2. parent_id is passed through the entire chain: context menu -> handler -> mutation -> API
3. The tree renders nested folders correctly (recursive renderFolderNode with children)
</verification>

<success_criteria>
- Right-click on a folder and select "New Folder" creates a nested subfolder
- The subfolder appears indented under the parent folder
- Multiple levels of nesting work (folder > subfolder > sub-subfolder)
- Both FolderTree (personal) and ApplicationTree (app/project scope) support nesting
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-09-SUMMARY.md`
</output>
