---
phase: 02.1-onenote-knowledge-tree-redesign
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - electron-app/src/renderer/pages/notes/index.tsx
  - electron-app/src/renderer/components/knowledge/knowledge-panel.tsx
  - electron-app/src/renderer/components/knowledge/document-editor.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking a document in Notes page tree opens the editor with document content"
    - "Clicking a document in Application Knowledge tab opens the editor with document content"
    - "Editor behavior is consistent across Notes, Application Knowledge, and Project Knowledge"
    - "Document content auto-saves after 2 seconds of inactivity with visual save status"
  artifacts:
    - path: "electron-app/src/renderer/pages/notes/index.tsx"
      provides: "Notes page with integrated KnowledgePanel replacing placeholder"
    - path: "electron-app/src/renderer/components/knowledge/knowledge-panel.tsx"
      provides: "KnowledgePanel with working editor, proper autosave, and save status indicator"
  key_links:
    - from: "notes/index.tsx"
      to: "KnowledgePanel"
      via: "Component render"
      pattern: "<KnowledgePanel"
    - from: "knowledge-panel.tsx"
      to: "useSaveDocumentContent"
      via: "Mutation hook with debounce"
      pattern: "useSaveDocumentContent"
---

<objective>
Fix the two BLOCKER gaps: editor not showing in Notes/Application screens, and autosave not working.

Purpose: Users must be able to select and edit documents across all three screens (Notes, Application Knowledge, Project Knowledge) with consistent behavior and automatic content persistence.

Output: Working document editor in all knowledge views with proper autosave and save status display.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-05-SUMMARY.md
@electron-app/src/renderer/pages/notes/index.tsx
@electron-app/src/renderer/components/knowledge/knowledge-panel.tsx
@electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
@electron-app/src/renderer/hooks/use-auto-save.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Notes page to use KnowledgePanel instead of placeholder</name>
  <files>electron-app/src/renderer/pages/notes/index.tsx</files>
  <action>
The current Notes page shows a placeholder ("Select a document to start editing") instead of an actual editor. This is the root cause of the "editor not showing" blocker.

Replace the placeholder main content area with a two-panel layout similar to KnowledgePanel:
1. Remove the placeholder div with FileText icon and "Select a document" text
2. The page should render:
   - Left: KnowledgeSidebar (already there)
   - Right: Editor panel that reads selectedDocumentId from context and renders DocumentEditor
3. Add imports for:
   - useKnowledgeBase (to get selectedDocumentId)
   - useDocument hook (to fetch document content)
   - useAuthStore (to get userId)
   - useSaveDocumentContent (for save mutation)
   - DocumentEditor component
4. Create an EditorPanel inner component that:
   - Uses useKnowledgeBase() to get selectedDocumentId
   - Fetches document via useDocument(selectedDocumentId)
   - Implements debounced save via useSaveDocumentContent (2s debounce, matching KnowledgePanel pattern)
   - Tracks rowVersion via ref for optimistic concurrency
   - Renders DocumentEditor when document selected, empty state when not
   - Passes documentId and userId to DocumentEditor for lock integration
5. Add SaveStatus display above or below the editor showing save state

The empty state should match existing pattern:
```tsx
<div className="flex-1 flex flex-col items-center justify-center text-muted-foreground gap-3">
  <FileText className="h-12 w-12 text-muted-foreground/30" />
  <p className="text-sm">Select a document to start editing</p>
</div>
```

The editor panel should take full remaining width and height (flex-1).
  </action>
  <verify>
Run `npm run typecheck` in electron-app directory - zero errors related to notes/index.tsx.
Grep for "Select a document" - should find it only in empty state condition, not as the only content.
  </verify>
  <done>
Notes page renders DocumentEditor when a document is selected from the sidebar tree, with save functionality integrated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SaveStatus indicator to KnowledgePanel and Notes EditorPanel</name>
  <files>electron-app/src/renderer/components/knowledge/knowledge-panel.tsx, electron-app/src/renderer/pages/notes/index.tsx</files>
  <action>
The autosave is happening (KnowledgePanel has debounced save) but there's no visual feedback. Users don't know if save worked.

1. Import SaveStatus component (from @/components/knowledge/SaveStatus)
2. Track save state with useState:
   - `saveState: 'idle' | 'saving' | 'saved' | 'error'`
   - `lastSavedAt: number | null`
3. Update the save mutation callbacks:
   - Before mutation: set saveState to 'saving'
   - onSuccess: set saveState to 'saved', lastSavedAt to Date.now()
   - onError: set saveState to 'error'
4. Render SaveStatus component in the editor area header/footer:
   ```tsx
   <SaveStatus
     status={{
       state: saveState,
       at: lastSavedAt || 0,
       message: saveState === 'error' ? 'Save failed' : undefined
     }}
   />
   ```
5. The SaveStatus should appear in a subtle location (e.g., top-right of editor panel or in a status bar)

For KnowledgePanel: Add status bar between tree panel and editor, or at bottom of editor panel.
For Notes page: Same pattern in the EditorPanel component.
  </action>
  <verify>
Run `npm run typecheck` - zero errors.
Grep for "SaveStatus" in knowledge-panel.tsx and notes/index.tsx - should find usage.
  </verify>
  <done>
Both KnowledgePanel and Notes page show real-time save status: "Saving...", "Saved Xs ago", or error state.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify editor consistency across all three screens</name>
  <files>electron-app/src/renderer/pages/notes/index.tsx, electron-app/src/renderer/components/knowledge/knowledge-panel.tsx</files>
  <action>
Ensure the editor rendering and behavior is consistent:

1. All three screens should use the same DocumentEditor component with same props pattern:
   - content (parsed from content_json)
   - onChange (debounced save handler)
   - editable (true)
   - placeholder
   - documentId (for lock integration)
   - userId (for lock integration)
   - className

2. The debounce timing should be consistent (2 seconds for all screens per STATE.md decision)

3. Row version tracking pattern should be identical:
   - useRef for rowVersionRef
   - Initialize from document.row_version
   - Update on successful save
   - Pass to mutation

4. Content JSON parsing should be consistent:
   - Read: `document.content_json ? JSON.parse(document.content_json) : undefined`
   - Write: `JSON.stringify(json)` in mutation

5. Verify KnowledgePanel (used by App/Project detail) already has this pattern - if any differences exist, align them.
  </action>
  <verify>
Run `npm run typecheck` - zero errors.
Compare the onChange handler and save mutation patterns in both files - should be structurally identical.
  </verify>
  <done>
Editor behavior is identical across Notes page, Application Knowledge tab, and Project Knowledge tab.
  </done>
</task>

</tasks>

<verification>
1. `cd electron-app && npm run typecheck` passes with zero errors
2. Grep confirms DocumentEditor usage in notes/index.tsx
3. Grep confirms SaveStatus usage in both knowledge-panel.tsx and notes/index.tsx
4. Code review confirms consistent debounce (2s), rowVersion tracking, and JSON parsing patterns
</verification>

<success_criteria>
- Clicking a document in Notes page tree loads content in DocumentEditor
- Clicking a document in Application Knowledge tab loads content in DocumentEditor
- Making edits triggers autosave after 2 seconds of inactivity
- Save status indicator shows "Saving...", "Saved Xs ago", or error state
- Editor behavior is identical across all three knowledge screens
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-06-SUMMARY.md`
</output>
