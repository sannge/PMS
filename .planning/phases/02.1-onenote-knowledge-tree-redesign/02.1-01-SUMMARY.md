---
phase: 02.1-onenote-knowledge-tree-redesign
plan: 01
subsystem: knowledge-base
tags: [backend, frontend, context, tabs, scopes, hooks]
completed: 2026-02-02
duration: ~7 min
dependency_graph:
  requires: []
  provides:
    - "GET /api/documents/scopes-summary endpoint"
    - "shadcn/ui Tabs component (Tabs, TabsList, TabsTrigger, TabsContent)"
    - "KnowledgeBaseContext with activeTab, storagePrefix, no 'all' scope"
    - "useApplicationsWithDocs hook"
    - "scopesSummary query key"
  affects:
    - "02.1-02 (tab bar UI uses Tabs component and useApplicationsWithDocs)"
    - "02.1-03 (embedded knowledge panels use storagePrefix)"
    - "02.1-04 (navigation depends on activeTab state)"
tech_stack:
  added: []
  patterns:
    - "Storage key prefix pattern for multi-instance context isolation"
    - "Tab-to-scope derivation (activeTab string -> scope + scopeId)"
key_files:
  created:
    - electron-app/src/renderer/components/ui/tabs.tsx
  modified:
    - fastapi-backend/app/routers/documents.py
    - fastapi-backend/app/schemas/document.py
    - electron-app/src/renderer/contexts/knowledge-base-context.tsx
    - electron-app/src/renderer/hooks/use-documents.ts
    - electron-app/src/renderer/lib/query-client.ts
    - electron-app/src/renderer/components/knowledge/folder-tree.tsx
decisions:
  - "Storage key prefix pattern: buildStorageKeys(prefix) generates namespaced keys to avoid localStorage conflicts between multiple KnowledgeBaseProvider instances"
  - "Tab value encoding: 'personal' for personal scope, 'app:{id}' for application scope, derived via deriveFromTab()"
  - "Legacy 'all' scope migration: stored 'all' value in localStorage falls back to 'personal'"
metrics:
  tasks_completed: 2
  tasks_total: 2
  commits: 2
---

# Phase 02.1 Plan 01: Foundations (Backend Endpoint + Tabs + Context Refactor) Summary

Backend scopes-summary endpoint, shadcn/ui Tabs component, KnowledgeBaseContext refactored with activeTab/storagePrefix/no-all-scope, and useApplicationsWithDocs hook with scopes-summary invalidation on document CRUD.

## Task Execution

### Task 1: Backend scopes-summary endpoint + shadcn/ui Tabs component
**Commit:** `b42f489`

- Added `ApplicationWithDocs` and `ScopesSummaryResponse` Pydantic schemas to `document.py`
- Added `GET /api/documents/scopes-summary` endpoint that returns:
  - `has_personal_docs`: whether user has personal documents
  - `applications`: list of applications (id, name) that have documents visible to the user
- Query joins ApplicationMember to scope to user's apps, uses EXISTS subquery for efficiency
- Created `tabs.tsx` shadcn/ui component wrapping `@radix-ui/react-tabs` with:
  - TabsList: horizontal flex container with border-bottom and overflow-x-auto
  - TabsTrigger: underline-style active indicator, focus-visible ring, hover transitions, disabled state
  - TabsContent: flex-1 with focus ring support

### Task 2: Refactor KnowledgeBaseContext + add useApplicationsWithDocs hook
**Commit:** `099ec64`

- Removed `'all'` from `ScopeType` union (now `'personal' | 'application' | 'project'`)
- Added `activeTab: string` to UI state with `SET_ACTIVE_TAB` reducer action
- `SET_ACTIVE_TAB` derives scope and scopeId from tab value via `deriveFromTab()`
- Added `storagePrefix` prop to `KnowledgeBaseProviderProps` (defaults to `'kb-'`)
- Replaced hardcoded `STORAGE_KEY_*` constants with `buildStorageKeys(prefix)` pattern
- Added `useMemo` for storage keys to avoid recalculating on every render
- Legacy `'all'` scope in localStorage gracefully migrates to `'personal'`
- Added `scopesSummary` to centralized `queryKeys` in `query-client.ts`
- Added `useApplicationsWithDocs` hook with 30s staleTime using `window.electronAPI`
- Added scopes-summary invalidation to `useCreateDocument` and `useDeleteDocument` `onSuccess`
- Cleaned up dead `'all'` scope branches and ScopePickerDialog from `folder-tree.tsx`

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Removed dead code from folder-tree.tsx**
- **Found during:** Task 2
- **Issue:** After removing 'all' from ScopeType, folder-tree.tsx had unreachable `scope === 'all'` branches that would cause TypeScript errors
- **Fix:** Removed the dead branches, the ScopePickerDialog reference, and associated state (scopePickerOpen, pendingFolderId, handleScopePickerConfirm)
- **Files modified:** electron-app/src/renderer/components/knowledge/folder-tree.tsx
- **Commit:** 099ec64

## Verification

- Backend compiles: `from app.routers.documents import router` -- OK
- TypeScript: zero new errors (52 pre-existing errors unrelated to changes)
- Tabs component exports all 4 components (Tabs, TabsList, TabsTrigger, TabsContent)
- KnowledgeBaseContext: ScopeType no longer includes 'all', activeTab state present, storagePrefix support added
- useApplicationsWithDocs hook present in use-documents.ts with 30s staleTime
- Document create/delete mutations invalidate scopesSummary query

## Next Phase Readiness

Plan 02.1-02 can proceed -- it depends on the Tabs component, KnowledgeBaseContext activeTab state, and useApplicationsWithDocs hook, all of which are delivered.
