---
phase: 02.1-onenote-knowledge-tree-redesign
plan: 02
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - electron-app/src/renderer/components/knowledge/knowledge-tab-bar.tsx
  - electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
  - electron-app/src/renderer/components/knowledge/folder-tree-item.tsx
  - electron-app/src/renderer/pages/notes/index.tsx
autonomous: true

must_haves:
  truths:
    - "Notes page shows horizontal tabs: My Notes first, then one tab per application with documents"
    - "Selecting a tab changes the tree view to show only that scope's documents"
    - "Application tabs auto-appear when documents exist and auto-disappear when deleted"
    - "Tree items display without chevron arrows (OneNote page-list style)"
    - "Lock icon and editing user indicator shown inline on tree items"
    - "No document counts shown on folders"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/knowledge-tab-bar.tsx"
      provides: "KnowledgeTabBar component with auto-managed tabs"
      exports: ["KnowledgeTabBar"]
    - path: "electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx"
      provides: "Restructured sidebar with tab bar instead of scope filter"
      contains: "KnowledgeTabBar"
    - path: "electron-app/src/renderer/components/knowledge/folder-tree-item.tsx"
      provides: "OneNote-style tree item without chevrons, with lock indicator"
  key_links:
    - from: "knowledge-tab-bar.tsx"
      to: "knowledge-base-context.tsx"
      via: "setActiveTab callback"
      pattern: "setActiveTab"
    - from: "knowledge-sidebar.tsx"
      to: "knowledge-tab-bar.tsx"
      via: "import and render"
      pattern: "KnowledgeTabBar"
---

<objective>
Build the KnowledgeTabBar component (horizontal tabs for My Notes + application tabs) and restructure the sidebar to replace the ScopeFilter dropdown with tabs. Restyle folder-tree-item to OneNote page-list style (no chevrons, lock/presence indicators).

Purpose: This is the core visual transformation from dropdown scope filter to horizontal tabs, and from file-explorer tree to OneNote-style page list.
Output: Tab bar component, restructured sidebar, restyled tree items.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-CONTEXT.md
@.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-RESEARCH.md
@.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-01-SUMMARY.md
@electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
@electron-app/src/renderer/components/knowledge/folder-tree-item.tsx
@electron-app/src/renderer/components/knowledge/search-bar.tsx
@electron-app/src/renderer/components/knowledge/folder-tree.tsx
@electron-app/src/renderer/components/ui/tabs.tsx
@electron-app/src/renderer/contexts/knowledge-base-context.tsx
@electron-app/src/renderer/hooks/use-documents.ts
@electron-app/src/renderer/pages/notes/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: KnowledgeTabBar + restructured KnowledgeSidebar</name>
  <files>
    electron-app/src/renderer/components/knowledge/knowledge-tab-bar.tsx
    electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
    electron-app/src/renderer/pages/notes/index.tsx
  </files>
  <action>
    **Create KnowledgeTabBar:**

    Create `knowledge-tab-bar.tsx` with:
    ```typescript
    interface KnowledgeTabBarProps {
      activeTab: string     // 'personal' | `app:${id}`
      onTabChange: (tab: string) => void
      applicationsWithDocs: Array<{ id: string; name: string }>
    }
    ```

    Implementation:
    - Use the Tabs/TabsList/TabsTrigger from `@/components/ui/tabs`
    - First tab: "My Notes" with User icon (lucide), value="personal" — always present
    - Subsequent tabs: one per application from `applicationsWithDocs`, value=`app:${id}`, with Building2 icon
    - Tab names: truncate long application names with `max-w-[120px] truncate`
    - The tab bar is controlled (value + onValueChange)
    - TabsContent is NOT rendered here — the tab bar only controls which tree shows. Content is managed by the sidebar.

    **Restructure KnowledgeSidebar:**

    Replace the ScopeFilter import and usage with KnowledgeTabBar:
    1. Remove `import { ScopeFilter } from './scope-filter'`
    2. Import `KnowledgeTabBar` and `useApplicationsWithDocs` from hooks
    3. Read `activeTab` and `setActiveTab` from `useKnowledgeBase()`
    4. Fetch applications with docs: `const { data: scopesSummary } = useApplicationsWithDocs()`
    5. Replace the scope filter section with:
       ```tsx
       <KnowledgeTabBar
         activeTab={activeTab}
         onTabChange={setActiveTab}
         applicationsWithDocs={scopesSummary?.applications ?? []}
       />
       ```
    6. Keep the search bar above the tab bar
    7. Keep the tag filter list at the bottom
    8. Keep the FolderTree in the ScrollArea (it will use the context scope which is set by the tab)

    **Update Notes page:**

    The NotesPage currently passes `initialScope` and `initialScopeId` to KnowledgeBaseProvider. Update:
    - Remove the `applicationId` prop — it's no longer needed (tabs handle scope switching)
    - Keep the KnowledgeBaseProvider wrapping
    - The page layout stays the same: sidebar on left, content area on right

    **Add '+' button at top of tree section (BELOW tab bar and search bar, ABOVE ScrollArea):**

    In the sidebar layout, the vertical order is: KnowledgeTabBar -> SearchBar -> '+' creation row -> ScrollArea (tree). The '+' button sits between the search bar and the scrollable tree content.

    Add a small row with two icon buttons (FilePlus for new doc, FolderPlus for new folder):

    ```tsx
    import { useAuthStore } from '@/stores/auth-store'
    import { useCreateDocument, useCreateFolder } from '@/hooks/use-documents'

    // Inside the sidebar component:
    const userId = useAuthStore((s) => s.user?.id)
    const { activeTab } = useKnowledgeBase()
    const createDocument = useCreateDocument()
    const createFolder = useCreateFolder()

    // Resolve scope from active tab:
    const resolveScope = () => {
      if (activeTab === 'personal') {
        return { scope: 'personal' as const, scopeId: userId! }
      }
      // activeTab is `app:${id}`
      const appId = activeTab.slice(4)
      return { scope: 'application' as const, scopeId: appId }
    }

    const handleCreateDoc = () => {
      const { scope, scopeId } = resolveScope()
      createDocument.mutate({
        title: 'Untitled',
        scope,
        scope_id: scopeId,
        folder_id: null,
      })
    }

    const handleCreateFolder = () => {
      const { scope, scopeId } = resolveScope()
      createFolder.mutate({
        name: 'New Folder',
        scope,
        scope_id: scopeId,
        parent_folder_id: null,
      })
    }
    ```

    Render the creation row:
    ```tsx
    {/* Between search bar and ScrollArea */}
    <div className="flex items-center gap-1 px-2 py-1 border-b border-border">
      <button
        onClick={handleCreateDoc}
        className="p-1 rounded hover:bg-accent text-muted-foreground hover:text-foreground"
        title="New document"
      >
        <FilePlus className="h-4 w-4" />
      </button>
      <button
        onClick={handleCreateFolder}
        className="p-1 rounded hover:bg-accent text-muted-foreground hover:text-foreground"
        title="New folder"
      >
        <FolderPlus className="h-4 w-4" />
      </button>
    </div>
    <ScrollArea className="flex-1">
      {/* tree content */}
    </ScrollArea>
    ```

    This satisfies the CONTEXT.md requirement: "'+' button always visible at top of tree for quick doc/folder creation."
  </action>
  <verify>
    1. `cd electron-app && npx tsc --noEmit --pretty 2>&1 | head -30` — zero errors
    2. Grep to confirm ScopeFilter is NOT imported in knowledge-sidebar: `grep -n "ScopeFilter" electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx` — no matches
    3. Grep to confirm KnowledgeTabBar is imported: `grep -n "KnowledgeTabBar" electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx` — matches found
  </verify>
  <done>
    KnowledgeTabBar renders My Notes + application tabs. KnowledgeSidebar uses tab bar instead of ScopeFilter. Notes page no longer passes applicationId. '+' creation button visible at top of tree area.
  </done>
</task>

<task type="auto">
  <name>Task 2: OneNote-style folder-tree-item (no chevrons, lock indicators)</name>
  <files>
    electron-app/src/renderer/components/knowledge/folder-tree-item.tsx
  </files>
  <action>
    Restyle `FolderTreeItem` to match OneNote page-list decisions from CONTEXT.md:

    1. **Remove chevron arrows:** Delete the `ChevronRight` import and the chevron rendering block. Folders expand/collapse on click (behavior already exists via `onToggleExpand` + `onSelect`) — just remove the visual chevron.
    2. **Remove document count badge:** Delete the `documentCount` variable and the badge rendering. CONTEXT.md says "No document counts on folders or sections."
    3. **Folder icon change:** Keep FolderOpen for expanded, Folder for collapsed (already done).
    4. **Add lock indicator:** Accept new optional props:
       ```typescript
       isLocked?: boolean
       lockHolderName?: string
       ```
       When `isLocked` is true, show a small Lock icon (lucide `Lock`) after the name, with a title tooltip showing lockHolderName.
    5. **Adjust indentation:** Remove the empty `<span className="w-3.5 shrink-0" />` spacer that was used to align documents with chevron-width. Without chevrons, documents and folders should use the same base padding.
    6. **Visual refinement:** Keep the background highlight for selected items. Use slightly softer indentation: `paddingLeft: depth * 20 + 12` (a bit more spacing for the page-list feel).
    7. **Click behavior unchanged:** Clicking a folder toggles expand AND selects. Clicking a document selects it.

    The FolderTreeItem props interface keeps `isExpanded` for ARIA `aria-expanded` attribute but the chevron visual is removed.
  </action>
  <verify>
    1. `cd electron-app && npx tsc --noEmit --pretty 2>&1 | head -20` — zero errors
    2. Grep for ChevronRight in the file: `grep "ChevronRight" electron-app/src/renderer/components/knowledge/folder-tree-item.tsx` — no matches
    3. Grep for documentCount or document_count in the file — no matches
  </verify>
  <done>
    FolderTreeItem renders without chevron arrows. No document count badges. Lock icon shown when isLocked=true. Indentation adjusted for OneNote page-list feel. TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
1. `cd electron-app && npx tsc --noEmit --pretty` — zero errors
2. KnowledgeTabBar component exists and renders tabs
3. KnowledgeSidebar no longer imports ScopeFilter
4. FolderTreeItem has no ChevronRight, no document count
5. Lock indicator props accepted and rendered
</verification>

<success_criteria>
- Tab bar shows "My Notes" + application tabs dynamically
- Tab switching sets scope in KnowledgeBaseContext (via setActiveTab)
- Tree items are OneNote page-list style: no chevrons, indentation only
- Lock icon and editing user name shown inline on locked tree items
- No document counts on folder items
- '+' button visible at top of tree for quick creation
- Zero TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-02-SUMMARY.md`
</output>
