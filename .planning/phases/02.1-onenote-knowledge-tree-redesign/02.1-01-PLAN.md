---
phase: 02.1-onenote-knowledge-tree-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fastapi-backend/app/routers/documents.py
  - fastapi-backend/app/schemas/document.py
  - electron-app/src/renderer/components/ui/tabs.tsx
  - electron-app/src/renderer/contexts/knowledge-base-context.tsx
  - electron-app/src/renderer/hooks/use-documents.ts
autonomous: true

must_haves:
  truths:
    - "Backend returns which applications have documents for auto-managed tab visibility"
    - "KnowledgeBaseContext no longer has 'all' scope type"
    - "KnowledgeBaseContext supports storagePrefix to avoid localStorage conflicts between multiple instances"
    - "User can see horizontal tab-style UI elements with keyboard navigation and focus ring indicators"
  artifacts:
    - path: "fastapi-backend/app/routers/documents.py"
      provides: "GET /scopes-summary endpoint"
      contains: "scopes-summary"
    - path: "electron-app/src/renderer/components/ui/tabs.tsx"
      provides: "Tabs, TabsList, TabsTrigger, TabsContent components"
      exports: ["Tabs", "TabsList", "TabsTrigger", "TabsContent"]
    - path: "electron-app/src/renderer/contexts/knowledge-base-context.tsx"
      provides: "Updated context with activeTab, storagePrefix, no 'all' scope"
      contains: "activeTab"
    - path: "electron-app/src/renderer/hooks/use-documents.ts"
      provides: "useApplicationsWithDocs hook"
      contains: "useApplicationsWithDocs"
  key_links:
    - from: "electron-app/src/renderer/hooks/use-documents.ts"
      to: "/api/documents/scopes-summary"
      via: "fetch in useApplicationsWithDocs"
      pattern: "scopes-summary"
---

<objective>
Build the foundational pieces for the OneNote-style tab redesign: backend scopes-summary endpoint, shadcn/ui Tabs component, updated KnowledgeBaseContext (remove 'all' scope, add activeTab + storagePrefix), and useApplicationsWithDocs hook.

Purpose: These are the data and UI primitives that all subsequent plans depend on. The backend endpoint tells the frontend which application tabs to show. The context changes support multiple provider instances without localStorage conflicts.
Output: Backend endpoint, Tabs UI component, refactored context, new data hook.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-CONTEXT.md
@.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-RESEARCH.md
@electron-app/src/renderer/contexts/knowledge-base-context.tsx
@electron-app/src/renderer/hooks/use-documents.ts
@fastapi-backend/app/routers/documents.py
@fastapi-backend/app/schemas/document.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend scopes-summary endpoint + shadcn/ui Tabs component</name>
  <files>
    fastapi-backend/app/routers/documents.py
    fastapi-backend/app/schemas/document.py
    electron-app/src/renderer/components/ui/tabs.tsx
  </files>
  <action>
    **Backend: GET /api/documents/scopes-summary endpoint**

    In `fastapi-backend/app/schemas/document.py`, add a new Pydantic schema:
    ```python
    class ApplicationWithDocs(BaseModel):
        id: str
        name: str

    class ScopesSummaryResponse(BaseModel):
        has_personal_docs: bool
        applications: list[ApplicationWithDocs]
    ```

    In `fastapi-backend/app/routers/documents.py`, add a new endpoint BEFORE the `/{document_id}` routes (to avoid path conflicts):
    ```python
    @router.get("/scopes-summary", response_model=ScopesSummaryResponse)
    async def get_scopes_summary(
        current_user: User = Depends(get_current_user),
        db: AsyncSession = Depends(get_db),
    ) -> dict:
        """Return which scopes have documents for auto-managed tab visibility."""
        # Personal docs exist?
        personal_count = await db.scalar(
            select(func.count(Document.id))
            .where(Document.user_id == current_user.id)
            .where(Document.deleted_at.is_(None))
        )

        # Applications with docs (app-scoped or project-scoped under app)
        apps_with_docs = await db.execute(
            select(Application.id, Application.name)
            .join(ApplicationMember, ApplicationMember.application_id == Application.id)
            .where(ApplicationMember.user_id == current_user.id)
            .where(
                exists(
                    select(Document.id)
                    .where(
                        or_(
                            and_(Document.application_id == Application.id, Document.project_id.is_(None)),
                            Document.project_id.in_(
                                select(Project.id).where(Project.application_id == Application.id)
                            ),
                        )
                    )
                    .where(Document.deleted_at.is_(None))
                )
            )
            .order_by(Application.created_at.asc())
        )

        return {
            "has_personal_docs": personal_count > 0,
            "applications": [{"id": str(r.id), "name": r.name} for r in apps_with_docs.all()],
        }
    ```

    Add necessary imports: `from sqlalchemy import and_, or_, exists`, and import `Application`, `ApplicationMember`, `Project` models. Check existing imports first.

    **Frontend: shadcn/ui Tabs component**

    Create `electron-app/src/renderer/components/ui/tabs.tsx` following the shadcn/ui wrapper pattern (consistent with existing dialog.tsx, scroll-area.tsx, etc.):
    ```typescript
    import * as TabsPrimitive from '@radix-ui/react-tabs'
    import { forwardRef } from 'react'
    import { cn } from '@/lib/utils'

    const Tabs = TabsPrimitive.Root

    const TabsList = forwardRef<
      React.ElementRef<typeof TabsPrimitive.List>,
      React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
    >(({ className, ...props }, ref) => (
      <TabsPrimitive.List
        ref={ref}
        className={cn(
          'inline-flex h-9 items-center gap-1 border-b border-border px-2',
          'overflow-x-auto scrollbar-none',
          className
        )}
        {...props}
      />
    ))
    TabsList.displayName = TabsPrimitive.List.displayName

    const TabsTrigger = forwardRef<
      React.ElementRef<typeof TabsPrimitive.Trigger>,
      React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
    >(({ className, ...props }, ref) => (
      <TabsPrimitive.Trigger
        ref={ref}
        className={cn(
          'inline-flex items-center gap-1.5 whitespace-nowrap px-3 py-1.5',
          'text-sm font-medium text-muted-foreground',
          'border-b-2 border-transparent',
          'transition-colors hover:text-foreground',
          'data-[state=active]:text-foreground data-[state=active]:border-primary',
          'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring',
          className
        )}
        {...props}
      />
    ))
    TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

    const TabsContent = forwardRef<
      React.ElementRef<typeof TabsPrimitive.Content>,
      React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
    >(({ className, ...props }, ref) => (
      <TabsPrimitive.Content
        ref={ref}
        className={cn('flex-1 outline-none', className)}
        {...props}
      />
    ))
    TabsContent.displayName = TabsPrimitive.Content.displayName

    export { Tabs, TabsList, TabsTrigger, TabsContent }
    ```
  </action>
  <verify>
    1. Run `cd fastapi-backend && python -c "from app.routers.documents import router; print('OK')"` to verify no import errors
    2. Run `cd electron-app && npx tsc --noEmit --pretty 2>&1 | head -30` to verify TypeScript compilation
  </verify>
  <done>
    Backend scopes-summary endpoint exists and compiles. Tabs UI component exists with all four exports. No TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor KnowledgeBaseContext + add useApplicationsWithDocs hook</name>
  <files>
    electron-app/src/renderer/contexts/knowledge-base-context.tsx
    electron-app/src/renderer/hooks/use-documents.ts
  </files>
  <action>
    **KnowledgeBaseContext refactor:**

    1. Change `ScopeType` to remove 'all': `export type ScopeType = 'personal' | 'application' | 'project'`
    2. Add `activeTab` to state: `activeTab: string` — stores 'personal' or `app:${id}` composite value
    3. Add `storagePrefix` prop to `KnowledgeBaseProviderProps` (optional string, defaults to 'kb-')
    4. Update all localStorage key constants to use the prefix. The existing keys are:
       ```typescript
       // Current constants (find these in knowledge-base-context.tsx):
       const STORAGE_KEY_SCOPE = 'knowledge-base-scope'
       const STORAGE_KEY_SCOPE_ID = 'knowledge-base-scope-id'
       const STORAGE_KEY_EXPANDED_FOLDERS = 'knowledge-base-expanded-folders'
       const STORAGE_KEY_SELECTED_DOCUMENT = 'knowledge-base-selected-document'
       const STORAGE_KEY_SELECTED_FOLDER = 'knowledge-base-selected-folder'
       ```
       Replace these with a helper function:
       ```typescript
       function getStorageKey(prefix: string, key: string): string {
         return `${prefix}${key}`
       }
       ```
       Then in the provider, compute namespaced keys using the prefix:
       ```typescript
       const prefix = storagePrefix ?? 'kb-'
       const keys = {
         scope: getStorageKey(prefix, 'scope'),
         scopeId: getStorageKey(prefix, 'scope-id'),
         expandedFolders: getStorageKey(prefix, 'expanded-folders'),
         selectedDocument: getStorageKey(prefix, 'selected-document'),
         selectedFolder: getStorageKey(prefix, 'selected-folder'),
         activeTab: getStorageKey(prefix, 'active-tab'),
       }
       ```
       Replace all `localStorage.getItem(STORAGE_KEY_*)` and `localStorage.setItem(STORAGE_KEY_*, ...)` calls to use `keys.*` instead. Pass `keys` to the reducer init function and persistence effects.
    5. Add `SET_ACTIVE_TAB` action to the reducer that sets activeTab AND derives scope + scopeId from the tab value:
       - 'personal' → scope='personal', scopeId=null (userId resolved later)
       - `app:${id}` → scope='application', scopeId=id
    6. Add `setActiveTab: (tab: string) => void` to the context value
    7. Update the initial state: default `activeTab` to 'personal' (loaded from localStorage with prefix)
    8. Remove 'all' from `SET_SCOPE` default fallback — if stored scope was 'all', default to 'personal'
    9. Persist activeTab to localStorage with prefix

    **useApplicationsWithDocs hook:**

    In `electron-app/src/renderer/hooks/use-documents.ts`, add:
    ```typescript
    export interface ApplicationWithDocs {
      id: string
      name: string
    }

    export interface ScopesSummaryResponse {
      has_personal_docs: boolean
      applications: ApplicationWithDocs[]
    }

    export function useApplicationsWithDocs(): UseQueryResult<ScopesSummaryResponse> {
      const token = useAuthStore((s) => s.token)
      return useQuery({
        queryKey: queryKeys.documents.scopesSummary(),
        queryFn: async () => {
          const res = await fetch(`${API_URL}/documents/scopes-summary`, {
            headers: { Authorization: `Bearer ${token}` },
          })
          if (!res.ok) throw new Error('Failed to fetch scopes summary')
          return res.json()
        },
        staleTime: 30_000,
        enabled: !!token,
      })
    }
    ```

    Also add `scopesSummary` to the queryKeys in `electron-app/src/renderer/lib/query-client.ts`:
    - Under `documents`, add: `scopesSummary: () => ['documents', 'scopes-summary'] as const`

    **Update mutation invalidation:**
    In the existing `useCreateDocument` and `useDeleteDocument` mutation hooks in `use-documents.ts`, add invalidation of the `queryKeys.documents.scopesSummary()` query key in the `onSuccess` callback — so that creating/deleting a document updates tab visibility.

    IMPORTANT: Do NOT break any existing imports of `ScopeType`. Search for all usages of the 'all' scope value across the codebase. The scope-filter.tsx and scope-picker-dialog.tsx files that reference 'all' will be REMOVED in a later plan, so they can be ignored. But any other file referencing `scope === 'all'` must be updated.
  </action>
  <verify>
    1. Run `cd electron-app && npx tsc --noEmit --pretty 2>&1 | head -50` — zero type errors
    2. Grep for `'all'` in knowledge base context to confirm it's been removed: `grep -rn "'all'" electron-app/src/renderer/contexts/knowledge-base-context.tsx` — should find zero matches
  </verify>
  <done>
    KnowledgeBaseContext has activeTab state, storagePrefix support, and no 'all' scope. useApplicationsWithDocs hook fetches scopes-summary. Document create/delete mutations invalidate scopes-summary query. All TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
1. `cd fastapi-backend && python -c "from app.routers.documents import router"` — no errors
2. `cd electron-app && npx tsc --noEmit --pretty` — zero errors
3. Tabs component exports all 4 components
4. KnowledgeBaseContext no longer has 'all' in ScopeType
5. useApplicationsWithDocs hook exists in use-documents.ts
</verification>

<success_criteria>
- Backend scopes-summary endpoint compiles and is registered
- shadcn/ui Tabs component (tabs.tsx) created with correct Radix wrapper pattern
- KnowledgeBaseContext refactored: ScopeType = 'personal' | 'application' | 'project', activeTab state added, storagePrefix support added
- useApplicationsWithDocs hook added with 30s staleTime
- Document CRUD mutations invalidate scopes-summary query
- Zero TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-01-SUMMARY.md`
</output>
