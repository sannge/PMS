---
phase: 02.1-onenote-knowledge-tree-redesign
plan: 10
type: execute
wave: 2
depends_on: ["02.1-06"]
files_modified:
  - electron-app/src/renderer/components/knowledge/knowledge-tab-bar.tsx
  - electron-app/src/renderer/components/knowledge/application-tree.tsx
  - electron-app/src/renderer/hooks/use-documents.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Horizontal tabs don't get cut off - overflow shows dropdown menu"
    - "Application tab only shows projects that have knowledge documents"
    - "Unfiled section is removed or hidden"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/knowledge-tab-bar.tsx"
      provides: "Tab bar with overflow dropdown for many tabs"
  key_links:
    - from: "knowledge-tab-bar.tsx"
      to: "DropdownMenu"
      via: "Overflow tabs handling"
      pattern: "DropdownMenu|overflow"
---

<objective>
Fix tab bar and project filtering: tabs get cut off, shows all projects instead of only those with documents, confusing Unfiled section.

Purpose: Tab bar should handle many applications gracefully, and the tree should only show relevant content (projects with docs).

Output: Overflow-aware tab bar, filtered project list, removed/hidden Unfiled section.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@electron-app/src/renderer/components/knowledge/knowledge-tab-bar.tsx
@electron-app/src/renderer/components/knowledge/application-tree.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add overflow handling to KnowledgeTabBar</name>
  <files>electron-app/src/renderer/components/knowledge/knowledge-tab-bar.tsx</files>
  <action>
Current issue: TabsList with many tabs overflows and gets cut off.

Solution: Implement a responsive tab bar that shows visible tabs + "..." dropdown for overflow.

1. Add imports:
   ```tsx
   import { useRef, useState, useEffect } from 'react'
   import { MoreHorizontal, Building2, User } from 'lucide-react'
   import {
     DropdownMenu,
     DropdownMenuContent,
     DropdownMenuItem,
     DropdownMenuTrigger,
   } from '@/components/ui/dropdown-menu'
   ```

2. Add resize observer to track available width:
   ```tsx
   const containerRef = useRef<HTMLDivElement>(null)
   const [visibleCount, setVisibleCount] = useState(Infinity)

   useEffect(() => {
     if (!containerRef.current) return

     const observer = new ResizeObserver((entries) => {
       const width = entries[0]?.contentRect.width || 0
       // Each tab is roughly 120px + 8px gap, My Notes is fixed
       // Reserve 40px for dropdown button
       const availableWidth = width - 120 - 40 // My Notes + dropdown
       const tabWidth = 128 // Approx width per app tab
       const count = Math.max(0, Math.floor(availableWidth / tabWidth))
       setVisibleCount(count)
     })

     observer.observe(containerRef.current)
     return () => observer.disconnect()
   }, [])
   ```

3. Split apps into visible and overflow:
   ```tsx
   const visibleApps = applicationsWithDocs.slice(0, visibleCount)
   const overflowApps = applicationsWithDocs.slice(visibleCount)
   ```

4. Render with overflow dropdown:
   ```tsx
   return (
     <div ref={containerRef} className="w-full">
       <Tabs value={activeTab} onValueChange={onTabChange}>
         <TabsList className="w-full justify-start overflow-hidden">
           <TabsTrigger value="personal" className="gap-1 text-xs shrink-0">
             <User className="h-3.5 w-3.5 shrink-0" />
             <span>My Notes</span>
           </TabsTrigger>

           {visibleApps.map((app) => (
             <TabsTrigger
               key={app.id}
               value={`app:${app.id}`}
               className="gap-1 text-xs shrink-0"
             >
               <Building2 className="h-3.5 w-3.5 shrink-0" />
               <span className="max-w-[100px] truncate">{app.name}</span>
             </TabsTrigger>
           ))}

           {overflowApps.length > 0 && (
             <DropdownMenu>
               <DropdownMenuTrigger asChild>
                 <button className="flex items-center justify-center h-8 w-8 rounded-md hover:bg-muted shrink-0">
                   <MoreHorizontal className="h-4 w-4" />
                 </button>
               </DropdownMenuTrigger>
               <DropdownMenuContent align="end">
                 {overflowApps.map((app) => (
                   <DropdownMenuItem
                     key={app.id}
                     onClick={() => onTabChange(`app:${app.id}`)}
                     className={cn(
                       'gap-2',
                       activeTab === `app:${app.id}` && 'bg-accent'
                     )}
                   >
                     <Building2 className="h-3.5 w-3.5" />
                     <span>{app.name}</span>
                   </DropdownMenuItem>
                 ))}
               </DropdownMenuContent>
             </DropdownMenu>
           )}
         </TabsList>
       </Tabs>
     </div>
   )
   ```
  </action>
  <verify>
Run `npm run typecheck` - zero errors.
Grep for "DropdownMenu" in knowledge-tab-bar.tsx - should find import and usage.
Grep for "ResizeObserver" - should find the observer setup.
  </verify>
  <done>
Tab bar shows visible tabs plus "..." dropdown for overflow tabs when panel is narrow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Filter ApplicationTree to only show projects with documents</name>
  <files>electron-app/src/renderer/components/knowledge/application-tree.tsx</files>
  <action>
Current issue: ApplicationTree shows ALL projects under an application, but it should only show projects that have knowledge documents.

**Solution: Use `hideIfEmpty` prop on ProjectSection to hide empty projects after they load.**

This is the most pragmatic approach since:
- Backend filtering would require additional API changes
- Pre-filtering requires knowing doc counts before rendering
- Hiding after lazy-load is simple and works with existing lazy-load pattern

Implementation:

1. Add `hideIfEmpty` prop to ProjectSection internal component:
   ```tsx
   interface ProjectSectionProps {
     // ... existing props
     hideIfEmpty?: boolean
   }
   ```

2. In ProjectSection, track whether content has loaded and is empty:
   ```tsx
   const { data: treeData, isLoading } = useFolderTree(scope, project.id)

   const isEmpty = useMemo(() => {
     if (isLoading) return false // Don't hide while loading
     if (!treeData) return true
     return treeData.folders.length === 0 && treeData.unfiled_documents.length === 0
   }, [treeData, isLoading])
   ```

3. Hide the section when expanded, loaded, and empty:
   ```tsx
   // If hideIfEmpty is true and we've loaded empty content, don't render
   if (hideIfEmpty && isExpanded && isEmpty && !isLoading) {
     return null
   }
   ```

4. Pass `hideIfEmpty={true}` when rendering ProjectSection:
   ```tsx
   {projectList.map((project) => (
     <ProjectSection
       key={project.id}
       project={project}
       hideIfEmpty={true}
       // ... other props
     />
   ))}
   ```

5. Alternative visual approach (if hiding entirely is jarring): Show collapsed sections, but indicate empty when expanded:
   ```tsx
   if (isExpanded && isEmpty) {
     return (
       <div className="pl-4 py-1 text-xs text-muted-foreground italic">
         No documents
       </div>
     )
   }
   ```

Use the `hideIfEmpty={true}` approach with full hiding - this is cleaner for the user since they don't see irrelevant empty projects cluttering the tree.
  </action>
  <verify>
Run `npm run typecheck` - zero errors.
Grep for "hideIfEmpty" in application-tree.tsx - should find the prop and usage.
Code review confirms projects are hidden when empty.
  </verify>
  <done>
Application tab only shows project sections that have knowledge documents.
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove or hide confusing Unfiled section</name>
  <files>electron-app/src/renderer/components/knowledge/folder-tree.tsx, electron-app/src/renderer/components/knowledge/application-tree.tsx</files>
  <action>
User reported: "'Unfiled' section is confusing - doesn't make sense".

According to CONTEXT.md, there's no explicit mention of an "Unfiled" section. Documents without a folder should just appear at the root level without a special label.

Current code shows "Unfiled" header for documents with no folder_id:
```tsx
{unfiledDocs.length > 0 && (
  <>
    {folders.length > 0 && (
      <div className="px-2 pt-2 pb-0.5">
        <span className="text-[10px] font-medium uppercase tracking-wider text-muted-foreground">
          Unfiled
        </span>
      </div>
    )}
    {unfiledDocs.map((doc) => renderDocumentItem(doc, 0))}
  </>
)}
```

Options:
1. Remove the "Unfiled" label entirely - just render docs at root level
2. Rename to something clearer like "Documents" or just remove the label
3. Keep but make it visually less prominent

Best solution per user feedback: Remove the "Unfiled" label entirely.

For folder-tree.tsx:
```tsx
{/* Root-level documents (no folder) */}
{unfiledDocs.length > 0 && (
  <>
    {/* Removed: "Unfiled" header was confusing */}
    {unfiledDocs.map((doc) => renderDocumentItem(doc, 0))}
  </>
)}
```

For application-tree.tsx:
```tsx
{/* App-level documents (no folder) */}
{unfiledDocs.length > 0 && (
  <>
    {/* Removed: "Unfiled" header was confusing */}
    {unfiledDocs.map((doc) => renderDocumentItem(doc, 0))}
  </>
)}
```

Simply remove the conditional header div that says "Unfiled". Documents still appear, just without the label.
  </action>
  <verify>
Grep for "Unfiled" in folder-tree.tsx and application-tree.tsx - should NOT find it after fix.
Run `npm run typecheck` - zero errors.
  </verify>
  <done>
"Unfiled" section label is removed; root-level documents appear without confusing header.
  </done>
</task>

</tasks>

<verification>
1. `cd electron-app && npm run typecheck` passes
2. Tab bar has overflow dropdown (grep for DropdownMenu in knowledge-tab-bar.tsx)
3. "Unfiled" text is removed from tree components
4. Projects are filtered or hidden when empty
</verification>

<success_criteria>
- Tab bar with many applications shows "..." dropdown for overflow
- Application tab shows only projects with knowledge documents (or hides empty ones)
- No "Unfiled" label appears in the tree
- Tab bar is responsive to panel width
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-onenote-knowledge-tree-redesign/02.1-10-SUMMARY.md`
</output>
