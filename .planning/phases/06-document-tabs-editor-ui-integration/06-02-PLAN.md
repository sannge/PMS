---
phase: 06-document-tabs-editor-ui-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - electron-app/src/renderer/components/knowledge/document-header.tsx
  - electron-app/src/renderer/components/knowledge/document-status-bar.tsx
  - electron-app/src/renderer/components/knowledge/tag-manager.tsx
  - electron-app/src/renderer/hooks/use-document-tags.ts
autonomous: true

must_haves:
  truths:
    - "Document title is displayed at the top and is editable by clicking on it"
    - "Metadata bar shows document tags with ability to add and remove tags"
    - "Metadata bar shows document scope label"
    - "Metadata bar shows 'last edited by' with relative timestamp (falls back to created_by if updated_by unavailable)"
    - "Bottom bar shows word count from the editor"
    - "Bottom bar shows last saved timestamp"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/document-header.tsx"
      provides: "Editable title + metadata bar (tags, scope, last edited)"
      exports: ["DocumentHeader"]
    - path: "electron-app/src/renderer/components/knowledge/document-status-bar.tsx"
      provides: "Word count and last saved timestamp bar"
      exports: ["DocumentStatusBar"]
    - path: "electron-app/src/renderer/components/knowledge/tag-manager.tsx"
      provides: "Tag display badges with add/remove popover"
      exports: ["TagManager"]
    - path: "electron-app/src/renderer/hooks/use-document-tags.ts"
      provides: "useAssignDocumentTag and useUnassignDocumentTag mutation hooks"
      contains: "useAssignDocumentTag"
  key_links:
    - from: "document-header.tsx"
      to: "use-documents.ts"
      via: "useRenameDocument for title save on blur/Enter"
      pattern: "useRenameDocument"
    - from: "tag-manager.tsx"
      to: "use-document-tags.ts"
      via: "useAssignDocumentTag and useUnassignDocumentTag mutations"
      pattern: "useAssignDocumentTag|useUnassignDocumentTag"
    - from: "document-status-bar.tsx"
      to: "@tiptap/react useEditorState"
      via: "Reads characterCount.words() from editor storage"
      pattern: "characterCount"
---

<objective>
Build the DocumentHeader (editable title + metadata bar) and DocumentStatusBar (word count + last saved) components, plus tag assignment mutation hooks.

Purpose: This plan delivers UI-06 (click-to-rename title), UI-07 (metadata bar with tags/scope/last-edited), and UI-09 (word count + last saved). It also creates the tag assignment hooks needed for the metadata bar's tag add/remove feature.

Output: Three new UI components and two new mutation hooks in use-document-tags.ts.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-document-tabs-editor-ui-integration/06-RESEARCH.md
@electron-app/src/renderer/hooks/use-documents.ts
@electron-app/src/renderer/hooks/use-document-tags.ts
@electron-app/src/renderer/components/knowledge/editor-types.ts
@electron-app/src/renderer/lib/time-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tag assignment mutation hooks to use-document-tags.ts</name>
  <files>electron-app/src/renderer/hooks/use-document-tags.ts</files>
  <action>
Add two new mutation hooks to the existing `use-document-tags.ts` file. These hooks call the backend endpoints created in Phase 1 (plan 01-04).

**Add imports:** `useMutation`, `useQueryClient`, `type UseMutationResult` from `@tanstack/react-query`.

**Add `useAssignDocumentTag` hook:**
```typescript
export function useAssignDocumentTag(
  scope: string,
  scopeId: string | null
): UseMutationResult<void, Error, { documentId: string; tagId: string }>
```
- Uses `window.electronAPI.post` to POST `/api/documents/{documentId}/tags/{tagId}`
- Auth headers from `useAuthStore`
- On success: invalidate `queryKeys.document(documentId)` (document response includes tags), and invalidate `queryKeys.documents(scope, scopeId ?? '')` (document list may include tag info)
- Return type is void (201 no body)

**Add `useUnassignDocumentTag` hook:**
```typescript
export function useUnassignDocumentTag(
  scope: string,
  scopeId: string | null
): UseMutationResult<void, Error, { documentId: string; tagId: string }>
```
- Uses `window.electronAPI.delete` to DELETE `/api/documents/{documentId}/tags/{tagId}`
- Same invalidation pattern as assign
- Return type is void (204 no body)

Follow the exact same patterns as existing mutation hooks in `use-documents.ts` (getAuthHeaders, parseApiError, cache invalidation via queryClient).

Note: The `parseApiError` and `getAuthHeaders` helper functions already exist in use-document-tags.ts. Reuse them.
  </action>
  <verify>Run `npx tsc --noEmit` from electron-app/. No type errors in use-document-tags.ts. Grep for `useAssignDocumentTag` and `useUnassignDocumentTag` to confirm exports.</verify>
  <done>Both tag mutation hooks exist with proper auth, API calls, and cache invalidation.</done>
</task>

<task type="auto">
  <name>Task 2: Create DocumentHeader, TagManager, and DocumentStatusBar components</name>
  <files>
    electron-app/src/renderer/components/knowledge/document-header.tsx
    electron-app/src/renderer/components/knowledge/tag-manager.tsx
    electron-app/src/renderer/components/knowledge/document-status-bar.tsx
  </files>
  <action>
**Create `tag-manager.tsx`:**

A component that displays existing tags as badges and provides a popover to add/remove tags.

Props:
```typescript
interface TagManagerProps {
  documentId: string
  tags: DocumentTagRef[]         // from Document type in use-documents.ts
  scope: string                  // for tag query + mutation hooks
  scopeId: string | null
}
```

Imports: `Tag`, `X`, `Plus` from `lucide-react`, `Popover`/`PopoverTrigger`/`PopoverContent` from `@/components/ui/popover`, `useDocumentTags`, `useAssignDocumentTag`, `useUnassignDocumentTag` from `@/hooks/use-document-tags`, `type DocumentTagRef` from `@/hooks/use-documents`.

Structure:
- Display existing tags as inline badges: each badge shows optional color dot (`h-2 w-2 rounded-full` with `style={{ backgroundColor: tag.color }}`), tag name, and X remove button. Badge styling: `inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-muted text-xs`. Remove button calls `unassignMutation.mutate({ documentId, tagId: tag.id })`.
- "+" button opens Popover with available tags (from `useDocumentTags(scope, scopeId)` filtered to exclude already-assigned tag IDs). Each available tag is a clickable row that calls `assignMutation.mutate({ documentId, tagId: tag.id })`.
- If no available tags to add, show "No more tags" in popover.

**Create `document-header.tsx`:**

Props:
```typescript
interface DocumentHeaderProps {
  document: Document  // full Document type from use-documents.ts
  scope: string
  scopeId: string | null
}
```

Imports: `useState`, `useEffect`, `useRef` from `react`, `FolderKanban` from `lucide-react`, `Separator` from `@/components/ui/separator`, `useRenameDocument` from `@/hooks/use-documents`, `useKnowledgeBase` from `@/contexts/knowledge-base-context`, `formatRelativeTime` from `@/lib/time-utils`, `TagManager` from `./tag-manager`.

Structure -- two sections stacked vertically:

**1. Editable Title (top):**
- State: `isEditing: boolean`, `value: string`, `inputRef: useRef<HTMLInputElement>`
- Display mode: `<h1>` with `text-2xl font-bold cursor-pointer hover:text-primary/80 truncate px-6 pt-4 pb-2`. Click sets `isEditing(true)`.
- Edit mode: `<input>` with `text-2xl font-bold bg-transparent border-b border-primary outline-none w-full px-6 pt-4 pb-2 maxLength={255}`. Focus+select on enter edit. Save on blur and Enter. Escape reverts. On save: if value changed and non-empty, call `renameMutation.mutate({ documentId: document.id, title: value.trim(), row_version: document.row_version })`. Also dispatch `updateTabTitle(document.id, value.trim())` to keep tab title in sync.
- Sync: `useEffect` to set `value` from `document.title` when prop changes.

**2. Metadata Bar (below title):**
- Container: `flex items-center gap-3 px-6 py-2 border-b border-border text-sm text-muted-foreground`
- Tags section: `<TagManager documentId={document.id} tags={document.tags} scope={scope} scopeId={scopeId} />`
- Separator: `<Separator orientation="vertical" className="h-4" />`
- Scope badge: `<FolderKanban className="h-3.5 w-3.5" />` + scope label. Derive label: if `document.user_id` and no `application_id`/`project_id` -> "My Notes", if `application_id` -> "Application", if `project_id` -> "Project".
- Separator: `<Separator orientation="vertical" className="h-4" />`
- Last edited: Show "Last edited {formatRelativeTime(document.updated_at)}". If the Document type gains an `updated_by_name` field from Phase 4, show "Last edited by {name} {time}". For now, just show the relative time since `updated_by` does not exist yet. Use a simple fallback: `Last edited ${formatRelativeTime(document.updated_at)}`.

**Create `document-status-bar.tsx`:**

Props:
```typescript
interface DocumentStatusBarProps {
  editor: Editor | null   // from @tiptap/react
  lastSavedAt?: string | null  // ISO date string (document.updated_at)
}
```

Imports: `useMemo` from `react`, `useEditorState` from `@tiptap/react`, `type Editor` from `@tiptap/react`, `formatRelativeTime`, `useRelativeTime` from `@/lib/time-utils`.

Structure:
- Container: `flex items-center justify-between px-6 py-1.5 border-t border-border text-xs text-muted-foreground`
- Left: Word count. Use `useEditorState` with selector to read `editor?.storage.characterCount?.words() ?? 0`. Display as `{count.toLocaleString()} words`.
- Right: Last saved timestamp. Use `useRelativeTime(lastSavedAt)` for auto-updating relative time. Display: `Last saved {relativeTime}` or empty if no lastSavedAt.
- Handle null editor: show "0 words" when editor is null.

NOTE: Phase 4 will add `saveStatus` state to this bar (showing "Saving...", "Save failed", etc.). For now, just show the static last saved time from `document.updated_at`. Phase 4 will enhance this component.

Export all three components as named exports.
  </action>
  <verify>Run `npx tsc --noEmit` from electron-app/. All three new files compile. Check exports: DocumentHeader, TagManager, DocumentStatusBar.</verify>
  <done>DocumentHeader shows editable title + metadata bar (tags with add/remove, scope badge, last edited time). DocumentStatusBar shows word count and last saved. TagManager provides inline tag management with popover.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (zero new errors)
2. `use-document-tags.ts` exports `useAssignDocumentTag` and `useUnassignDocumentTag`
3. `document-header.tsx` exports `DocumentHeader` with editable title and metadata bar
4. `tag-manager.tsx` exports `TagManager` with tag badges and add/remove popover
5. `document-status-bar.tsx` exports `DocumentStatusBar` with word count and last saved
6. Title rename dispatches `updateTabTitle` to keep tab bar in sync
</verification>

<success_criteria>
- DocumentHeader renders editable title (click-to-rename with blur/Enter save, Escape revert)
- MetadataBar shows tags (with add/remove via popover), scope badge, and last edited time
- DocumentStatusBar shows word count from CharacterCount extension and last saved timestamp
- Tag assignment hooks call correct backend endpoints with cache invalidation
- Title rename updates tab title via context action
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-tabs-editor-ui-integration/06-02-SUMMARY.md`
</output>
