---
phase: 06-document-tabs-editor-ui-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - electron-app/src/renderer/components/knowledge/document-header.tsx
  - electron-app/src/renderer/components/knowledge/document-status-bar.tsx
  - electron-app/src/renderer/components/knowledge/tag-manager.tsx
  - electron-app/src/renderer/components/knowledge/document-editor.tsx
autonomous: true

must_haves:
  truths:
    - "Document title is displayed as an h1 and becomes an inline input on click for renaming"
    - "Metadata bar shows assigned tags with add/remove capability via popover"
    - "Metadata bar shows scope badge and last edited relative timestamp"
    - "Status bar shows word count and reuses the existing SaveStatus component for save state"
    - "Internal EditorStatusBar is removed from document-editor.tsx (no duplicate status bars)"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/document-header.tsx"
      provides: "Editable title (click-to-rename) and metadata bar (tags, scope, last edited)"
      contains: "EditableTitle"
    - path: "electron-app/src/renderer/components/knowledge/document-status-bar.tsx"
      provides: "Word count + SaveStatus display"
      contains: "DocumentStatusBar"
    - path: "electron-app/src/renderer/components/knowledge/tag-manager.tsx"
      provides: "Tag add/remove popover for metadata bar"
      contains: "TagManager"
    - path: "electron-app/src/renderer/components/knowledge/document-editor.tsx"
      provides: "Editor without internal EditorStatusBar"
  key_links:
    - from: "document-header.tsx"
      to: "use-documents.ts"
      via: "useRenameDocument hook"
      pattern: "useRenameDocument"
    - from: "tag-manager.tsx"
      to: "use-document-tags.ts"
      via: "useAssignDocumentTag and useUnassignDocumentTag hooks"
      pattern: "useAssignDocumentTag"
    - from: "document-status-bar.tsx"
      to: "SaveStatus.tsx"
      via: "SaveStatus component import"
      pattern: "SaveStatus"
---

<objective>
Build the document header (editable title + metadata bar), tag management popover, and status bar components. Remove the internal EditorStatusBar from document-editor.tsx.

Purpose: These components provide the UI elements that surround the editor -- title editing (UI-06), metadata display with tag management (UI-07), and the bottom status bar with word count and save status (UI-09). They will be composed into the DocumentPanel in Plan 03.

Output: Four component files -- DocumentHeader, TagManager, DocumentStatusBar -- and a modified DocumentEditor without its internal status bar.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-document-tabs-editor-ui-integration/06-RESEARCH.md
@electron-app/src/renderer/components/knowledge/document-editor.tsx
@electron-app/src/renderer/components/knowledge/editor-types.ts
@electron-app/src/renderer/components/knowledge/SaveStatus.tsx
@electron-app/src/renderer/components/knowledge/tag-filter-list.tsx
@electron-app/src/renderer/hooks/use-documents.ts
@electron-app/src/renderer/hooks/use-document-tags.ts
@electron-app/src/renderer/hooks/use-auto-save.ts
@electron-app/src/renderer/lib/time-utils.ts
@electron-app/src/renderer/components/ui/popover.tsx
@electron-app/src/renderer/components/ui/separator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build DocumentHeader with editable title and metadata bar</name>
  <files>
    electron-app/src/renderer/components/knowledge/document-header.tsx
    electron-app/src/renderer/components/knowledge/tag-manager.tsx
  </files>
  <action>
Create two new components: DocumentHeader (editable title + metadata row) and TagManager (tag add/remove popover).

**document-header.tsx:**

Props interface:
```typescript
interface DocumentHeaderProps {
  document: {
    id: string
    title: string
    row_version: number
    application_id: string | null
    project_id: string | null
    user_id: string | null
    tags: Array<{ id: string; name: string; color: string | null }>
    updated_at: string
  }
}
```

The component has two sections stacked vertically:

**Section 1: Editable Title (top)**
- Create an internal `EditableTitle` sub-component (or use useState within DocumentHeader)
- Display title as an `h1` element (`text-2xl font-bold cursor-pointer hover:text-primary/80 truncate`)
- On click, switch to an `<input>` element (`text-2xl font-bold bg-transparent border-b border-primary outline-none w-full px-0`, maxLength 255)
- Auto-focus and select all text when entering edit mode (`inputRef.current?.select()`)
- On blur or Enter: if value is non-empty and changed, call `useRenameDocument(scope, scopeId).mutate({ documentId, title, row_version })`. On success, call `updateTabTitle(documentId, newTitle)` from KnowledgeBaseContext.
- On Escape: revert to original title, exit edit mode
- If value is empty or unchanged, revert without calling API
- Sync external title changes via `useEffect(() => setValue(title), [title])`

**Scope resolution helper (define at top of file or inline):**
```typescript
function deriveDocumentScope(doc: {
  application_id: string | null
  project_id: string | null
  user_id: string | null
}): { scope: string; scopeId: string } {
  if (doc.application_id) return { scope: 'application', scopeId: doc.application_id }
  if (doc.project_id) return { scope: 'project', scopeId: doc.project_id }
  if (doc.user_id) return { scope: 'personal', scopeId: doc.user_id }
  throw new Error('Document has no scope FK set')
}
```

**Section 2: Metadata Bar (below title)**
- Horizontal flex row: `flex items-center gap-3 text-sm text-muted-foreground py-2`
- Left side items separated by Separator (vertical, `@/components/ui/separator`):
  1. **Tags section:** Render assigned tags as small badges (matching `tag-filter-list.tsx` pattern: colored dot + name). After the tags, render the `TagManager` popover component (see below).
  2. **Scope badge:** Show scope type as a text badge. Derive from document FK fields:
     - `application_id` set -> "Application"
     - `project_id` set -> "Project"
     - `user_id` set -> "Personal"
     Use FolderKanban icon for application, Briefcase/FolderOpen for project, User icon for personal (from lucide-react).
  3. **Last edited:** Show "Last edited {relative time}" using `useRelativeTime(document.updated_at)` from `@/lib/time-utils.ts`. Do NOT show editor name (the Document model has no `updated_by` field -- this is a known gap documented in research).

**tag-manager.tsx:**

Props interface:
```typescript
interface TagManagerProps {
  documentId: string
  assignedTagIds: string[]
  scope: string
  scopeId: string
}
```

Implementation:
- Render a button trigger (Plus icon + "Add tag" text, or just a Plus icon) that opens a Popover (`@/components/ui/popover`)
- Inside the popover:
  - Use `useDocumentTags(scope, scopeId)` to fetch all available tags for the scope
  - Filter out already-assigned tags (compare with `assignedTagIds`)
  - Render available tags as clickable items (colored dot + name, matching tag-filter-list.tsx pattern)
  - On click: call `useAssignDocumentTag(documentId).mutate(tagId)` (from Plan 01's new hooks)
  - Below the available tags list, show assigned tags with an X button to unassign
  - On unassign click: call `useUnassignDocumentTag(documentId).mutate(tagId)`
- If no tags exist for the scope, show a "No tags available" message
- Close popover after successful assignment (optional -- can stay open for multi-assign)

**Styling notes:**
- Tag badges: `inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs bg-muted`
- Color dot: `h-2 w-2 rounded-full` with `backgroundColor` set to `tag.color || '#6b7280'` (gray-500 default, matching tag-filter-list.tsx)
  </action>
  <verify>
Run `npx tsc --noEmit` from electron-app/ to verify no type errors. Grep for `EditableTitle` or `DocumentHeader` and `TagManager` in the new files to confirm exports. Grep for `deriveDocumentScope` to confirm scope resolution exists.
  </verify>
  <done>
DocumentHeader renders an editable title (click-to-rename with API save) and a metadata bar showing tags (with add/remove via TagManager popover), scope badge, and "last edited" relative timestamp.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build DocumentStatusBar and remove internal EditorStatusBar</name>
  <files>
    electron-app/src/renderer/components/knowledge/document-status-bar.tsx
    electron-app/src/renderer/components/knowledge/document-editor.tsx
  </files>
  <action>
Create the new DocumentStatusBar component and remove the duplicate internal EditorStatusBar from document-editor.tsx.

**document-status-bar.tsx:**

Props interface:
```typescript
import type { Editor } from '@tiptap/core'
import type { SaveStatus as SaveStatusType } from '@/hooks/use-auto-save'

interface DocumentStatusBarProps {
  editor: Editor | null
  saveStatus: SaveStatusType
}
```

Implementation:
- Horizontal bar at the bottom: `flex items-center justify-between px-6 py-1.5 border-t border-border text-xs text-muted-foreground`
- Left side: word count using `useEditorState` from `@tiptap/react`:
  ```typescript
  const { wordCount } = useEditorState({
    editor,
    selector: (ctx) => ({
      wordCount: ctx.editor?.storage.characterCount?.words() ?? 0,
    }),
  }) ?? { wordCount: 0 }
  ```
  Display as `{wordCount.toLocaleString()} words`
- Right side: Reuse the existing `SaveStatus` component from `@/components/knowledge/SaveStatus` -- import and render with `status={saveStatus}`
- If `editor` is null, render a placeholder bar with "0 words" and no save status
- Export `DocumentStatusBar` as named export and export `DocumentStatusBarProps` as type export

**Modify document-editor.tsx:**

1. **Remove the entire `EditorStatusBar` sub-component** (lines 24-38 of current file -- the function definition)
2. **Remove the `<EditorStatusBar editor={editor} />` rendering** (line 134 of current file, inside the return JSX)
3. **Remove the `useEditorState` import** from the `@tiptap/react` import line IF it is no longer used elsewhere in the file (check first -- it may only be used by EditorStatusBar). Keep `useEditor` and `EditorContent`.
4. **Keep everything else unchanged** -- the editor, toolbar, lock banner, debounce logic all stay as-is

**Important:** The DocumentStatusBar will be rendered by DocumentPanel (Plan 03), NOT by DocumentEditor. This is intentional separation -- the status bar needs access to `saveStatus` which comes from `useAutoSave`, not from within the editor component.
  </action>
  <verify>
Run `npx tsc --noEmit` from electron-app/ to verify no type errors. Grep for `EditorStatusBar` in document-editor.tsx -- it should NOT appear. Grep for `DocumentStatusBar` in the new file to confirm export exists. Verify document-editor.tsx still exports DocumentEditor.
  </verify>
  <done>
DocumentStatusBar shows word count (from CharacterCount extension) and save status (reusing SaveStatus component). The internal EditorStatusBar has been removed from document-editor.tsx to prevent duplication.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` from electron-app/ passes with zero errors
2. DocumentHeader exports and contains editable title + metadata bar
3. TagManager exports and uses useAssignDocumentTag/useUnassignDocumentTag from Plan 01
4. DocumentStatusBar exports and composes useEditorState + SaveStatus
5. document-editor.tsx no longer contains EditorStatusBar (grep confirms zero matches)
6. deriveDocumentScope helper exists for scope resolution
</verification>

<success_criteria>
- Editable title saves via useRenameDocument and syncs tab title via updateTabTitle
- Metadata bar displays tags, scope badge, and relative "last edited" timestamp
- Tag popover allows adding existing tags and removing assigned tags
- Status bar displays word count reactively and reuses SaveStatus for save state
- No duplicate status bars exist in the editor component tree
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-tabs-editor-ui-integration/06-02-SUMMARY.md`
</output>
