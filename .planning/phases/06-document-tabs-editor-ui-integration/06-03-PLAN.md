---
phase: 06-document-tabs-editor-ui-integration
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - electron-app/src/renderer/components/knowledge/document-panel.tsx
  - electron-app/src/renderer/pages/notes/index.tsx
  - electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Opening a document shows the tab bar at top, editable title, metadata bar, editor, and status bar"
    - "Switching tabs remounts the editor with the new document's content (no flash of old content)"
    - "Selecting a document from the sidebar opens it as a tab and shows it in the editor area"
    - "When no document is open, an empty state placeholder is shown"
    - "Tab bar persists above the content area while switching between documents"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/document-panel.tsx"
      provides: "Main content panel composing DocumentHeader, DocumentEditor, and DocumentStatusBar"
      exports: ["DocumentPanel"]
    - path: "electron-app/src/renderer/pages/notes/index.tsx"
      provides: "Updated Notes page integrating DocumentTabBar and DocumentPanel"
      contains: "DocumentTabBar"
    - path: "electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx"
      provides: "Updated sidebar that opens tabs when clicking documents"
      contains: "openTab"
  key_links:
    - from: "document-panel.tsx"
      to: "knowledge-base-context.tsx"
      via: "useKnowledgeBase for activeTabId, openTab"
      pattern: "useKnowledgeBase"
    - from: "document-panel.tsx"
      to: "use-documents.ts"
      via: "useDocument(activeTabId) for document data"
      pattern: "useDocument"
    - from: "document-panel.tsx"
      to: "document-editor.tsx"
      via: "key={activeTabId} for editor remount on tab switch"
      pattern: "key=.*activeTabId"
    - from: "notes/index.tsx"
      to: "document-tab-bar.tsx"
      via: "DocumentTabBar rendered above DocumentPanel"
      pattern: "DocumentTabBar"
    - from: "knowledge-sidebar.tsx"
      to: "knowledge-base-context.tsx"
      via: "openTab dispatched when user clicks a document node"
      pattern: "openTab"
---

<objective>
Create the DocumentPanel component that composes the editor area, and wire everything together in the Notes page layout.

Purpose: This plan integrates all Phase 6 components (tab bar, header, editor, status bar) into a cohesive Notes screen, completing UI-04 through UI-09. It also updates the sidebar to open tabs when documents are clicked.

Output: DocumentPanel component, updated NotesPage layout, updated sidebar with tab-opening behavior.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-document-tabs-editor-ui-integration/06-RESEARCH.md
@.planning/phases/06-document-tabs-editor-ui-integration/06-01-SUMMARY.md
@.planning/phases/06-document-tabs-editor-ui-integration/06-02-SUMMARY.md
@electron-app/src/renderer/pages/notes/index.tsx
@electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
@electron-app/src/renderer/components/knowledge/document-editor.tsx
@electron-app/src/renderer/contexts/knowledge-base-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DocumentPanel component</name>
  <files>electron-app/src/renderer/components/knowledge/document-panel.tsx</files>
  <action>
Create the main content panel that renders the active document with header, editor, and status bar.

Imports: `useEffect` from `react`, `FileText` from `lucide-react`, `useKnowledgeBase` from `@/contexts/knowledge-base-context`, `useDocument` from `@/hooks/use-documents`, `DocumentHeader` from `./document-header`, `DocumentEditor` from `./document-editor`, `DocumentStatusBar` from `./document-status-bar`, `Skeleton` from `@/components/ui/skeleton`.

**Empty State:**
When `activeTabId` is null, render a centered placeholder:
```
<div className="flex-1 flex flex-col items-center justify-center text-muted-foreground gap-3">
  <FileText className="h-12 w-12 text-muted-foreground/30" />
  <p className="text-sm">Select a document to start editing</p>
</div>
```

**Active Document State:**
When `activeTabId` is set:

1. Fetch document data: `const { data: document, isLoading } = useDocument(activeTabId)`.

2. Resolve scope from document data:
   - `document.user_id && !document.application_id && !document.project_id` -> scope='personal', scopeId=document.user_id
   - `document.project_id` -> scope='project', scopeId=document.project_id
   - `document.application_id` -> scope='application', scopeId=document.application_id

3. **Tab sync effect:** When document data loads, dispatch `openTab(document.id, document.title)` to ensure a tab exists for this document (handles the case where `SELECT_DOCUMENT` fires from sidebar but tab wasn't opened yet because title wasn't available). Also dispatch `updateTabTitle(document.id, document.title)` to keep tab title fresh.

4. Loading state: If `isLoading`, show skeleton placeholders (title skeleton + content skeleton area).

5. **CRITICAL: Use `key={activeTabId}` on the main document container.** This forces React to fully remount the editor when switching tabs, which:
   - Destroys the old TipTap editor instance
   - Creates a fresh editor with new content
   - Resets any editor-local state (undo history, cursor)
   - Prevents flash of old content

6. Layout structure:
```tsx
<div key={activeTabId} className="flex-1 flex flex-col h-full min-w-0">
  <DocumentHeader document={document} scope={resolvedScope} scopeId={resolvedScopeId} />
  <div className="flex-1 overflow-auto">
    <DocumentEditor
      content={document.content_json ? JSON.parse(document.content_json) : undefined}
      editable={true}
    />
  </div>
  <DocumentStatusBar editor={null} lastSavedAt={document.updated_at} />
</div>
```

**Note on editor instance:** The DocumentStatusBar needs an editor instance for word count. The DocumentEditor component currently does not expose the editor ref. For now, pass `editor={null}` to DocumentStatusBar -- the word count will show 0. Phase 4 or a future integration plan will wire the editor instance through (either via a ref callback from DocumentEditor or by lifting editor creation to DocumentPanel). This is acceptable because the word count displays "0 words" gracefully when editor is null, and the full wiring requires changes to DocumentEditor that are beyond this plan's scope.

**Alternative approach (preferred if straightforward):** If DocumentEditor already accepts a ref or exposes the editor via a callback prop, use it. Check the `document-editor.tsx` component. If it uses `useEditor` internally and doesn't expose it, add an optional `onEditorReady?: (editor: Editor) => void` callback prop to DocumentEditor that fires in a useEffect when the editor instance is created. Store the editor in DocumentPanel's local state and pass it to DocumentStatusBar. Only do this if it's clean (1-2 lines in DocumentEditor). If it requires significant refactoring, defer to Phase 4.

Export `DocumentPanel` as a named export.
  </action>
  <verify>Run `npx tsc --noEmit` from electron-app/. document-panel.tsx compiles. Grep for `key=.*activeTabId` to confirm remount pattern.</verify>
  <done>DocumentPanel renders empty state when no tab active, loading skeleton while fetching, and full document view (header + editor + status bar) with key-based remounting on tab switch.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Notes page layout and update sidebar</name>
  <files>
    electron-app/src/renderer/pages/notes/index.tsx
    electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
  </files>
  <action>
**Update `notes/index.tsx`:**

Replace the current placeholder main content area with DocumentTabBar + DocumentPanel.

Remove: The `FileText` import and the placeholder `<main>` section with the "Select a document to start editing" message (this is now in DocumentPanel's empty state).

Add imports: `DocumentTabBar` from `@/components/knowledge/document-tab-bar`, `DocumentPanel` from `@/components/knowledge/document-panel`.

New layout (replacing the current `<main>` section):
```tsx
<div className="flex-1 flex flex-col h-full min-w-0">
  <DocumentTabBar />
  <DocumentPanel />
</div>
```

The `min-w-0` prevents flex overflow when document titles are very long. The tab bar sits above the document panel. The tab bar does NOT remount when switching tabs (it stays persistent). Only the DocumentPanel content remounts via `key={activeTabId}`.

Keep the KnowledgeBaseProvider wrapper and KnowledgeSidebar unchanged.

**Update `knowledge-sidebar.tsx`:**

Find where documents are clicked/selected in the sidebar (the `selectDocument` callback). Wherever the sidebar calls `selectDocument(documentId)`, it should ALSO call `openTab(documentId, title)` to ensure a tab is opened.

Read the current sidebar code to find exactly where document selection happens. It likely occurs in:
- A document node click handler
- The folder tree's document click handler
- A search result click handler

For each location:
1. Import `useKnowledgeBase` (already imported, just add `openTab` destructuring)
2. Where `selectDocument(doc.id)` is called, add `openTab(doc.id, doc.title)` right before it

The `openTab` dispatches `OPEN_TAB` which also sets `selectedDocumentId`, so calling both `openTab` and `selectDocument` is technically redundant (both set selectedDocumentId). However, calling `openTab` alone is sufficient -- it sets both `activeTabId` and `selectedDocumentId`. So you can REPLACE `selectDocument(doc.id)` calls with `openTab(doc.id, doc.title)` where the title is available.

If the sidebar uses `selectDocument` without having access to the document title (e.g., only has an ID), keep `selectDocument(id)` and let the DocumentPanel's useEffect handle tab opening when it loads the document data.
  </action>
  <verify>Run `npx tsc --noEmit` from electron-app/. notes/index.tsx and knowledge-sidebar.tsx compile. The old placeholder is removed from notes/index.tsx. DocumentTabBar and DocumentPanel are rendered in the layout.</verify>
  <done>Notes page shows sidebar | tab bar + document panel layout. Clicking a document in sidebar opens a tab and shows the document. Empty state shown when no document is selected. Tab bar persists above content while switching documents.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (zero new errors)
2. notes/index.tsx renders DocumentTabBar and DocumentPanel (no more FileText placeholder)
3. document-panel.tsx uses `key={activeTabId}` for editor remounting
4. document-panel.tsx fetches document data via useDocument and passes to DocumentHeader/Editor/StatusBar
5. Sidebar dispatches openTab when user clicks a document
6. Empty state shown when activeTabId is null
7. Loading skeleton shown while document data is fetching
</verification>

<success_criteria>
- Complete Notes screen: sidebar + tab bar + document header + editor + status bar
- Tab switching remounts editor (key pattern)
- Document selection from sidebar opens a tab
- Empty state when no document open
- All components compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-tabs-editor-ui-integration/06-03-SUMMARY.md`
</output>
