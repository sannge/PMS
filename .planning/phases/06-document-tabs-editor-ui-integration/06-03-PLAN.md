---
phase: 06-document-tabs-editor-ui-integration
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - electron-app/src/renderer/components/knowledge/document-panel.tsx
  - electron-app/src/renderer/components/knowledge/editor-types.ts
  - electron-app/src/renderer/components/knowledge/document-editor.tsx
  - electron-app/src/renderer/pages/notes/index.tsx
  - electron-app/src/renderer/components/knowledge/folder-tree.tsx
autonomous: true

must_haves:
  truths:
    - "User can open multiple documents as tabs and switch between them"
    - "Switching tabs remounts the editor with fresh content (key-based remount)"
    - "Tab dirty dot syncs with auto-save isDirty state"
    - "Notes page shows tab bar above the document panel"
    - "Clicking a document in the sidebar opens a tab (not just selects)"
    - "Creating a new document from sidebar opens a tab for it"
    - "Empty state shown when no tabs are open"
    - "Word count and save status visible in bottom bar"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/document-panel.tsx"
      provides: "Main content compositor (header + editor + status bar) with key-based remount"
      contains: "DocumentPanel"
    - path: "electron-app/src/renderer/pages/notes/index.tsx"
      provides: "Notes page with DocumentTabBar + DocumentPanel layout"
      contains: "DocumentTabBar"
    - path: "electron-app/src/renderer/components/knowledge/folder-tree.tsx"
      provides: "Sidebar doc click calls openTab instead of selectDocument"
      contains: "openTab"
  key_links:
    - from: "document-panel.tsx"
      to: "knowledge-base-context.tsx"
      via: "useKnowledgeBase().activeTabId for key-based remount"
      pattern: "key=.*activeTabId"
    - from: "document-panel.tsx"
      to: "use-auto-save.ts"
      via: "useAutoSave hook for dirty sync and save status"
      pattern: "useAutoSave"
    - from: "folder-tree.tsx"
      to: "knowledge-base-context.tsx"
      via: "openTab() call on document click"
      pattern: "openTab"
    - from: "notes/index.tsx"
      to: "document-tab-bar.tsx"
      via: "DocumentTabBar component import"
      pattern: "DocumentTabBar"
    - from: "notes/index.tsx"
      to: "document-panel.tsx"
      via: "DocumentPanel component import"
      pattern: "DocumentPanel"
---

<objective>
Create the DocumentPanel compositor, wire it into the Notes page layout with DocumentTabBar, and update the sidebar to open tabs on document click.

Purpose: This is the integration plan that brings everything together. It composes the editor, header, status bar, and auto-save into a single panel view, wires tabs into the Notes page, and makes the sidebar open tabs. After this plan, the entire Phase 6 feature is functional end-to-end.

Output: Working Notes page with browser-style tabs, full editor integration, and sidebar-to-tab wiring.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-document-tabs-editor-ui-integration/06-RESEARCH.md
@electron-app/src/renderer/pages/notes/index.tsx
@electron-app/src/renderer/components/knowledge/folder-tree.tsx
@electron-app/src/renderer/components/knowledge/document-editor.tsx
@electron-app/src/renderer/components/knowledge/editor-types.ts
@electron-app/src/renderer/hooks/use-documents.ts
@electron-app/src/renderer/hooks/use-auto-save.ts
@electron-app/src/renderer/hooks/use-document-lock.ts
@electron-app/src/renderer/contexts/knowledge-base-context.tsx
@electron-app/src/renderer/contexts/auth-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DocumentPanel compositor with key-based remount</name>
  <files>
    electron-app/src/renderer/components/knowledge/document-panel.tsx
    electron-app/src/renderer/components/knowledge/editor-types.ts
    electron-app/src/renderer/components/knowledge/document-editor.tsx
  </files>
  <action>
Create the DocumentPanel component that composes DocumentHeader, DocumentEditor, and DocumentStatusBar into a single view for the active tab's document.

**DocumentPanel (exported):**

This is a wrapper component that reads `activeTabId` from context and renders the appropriate view.

```typescript
export function DocumentPanel(): JSX.Element {
  const { activeTabId } = useKnowledgeBase()

  if (!activeTabId) {
    return <EmptyState />
  }

  // key={activeTabId} forces full remount when switching tabs.
  // This destroys the old TipTap editor, creates a fresh one with new content,
  // resets auto-save timers, dirty state, and undo history.
  return (
    <div key={activeTabId} className="flex-1 flex flex-col h-full min-w-0">
      <ActiveDocumentView documentId={activeTabId} />
    </div>
  )
}
```

**EmptyState (internal):**
- Center-aligned placeholder: FileText icon (h-12 w-12, text-muted-foreground/30) + "Select or create a document to start editing" text
- Match existing placeholder style from current notes/index.tsx

**ActiveDocumentView (internal, the main composition):**

Props: `{ documentId: string }`

Implementation:
1. **Fetch document data:** `const { data: document, isLoading, error } = useDocument(documentId)`
2. **Auth context:** Get userId, userName from auth context (for lock and editor props)
3. **Auto-save setup:**
   ```typescript
   const editorRef = useRef<Editor | null>(null)

   const { isDirty, saveNow, saveStatus } = useAutoSave({
     documentId,
     editor: editorRef.current,
     rowVersion: document.row_version,
   })
   ```
   The `useAutoSave` hook tracks the editor internally via the `editor` param -- it calls `editor.getJSON()` on update events and compares against `lastSavedRef`. The `onChange` callback from DocumentEditor should NOT call any content-setting state (no `setEditorContent`). The hook listens to editor's `update` event directly for debounced saves.

   Wire `onEditorReady` to store the editor instance in `editorRef`:
   ```typescript
   const handleEditorReady = useCallback((editor: Editor) => {
     editorRef.current = editor
   }, [])
   ```

4. **Tab dirty sync:** Sync auto-save dirty/clean state to tab bar:
   ```typescript
   const { setTabDirty } = useKnowledgeBase()

   // Mark tab clean when save completes
   useEffect(() => {
     if (saveStatus.state === 'saved') {
       setTabDirty(documentId, false)
     }
   }, [saveStatus, documentId, setTabDirty])
   ```

   Mark tab dirty in the content change handler (see **Content change handler** below):
   ```typescript
   const handleContentChange = useCallback((json: object) => {
     setTabDirty(documentId, true)
   }, [documentId, setTabDirty])
   ```
   Note: `handleContentChange` does NOT need to store `json` in state -- `useAutoSave` tracks content internally via the editor instance. The only purpose of `onChange` here is to mark the tab dirty.

5. **Save lifecycle hooks:**
   - `useSaveOnUnmount(saveNow)` -- saves when tab switches (editor remounts)
   - `useSaveOnQuit(saveNow)` -- saves before Electron quit

6. **Loading state:** While `useDocument` is loading, show Skeleton placeholder
7. **Error state:** If document fetch fails, show error message

8. **Render layout (when document data is available):**
   ```jsx
   <div className="flex-1 flex flex-col h-full overflow-hidden">
     <DocumentHeader document={document} />
     <div className="flex-1 overflow-y-auto">
       <DocumentEditor
         content={document.content_json}
         onChange={handleContentChange}
         onEditorReady={handleEditorReady}
         editable={true}
         placeholder="Start writing..."
         documentId={documentId}
         userId={userId}
         userName={userName}
         userRole={userRole}
         onSaveNow={saveNow}
       />
     </div>
     <DocumentStatusBar editor={editorRef.current} saveStatus={saveStatus} />
   </div>
   ```

**CRITICAL implementation detail -- editor ref for status bar:**
The DocumentEditor currently does not expose an editor ref. There are two options:
- Option A: Add an `onEditorReady?: (editor: Editor) => void` callback prop to DocumentEditorProps (in editor-types.ts) and call it when editor is created. ActiveDocumentView stores it in a ref.
- Option B: Have DocumentStatusBar accept `documentId` and use its own editor tracking.

Use Option A -- it is simpler and follows the existing pattern. Add `onEditorReady` to `DocumentEditorProps` in `editor-types.ts` and call it in `document-editor.tsx` via a useEffect after editor creation:
```typescript
useEffect(() => {
  if (editor && onEditorReady) {
    onEditorReady(editor)
  }
}, [editor, onEditorReady])
```

Also modify `editor-types.ts` to add:
```typescript
/** Callback when TipTap editor instance is ready */
onEditorReady?: (editor: Editor) => void
```

**Content change handler** (already shown above in Tab dirty sync):
```typescript
const handleContentChange = useCallback((json: object) => {
  setTabDirty(documentId, true)
}, [documentId, setTabDirty])
```

**Import list:**
- DocumentHeader from `./document-header`
- DocumentEditor from `./document-editor`
- DocumentStatusBar from `./document-status-bar`
- useKnowledgeBase from `@/contexts/knowledge-base-context`
- useDocument from `@/hooks/use-documents`
- useAutoSave, useSaveOnUnmount, useSaveOnQuit from `@/hooks/use-auto-save`
- useAuthStore from `@/contexts/auth-context`
- FileText from `lucide-react`
- Skeleton from `@/components/ui/skeleton`
  </action>
  <verify>
Run `npx tsc --noEmit` from electron-app/ to verify no type errors. Grep for `DocumentPanel` in the new file to confirm export. Grep for `key=.*activeTabId` or `key={activeTabId}` in the file to confirm key-based remount pattern. Grep for `useAutoSave` to confirm auto-save integration. Grep for `onEditorReady` in editor-types.ts and document-editor.tsx to confirm the prop is added and called.
  </verify>
  <done>
DocumentPanel composes header + editor + status bar with key-based remount on tab switch. Auto-save is wired with dirty sync to tab bar. Save-on-unmount and save-on-quit are active. Loading and empty states are handled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Notes page layout and sidebar tab-opening behavior</name>
  <files>
    electron-app/src/renderer/pages/notes/index.tsx
    electron-app/src/renderer/components/knowledge/folder-tree.tsx
  </files>
  <action>
Update the Notes page to render tabs + panel, and update the sidebar to open tabs on document click.

**notes/index.tsx -- Replace placeholder with tab bar + panel:**

Replace the entire `<main>` section (lines 36-41) with:
```jsx
<div className="flex-1 flex flex-col h-full min-w-0">
  <DocumentTabBar />
  <DocumentPanel />
</div>
```

Add imports:
- `DocumentTabBar` from `@/components/knowledge/document-tab-bar`
- `DocumentPanel` from `@/components/knowledge/document-panel`

Remove the `FileText` import from lucide-react (no longer used in this file).

The `<main>` wrapper is removed -- the right side is now a flex column with tab bar on top and panel filling the rest.

**folder-tree.tsx -- Update document selection to open tabs:**

1. Add `openTab` to the destructured values from `useKnowledgeBase()` (it already destructures many values from the hook).

2. **Modify `handleSelectDocument`** (currently at line 252):
   - Change signature from `(documentId: string)` to `(documentId: string, title: string)`
   - Replace `selectDocument(documentId)` with `openTab(documentId, title)`
   - Keep `selectFolder(null)` call

   Updated:
   ```typescript
   const handleSelectDocument = useCallback(
     (documentId: string, title: string) => {
       openTab(documentId, title)
       selectFolder(null)
     },
     [openTab, selectFolder]
   )
   ```

3. **Update all call sites of `handleSelectDocument`** to pass the document title:
   - In `renderDocumentItem` (around line 323): the callback receives the full `doc` object which has `doc.title`. Change `onSelect={() => handleSelectDocument(doc.id)}` to `onSelect={() => handleSelectDocument(doc.id, doc.title)}`.
   - Search for any other call sites of `handleSelectDocument` in the file and update them similarly.

4. **Update `handleNewDocument` and similar document creation handlers** (around line 175):
   - After successful creation (`onSuccess`), call `openTab(data.id, data.title)` instead of just `selectDocument(data.id)` so the new document opens as a tab.
   - Keep the rename logic (`setRenamingItemId(data.id)`) as-is.

5. **Update `handleCreateFirstDocument`** (around line 264):
   - Same change: in onSuccess, replace `selectDocument(data.id)` with `openTab(data.id, data.title || 'Untitled')`.

  </action>
  <verify>
Run `npx tsc --noEmit` from electron-app/ to verify no type errors. Grep for `DocumentTabBar` in notes/index.tsx to confirm tab bar is rendered. Grep for `openTab` in folder-tree.tsx to confirm sidebar uses tab opening.
  </verify>
  <done>
Notes page renders DocumentTabBar + DocumentPanel. Sidebar document clicks open tabs. New document creation opens tabs. The complete Phase 6 feature is functional end-to-end.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` from electron-app/ passes with zero errors
2. Notes page renders tab bar above document panel (no placeholder)
3. Clicking a document in sidebar creates a tab AND shows the document
4. Creating a new document from sidebar creates a tab for it
5. Switching tabs remounts the editor (key-based) with correct document content
6. Tab dirty dot appears when content is modified and clears after save
7. Word count and save status visible in bottom bar
8. Empty state shown when no tabs are open
9. No `FileText` import remains in notes/index.tsx (placeholder removed)
</verification>

<success_criteria>
- User can open multiple documents as tabs and switch between them
- Tab bar persists across navigation (not remounted on tab switch)
- Editor remounts cleanly on tab switch with fresh content and undo history
- Dirty indicator syncs: content change -> dirty dot, save complete -> dot clears
- Sidebar document click opens a tab (not just highlights)
- New document creation opens a tab
- Word count updates reactively in status bar
- Save status (Saving.../Saved Xs ago/Save failed) visible in status bar
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-tabs-editor-ui-integration/06-03-SUMMARY.md`
</output>
