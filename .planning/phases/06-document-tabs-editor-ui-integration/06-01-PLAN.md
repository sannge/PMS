---
phase: 06-document-tabs-editor-ui-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - electron-app/src/renderer/contexts/knowledge-base-context.tsx
  - electron-app/src/renderer/components/knowledge/document-tab-bar.tsx
  - electron-app/src/renderer/components/knowledge/document-tab-item.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a document in the sidebar opens it as a tab in the tab bar"
    - "Clicking a tab switches the active document (activeTabId updates)"
    - "Closing a tab removes it and activates an adjacent tab"
    - "Tab state (open tabs and active tab) persists across page navigation via localStorage"
    - "Middle-clicking a tab closes it"
  artifacts:
    - path: "electron-app/src/renderer/contexts/knowledge-base-context.tsx"
      provides: "Tab state management (openTabs, activeTabId) with OPEN_TAB, CLOSE_TAB, SET_ACTIVE_TAB, SET_TAB_DIRTY, UPDATE_TAB_TITLE, CLOSE_OTHER_TABS, CLOSE_ALL_TABS actions"
      contains: "OPEN_TAB"
    - path: "electron-app/src/renderer/components/knowledge/document-tab-bar.tsx"
      provides: "Browser-style tab bar rendering openTabs with scroll overflow"
      exports: ["DocumentTabBar"]
    - path: "electron-app/src/renderer/components/knowledge/document-tab-item.tsx"
      provides: "Individual tab with dirty indicator dot, close button, middle-click, tooltip"
      exports: ["DocumentTabItem"]
  key_links:
    - from: "document-tab-bar.tsx"
      to: "knowledge-base-context.tsx"
      via: "useKnowledgeBase hook for openTabs, activeTabId, setActiveTab, closeTab"
      pattern: "useKnowledgeBase"
    - from: "knowledge-base-context.tsx"
      to: "localStorage"
      via: "Persist openTabs and activeTabId to kb-open-tabs and kb-active-tab keys"
      pattern: "kb-open-tabs|kb-active-tab"
---

<objective>
Extend KnowledgeBaseContext with tab state management and build the DocumentTabBar + DocumentTabItem components.

Purpose: This plan creates the foundation for multi-document tab support (UI-04, UI-05). Tab state in KnowledgeBaseContext ensures activeTabId and selectedDocumentId stay in sync (they represent the same concept). The tab bar component provides browser-style UX with close buttons, dirty indicators, and tooltip titles.

Output: Modified knowledge-base-context.tsx with tab actions + two new tab bar components.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@electron-app/src/renderer/contexts/knowledge-base-context.tsx
@.planning/phases/06-document-tabs-editor-ui-integration/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend KnowledgeBaseContext with tab state and actions</name>
  <files>electron-app/src/renderer/contexts/knowledge-base-context.tsx</files>
  <action>
Extend the existing KnowledgeBaseContext with tab management state and actions. This is a MODIFY of the existing file, not a rewrite.

**New types to add:**

```typescript
interface TabItem {
  id: string       // document ID (primary key)
  title: string    // cached display title
  isDirty: boolean // unsaved changes indicator
}
```

**Add to KnowledgeBaseUIState:**
- `openTabs: TabItem[]`
- `activeTabId: string | null`

**New localStorage keys (add as constants):**
- `STORAGE_KEY_TABS = 'kb-open-tabs'`
- `STORAGE_KEY_ACTIVE_TAB = 'kb-active-tab'`

**Add persistence helpers:**
- `loadTabs(): TabItem[]` -- parse JSON from localStorage, strip isDirty (always false on load)
- `loadActiveTab(): string | null` -- read from localStorage

**New reducer action types to add to the union:**
- `{ type: 'OPEN_TAB'; documentId: string; title: string }`
- `{ type: 'CLOSE_TAB'; documentId: string }`
- `{ type: 'SET_ACTIVE_TAB'; documentId: string }`
- `{ type: 'SET_TAB_DIRTY'; documentId: string; isDirty: boolean }`
- `{ type: 'UPDATE_TAB_TITLE'; documentId: string; title: string }`
- `{ type: 'CLOSE_OTHER_TABS'; documentId: string }`
- `{ type: 'CLOSE_ALL_TABS' }`

**Reducer cases:**

`OPEN_TAB`: If tab with `documentId` already exists in `openTabs`, just set `activeTabId` and `selectedDocumentId` to it. If new, append `{ id: documentId, title, isDirty: false }` to `openTabs` and set both `activeTabId` and `selectedDocumentId`.

`CLOSE_TAB`: Remove tab from `openTabs`. If it was the active tab, activate the next tab to the right (same index), or the left if it was rightmost, or null if empty. Set both `activeTabId` and `selectedDocumentId` to the new active tab.

`SET_ACTIVE_TAB`: Set both `activeTabId` and `selectedDocumentId` to the given `documentId`.

`SET_TAB_DIRTY`: Find the tab by `documentId` in `openTabs` and update its `isDirty` flag. Use `map()` to create new array.

`UPDATE_TAB_TITLE`: Find tab by `documentId` and update its `title`. Use `map()`.

`CLOSE_OTHER_TABS`: Keep only the tab matching `documentId`. Set it as active.

`CLOSE_ALL_TABS`: Set `openTabs` to `[]`, `activeTabId` to `null`, `selectedDocumentId` to `null`.

**CRITICAL: Modify existing `SELECT_DOCUMENT` case.** When `SELECT_DOCUMENT` fires with a non-null documentId, also set `activeTabId` to that documentId. Do NOT add the tab here (the component dispatching SELECT_DOCUMENT does not have the title). Instead, the document panel component will handle opening the tab via a useEffect when it loads the document data. Just ensure `activeTabId` syncs.

Update the `SELECT_DOCUMENT` case to:
```typescript
case 'SELECT_DOCUMENT':
  return {
    ...state,
    selectedDocumentId: action.documentId,
    activeTabId: action.documentId,
  }
```

**Add to KnowledgeBaseContextValue interface:**
- `openTabs: TabItem[]` (already spread from state)
- `activeTabId: string | null` (already spread from state)
- `openTab: (documentId: string, title: string) => void`
- `closeTab: (documentId: string) => void`
- `setActiveTab: (documentId: string) => void`
- `setTabDirty: (documentId: string, isDirty: boolean) => void`
- `updateTabTitle: (documentId: string, title: string) => void`
- `closeOtherTabs: (documentId: string) => void`
- `closeAllTabs: () => void`

**Add useCallback wrappers** for each new action (same pattern as existing `selectDocument`, `toggleFolder`, etc.).

**Add persistence useEffects:**
- Persist `openTabs` (without isDirty -- map to `{ id, title }` before saving) to `STORAGE_KEY_TABS` as JSON
- Persist `activeTabId` to `STORAGE_KEY_ACTIVE_TAB`

**Initialize state:** In the useReducer initializer, load `openTabs` from localStorage via `loadTabs()` (isDirty always false) and `activeTabId` from localStorage. Also set `selectedDocumentId` to the loaded `activeTabId`.

**Export the `TabItem` type** so tab components can import it.
  </action>
  <verify>Run `npx tsc --noEmit` from electron-app/ directory. Zero new type errors in knowledge-base-context.tsx. Grep for `OPEN_TAB` and `activeTabId` in the file to confirm all cases exist.</verify>
  <done>KnowledgeBaseContext has openTabs and activeTabId state with 7 new reducer actions, localStorage persistence, and action callbacks exposed via the hook. SELECT_DOCUMENT sets activeTabId. TabItem type is exported.</done>
</task>

<task type="auto">
  <name>Task 2: Create DocumentTabBar and DocumentTabItem components</name>
  <files>
    electron-app/src/renderer/components/knowledge/document-tab-bar.tsx
    electron-app/src/renderer/components/knowledge/document-tab-item.tsx
  </files>
  <action>
**Create `document-tab-item.tsx`:**

A single tab button component with the following features:

Props interface:
```typescript
interface DocumentTabItemProps {
  tab: TabItem
  isActive: boolean
  onActivate: () => void
  onClose: () => void
}
```

Imports: `FileText`, `X` from `lucide-react`, `Tooltip`/`TooltipTrigger`/`TooltipContent` from `@/components/ui/tooltip`, `cn` from `@/lib/utils`, `type TabItem` from `@/contexts/knowledge-base-context`.

Structure:
- Outer container: Wrap in Tooltip (from Radix UI tooltip component already in the project).
- TooltipTrigger wraps a `<div>` with `role="tab"` and `aria-selected={isActive}`.
- Styling: `group flex items-center gap-2 px-3 py-2 text-sm border-r border-border cursor-pointer hover:bg-muted/50 transition-colors select-none max-w-[200px] min-w-[100px]`. Active tab: `bg-background text-foreground border-b-2 border-b-primary`. Inactive: `text-muted-foreground`.
- Content: `<FileText className="h-3.5 w-3.5 shrink-0" />` icon, then `<span className="truncate flex-1">{tab.title || 'Untitled'}</span>`.
- Right side (4x4 container): When `isDirty` is true, show amber dot (`h-2 w-2 rounded-full bg-amber-500`) that hides on group hover (`group-hover:hidden`). Close button (`X` icon, `h-3 w-3`) hidden by default, shown on group hover (`hidden group-hover:flex` when dirty, `opacity-0 group-hover:opacity-100` when not dirty). Close button has `onClick` with `e.stopPropagation()` then calls `onClose()`.
- Middle-click: `onMouseDown` handler checks `e.button === 1`, calls `e.preventDefault()` then `onClose()`.
- TooltipContent: `{tab.title || 'Untitled'}` with `side="bottom"`.

**Create `document-tab-bar.tsx`:**

Props: none (reads from context).

Imports: `useKnowledgeBase` from `@/contexts/knowledge-base-context`, `DocumentTabItem` from `./document-tab-item`, `TooltipProvider` from `@/components/ui/tooltip`.

Structure:
- If `openTabs.length === 0`, return `null` (no tab bar when no documents open).
- Render a `<div>` with `role="tablist"` and classes `flex items-center border-b border-border bg-muted/30 overflow-x-auto` and `scrollbar-none` (hide scrollbar for clean look, use `[&::-webkit-scrollbar]:hidden` if scrollbar-none not available as a utility).
- Wrap children in `<TooltipProvider delayDuration={500}>`.
- Map `openTabs` to `<DocumentTabItem>` for each, passing `tab`, `isActive={tab.id === activeTabId}`, `onActivate={() => setActiveTab(tab.id)}`, `onClose={() => closeTab(tab.id)}`.

Export both components as named exports.
  </action>
  <verify>Run `npx tsc --noEmit` from electron-app/. Both new files compile without errors. Check that DocumentTabBar and DocumentTabItem are properly exported.</verify>
  <done>DocumentTabBar renders a scrollable row of DocumentTabItem components. Each tab shows title, dirty indicator, close button, middle-click support, and tooltip. Tab bar is invisible when no tabs are open.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (zero new errors)
2. `knowledge-base-context.tsx` contains OPEN_TAB, CLOSE_TAB, SET_ACTIVE_TAB, SET_TAB_DIRTY, UPDATE_TAB_TITLE, CLOSE_OTHER_TABS, CLOSE_ALL_TABS reducer cases
3. `document-tab-bar.tsx` exports DocumentTabBar
4. `document-tab-item.tsx` exports DocumentTabItem
5. activeTabId and selectedDocumentId stay in sync (both set in OPEN_TAB, CLOSE_TAB, SET_ACTIVE_TAB, and SELECT_DOCUMENT)
</verification>

<success_criteria>
- KnowledgeBaseContext extended with tab state (openTabs, activeTabId) and 7 actions
- Tab state persisted to localStorage (openTabs without isDirty, activeTabId)
- DocumentTabBar renders tabs from context with scroll overflow
- DocumentTabItem shows title, dirty dot, close button, middle-click, tooltip
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-tabs-editor-ui-integration/06-01-SUMMARY.md`
</output>
