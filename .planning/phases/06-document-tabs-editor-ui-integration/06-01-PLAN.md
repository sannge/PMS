---
phase: 06-document-tabs-editor-ui-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - electron-app/src/renderer/contexts/knowledge-base-context.tsx
  - electron-app/src/renderer/components/knowledge/document-tab-bar.tsx
  - electron-app/src/renderer/components/knowledge/document-tab-item.tsx
  - electron-app/src/renderer/hooks/use-document-tags.ts
autonomous: true

must_haves:
  truths:
    - "KnowledgeBaseContext has openTabs and activeTabId state fields persisted to localStorage"
    - "OPEN_TAB/CLOSE_TAB/SET_ACTIVE_TAB/SET_TAB_DIRTY/UPDATE_TAB_TITLE/CLOSE_OTHER_TABS/CLOSE_ALL_TABS actions exist in reducer"
    - "activeTabId and selectedDocumentId are always in sync (invariant)"
    - "DocumentTabBar renders open tabs with close buttons and dirty dot indicators"
    - "Middle-click on a tab closes it"
    - "useAssignDocumentTag and useUnassignDocumentTag mutation hooks exist"
  artifacts:
    - path: "electron-app/src/renderer/contexts/knowledge-base-context.tsx"
      provides: "Tab state management (openTabs, activeTabId) with 7 new actions"
      contains: "OPEN_TAB"
    - path: "electron-app/src/renderer/components/knowledge/document-tab-bar.tsx"
      provides: "Browser-style tab bar container with horizontal scroll"
    - path: "electron-app/src/renderer/components/knowledge/document-tab-item.tsx"
      provides: "Single tab item with close button, dirty dot, middle-click-to-close"
    - path: "electron-app/src/renderer/hooks/use-document-tags.ts"
      provides: "useAssignDocumentTag and useUnassignDocumentTag mutation hooks"
      contains: "useAssignDocumentTag"
  key_links:
    - from: "knowledge-base-context.tsx"
      to: "localStorage"
      via: "persistTabs/loadTabs helpers"
      pattern: "kb-open-tabs"
    - from: "document-tab-bar.tsx"
      to: "knowledge-base-context.tsx"
      via: "useKnowledgeBase() hook"
      pattern: "openTabs.*activeTabId"
    - from: "use-document-tags.ts"
      to: "/api/documents/{id}/tags"
      via: "window.electronAPI.post and .delete"
      pattern: "documents.*tags"
---

<objective>
Extend KnowledgeBaseContext with tab state management, build the DocumentTabBar and DocumentTabItem UI components, and add tag assignment mutation hooks.

Purpose: This is the foundation plan for Phase 6. It provides the state layer (tabs in context with localStorage persistence) and the primary tab bar UI components that all other Phase 6 plans depend on. The tag mutation hooks are included here because they are a small, independent piece that unblocks the metadata bar in Plan 02.

Output: Extended context with 7 new tab actions, two new tab bar components, and two new tag mutation hooks.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-document-tabs-editor-ui-integration/06-RESEARCH.md
@electron-app/src/renderer/contexts/knowledge-base-context.tsx
@electron-app/src/renderer/hooks/use-document-tags.ts
@electron-app/src/renderer/components/knowledge/tag-filter-list.tsx
@electron-app/src/renderer/lib/query-client.ts
@electron-app/src/renderer/components/ui/tooltip.tsx
@electron-app/src/renderer/components/ui/scroll-area.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend KnowledgeBaseContext with tab state and actions</name>
  <files>electron-app/src/renderer/contexts/knowledge-base-context.tsx</files>
  <action>
Extend the existing KnowledgeBaseContext with tab state management. This is the most critical task -- all other Phase 6 work depends on it.

**New types to add:**

```typescript
export interface TabItem {
  id: string       // document ID (primary key)
  title: string    // cached display title
  isDirty: boolean // unsaved changes indicator
}
```

**New state fields in KnowledgeBaseUIState:**
- `openTabs: TabItem[]` -- array of open tabs
- `activeTabId: string | null` -- which tab is currently visible

**New localStorage keys (alongside existing STORAGE_KEY_* constants):**
- `STORAGE_KEY_TABS = 'kb-open-tabs'`
- `STORAGE_KEY_ACTIVE_TAB = 'kb-active-tab'`

**New persistence helpers:**
- `loadTabs(): TabItem[]` -- parse from localStorage, always reset isDirty to false on load
- `persistTabs(tabs: TabItem[]): void` -- persist id + title only (NOT isDirty)
- `loadActiveTab(): string | null` -- load from localStorage
- `persistActiveTab(id: string | null): void` -- persist to localStorage

**7 new action types added to KnowledgeBaseAction union:**
```typescript
| { type: 'OPEN_TAB'; documentId: string; title: string }
| { type: 'CLOSE_TAB'; documentId: string }
| { type: 'SET_ACTIVE_TAB'; documentId: string }
| { type: 'SET_TAB_DIRTY'; documentId: string; isDirty: boolean }
| { type: 'UPDATE_TAB_TITLE'; documentId: string; title: string }
| { type: 'CLOSE_OTHER_TABS'; documentId: string }
| { type: 'CLOSE_ALL_TABS' }
```

**Reducer cases -- CRITICAL INVARIANT: `activeTabId === selectedDocumentId` at all times:**

- `OPEN_TAB`: If tab already exists, just activate it. If new, append to `openTabs` and activate. BOTH `activeTabId` AND `selectedDocumentId` are set to `action.documentId`.
- `CLOSE_TAB`: Remove from `openTabs`. If closing the active tab, activate the right neighbor (or left if rightmost, or null if last tab). Update BOTH `activeTabId` AND `selectedDocumentId`. See research doc Pattern 1 for exact index logic.
- `SET_ACTIVE_TAB`: Set BOTH `activeTabId` AND `selectedDocumentId` to `action.documentId`.
- `SET_TAB_DIRTY`: Find tab by id, update its isDirty flag. No other state changes.
- `UPDATE_TAB_TITLE`: Find tab by id, update its title. No other state changes.
- `CLOSE_OTHER_TABS`: Keep only the tab with `action.documentId`, activate it.
- `CLOSE_ALL_TABS`: Set `openTabs` to `[]`, `activeTabId` to null, `selectedDocumentId` to null.

**Persistence useEffects (add alongside existing ones):**
- Persist `openTabs` whenever it changes (persist id + title only, not isDirty)
- Persist `activeTabId` whenever it changes

**Initializer update:** In the useReducer initializer function, add:
```typescript
openTabs: loadTabs(),
activeTabId: loadActiveTab(),
```
Also set `selectedDocumentId` from `loadActiveTab()` (not null) to maintain the invariant on startup.

**New callbacks in provider (7 total):**
- `openTab(documentId: string, title: string)` -> dispatches OPEN_TAB
- `closeTab(documentId: string)` -> dispatches CLOSE_TAB
- `setActiveTab(documentId: string)` -> dispatches SET_ACTIVE_TAB
- `setTabDirty(documentId: string, isDirty: boolean)` -> dispatches SET_TAB_DIRTY
- `updateTabTitle(documentId: string, title: string)` -> dispatches UPDATE_TAB_TITLE
- `closeOtherTabs(documentId: string)` -> dispatches CLOSE_OTHER_TABS
- `closeAllTabs()` -> dispatches CLOSE_ALL_TABS

**Update KnowledgeBaseContextValue interface** to include all new state fields and callbacks.

**Update the value object** in the provider to include all new fields.

**DO NOT modify the existing SELECT_DOCUMENT case** -- it stays as-is for backward compatibility. The sidebar will be updated in Plan 03 to call `openTab()` instead.
  </action>
  <verify>
Run `npx tsc --noEmit` from electron-app/ to verify no type errors. Grep for `OPEN_TAB` in the context file to confirm all 7 actions exist. Grep for `kb-open-tabs` to confirm localStorage persistence.
  </verify>
  <done>
KnowledgeBaseContext has openTabs and activeTabId state with 7 new actions, localStorage persistence, and the activeTabId===selectedDocumentId invariant is maintained in all reducer cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build DocumentTabBar and DocumentTabItem components</name>
  <files>
    electron-app/src/renderer/components/knowledge/document-tab-bar.tsx
    electron-app/src/renderer/components/knowledge/document-tab-item.tsx
  </files>
  <action>
Create two new components for the browser-style tab bar.

**document-tab-item.tsx:**

Props interface:
```typescript
interface DocumentTabItemProps {
  tab: TabItem
  isActive: boolean
  onActivate: () => void
  onClose: () => void
}
```

Implementation:
- Render as a `div` with `role="tab"` and `aria-selected={isActive}`
- FileText icon (lucide-react, h-3.5 w-3.5) + truncated title + close/dirty indicator area
- Active tab: `bg-background text-foreground border-b-2 border-b-primary`
- Inactive tab: `text-muted-foreground hover:bg-muted/50`
- Max width `max-w-[200px]`, min width `min-w-[100px]`
- Right area (shrink-0, w-4 h-4):
  - When `isDirty`: show amber-500 dot (h-2 w-2 rounded-full), hidden on group-hover
  - Close button (X icon, h-3 w-3): shown on group-hover (replacing dirty dot), or shown with opacity-0->opacity-100 transition when not dirty
  - Close button `onClick` calls `e.stopPropagation()` then `onClose()`
- Middle-click (button === 1) on the tab div calls `onClose()` with `e.preventDefault()`
- Wrap in Tooltip (from `@/components/ui/tooltip`) showing full title on hover
- Add `group` class to outer div for group-hover behavior
- Use `cn()` from `@/lib/utils` for conditional classes
- Import `TabItem` type from `@/contexts/knowledge-base-context`

**document-tab-bar.tsx:**

Props: none (reads from context).

Implementation:
- Uses `useKnowledgeBase()` to get `openTabs`, `activeTabId`, `setActiveTab`, `closeTab`
- If `openTabs.length === 0`, render nothing (return null) -- the DocumentPanel handles empty state
- Render as a horizontal bar: `flex items-center border-b border-border bg-muted/30 overflow-x-auto`
- Use the ScrollArea component from `@/components/ui/scroll-area` with horizontal orientation for tab overflow
- Map `openTabs` to `DocumentTabItem` components with:
  - `key={tab.id}`
  - `isActive={tab.id === activeTabId}`
  - `onActivate={() => setActiveTab(tab.id)}`
  - `onClose={() => closeTab(tab.id)}`
- Export `DocumentTabBar` as named export

**Anti-patterns to avoid:**
- Do NOT use `@radix-ui/react-tabs` -- it is a content-panel switcher, not a browser tab bar
- Do NOT fetch document data in tab items -- tabs only display cached `TabItem.title`
  </action>
  <verify>
Run `npx tsc --noEmit` from electron-app/ to verify no type errors. Check that both files export their components. Check that DocumentTabItem uses `role="tab"` for accessibility.
  </verify>
  <done>
DocumentTabBar renders a horizontal scrollable tab bar from context state. DocumentTabItem shows file icon, truncated title, dirty dot, close button with middle-click support and tooltip.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tag assignment mutation hooks</name>
  <files>electron-app/src/renderer/hooks/use-document-tags.ts</files>
  <action>
Add two mutation hooks to the existing `use-document-tags.ts` file for assigning and unassigning tags from documents. The backend endpoints already exist.

**Add imports:**
- `useMutation, useQueryClient` from `@tanstack/react-query` (add to existing import)
- `type UseMutationResult` from `@tanstack/react-query`

**Add TagAssignmentResponse type:**
```typescript
interface TagAssignmentResponse {
  document_id: string
  tag_id: string
  assigned_at: string
}
```

**useAssignDocumentTag hook:**
```typescript
export function useAssignDocumentTag(
  documentId: string
): UseMutationResult<TagAssignmentResponse, Error, string>
```
- `mutationFn`: POST to `/api/documents/${documentId}/tags` with body `{ tag_id: tagId }` using `window.electronAPI.post`. Expect 201 status.
- `onSuccess`: invalidate `queryKeys.document(documentId)` to refresh the document's tags array.
- Uses existing `getAuthHeaders(token)` and `parseApiError` helpers already in the file.

**useUnassignDocumentTag hook:**
```typescript
export function useUnassignDocumentTag(
  documentId: string
): UseMutationResult<void, Error, string>
```
- `mutationFn`: DELETE to `/api/documents/${documentId}/tags/${tagId}` using `window.electronAPI.delete`. Expect 204 or 200 status.
- `onSuccess`: invalidate `queryKeys.document(documentId)` to refresh the document's tags array.

**Important:** Both hooks use `useAuthStore((s) => s.token)` for auth (already imported in the file via `useAuthStore`). Both use `useQueryClient()` for cache invalidation.
  </action>
  <verify>
Run `npx tsc --noEmit` from electron-app/ to verify no type errors. Grep for `useAssignDocumentTag` and `useUnassignDocumentTag` in the file to confirm exports exist.
  </verify>
  <done>
Both tag mutation hooks exist, call the correct backend endpoints, and invalidate the document query cache on success.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` from electron-app/ passes with zero errors
2. KnowledgeBaseContext exports TabItem type and all 7 new callbacks
3. DocumentTabBar and DocumentTabItem components exist and compile
4. useAssignDocumentTag and useUnassignDocumentTag hooks exist in use-document-tags.ts
5. localStorage keys `kb-open-tabs` and `kb-active-tab` are used for persistence
</verification>

<success_criteria>
- KnowledgeBaseContext has openTabs[] and activeTabId state with localStorage persistence
- All 7 tab actions are implemented with the activeTabId===selectedDocumentId invariant
- Tab bar components render with proper styling, tooltips, dirty indicators, and close behavior
- Tag mutation hooks are ready for use in Plan 02's metadata bar
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-tabs-editor-ui-integration/06-01-SUMMARY.md`
</output>
