---
phase: 04-auto-save-content-pipeline
plan: 04
type: tdd
wave: 1
depends_on: []
files_modified:
  - fastapi-backend/app/services/content_converter.py
  - fastapi-backend/tests/test_content_converter.py
autonomous: true

must_haves:
  truths:
    - "tiptap_json_to_markdown converts paragraphs, headings (H1-H6), bold, italic, strikethrough, code, and links to correct Markdown"
    - "tiptap_json_to_markdown converts bullet lists, ordered lists, and task lists (with checked/unchecked state) including nested lists"
    - "tiptap_json_to_markdown converts code blocks (with language annotation), blockquotes, horizontal rules, images, and tables"
    - "tiptap_json_to_plain_text extracts all text content from any TipTap JSON document, stripping all formatting"
    - "Both functions return empty string for null, empty, or malformed input (never raise exceptions)"
    - "Unknown node types are handled gracefully by rendering children if present"
  artifacts:
    - path: "fastapi-backend/app/services/content_converter.py"
      provides: "TipTap JSON to Markdown and plain text converter"
      exports: ["tiptap_json_to_markdown", "tiptap_json_to_plain_text"]
    - path: "fastapi-backend/tests/test_content_converter.py"
      provides: "Comprehensive test suite for content converter"
      contains: "test_"
  key_links:
    - from: "fastapi-backend/app/routers/documents.py"
      to: "fastapi-backend/app/services/content_converter.py"
      via: "import and call on document save"
      pattern: "from.*content_converter.*import"
---

<objective>
Build a custom Python TipTap JSON-to-Markdown and JSON-to-plain-text converter using TDD. The converter walks the ProseMirror JSON document tree and produces clean Markdown (for AI/LLM consumption) and plain text (for search indexing).

Purpose: The auto-save endpoint (plan 04-01) needs to generate Markdown and plain text on every save. This is a pure-logic module with well-defined inputs and outputs -- ideal for TDD. The converter replaces the Phase 1 stubs in document_service.py.

Output: Fully tested content_converter.py with tiptap_json_to_markdown and tiptap_json_to_plain_text functions.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-auto-save-content-pipeline/04-RESEARCH.md

Research provides complete code example for the converter in the "Code Examples" section.
The TipTap JSON schema is a recursive tree of type/content/marks/attrs nodes.
</context>

<feature>
  <name>TipTap JSON Content Converter</name>
  <files>
    fastapi-backend/app/services/content_converter.py (CREATE)
    fastapi-backend/tests/test_content_converter.py (CREATE)
  </files>
  <behavior>
    The converter handles these TipTap node types:

    **Block nodes (each becomes a Markdown block):**
    - `paragraph` -> inline content + "\n\n"
    - `heading` (attrs.level 1-6) -> "#" * level + " " + inline content + "\n\n"
    - `bulletList` -> "- " prefix per listItem, indent nested lists with 2 spaces
    - `orderedList` -> "1. ", "2. " prefix per listItem, indent nested lists
    - `taskList` -> "- [ ] " or "- [x] " per taskItem (attrs.checked)
    - `codeBlock` (attrs.language) -> "```{lang}\n{code}\n```\n\n"
    - `blockquote` -> "> " prefix per line of inner content
    - `table` -> Markdown table with header row and separator ("|---|")
    - `horizontalRule` -> "---\n\n"
    - `image` (attrs.src, attrs.alt) -> "![alt](src)\n\n"

    **Inline marks (wrap text):**
    - `bold` -> "**text**"
    - `italic` -> "_text_"
    - `strike` -> "~~text~~"
    - `code` -> "`text`"
    - `link` (attrs.href) -> "[text](href)"
    - `hardBreak` -> "  \n" (two spaces + newline)

    **Plain text extraction:**
    - Recursively extracts all `text` node content
    - Adds newline after paragraph, heading, listItem, taskItem nodes
    - Returns stripped result

    **Edge cases:**
    - `tiptap_json_to_markdown(None)` -> ""
    - `tiptap_json_to_markdown({})` -> ""
    - `tiptap_json_to_markdown({"type": "doc"})` -> "" (no content)
    - Unknown node types -> render children if present, skip otherwise
    - Multiple marks on same text -> apply all (order: link first if present, then bold/italic/strike/code)

    **Test cases (input -> expected output):**

    1. Empty doc: `{"type": "doc", "content": []}` -> ""
    2. Simple paragraph: `{"type": "doc", "content": [{"type": "paragraph", "content": [{"type": "text", "text": "Hello world"}]}]}` -> "Hello world\n\n"
    3. Heading H2: `{"type": "doc", "content": [{"type": "heading", "attrs": {"level": 2}, "content": [{"type": "text", "text": "Title"}]}]}` -> "## Title\n\n"
    4. Bold + italic text: paragraph with marks [bold] and [italic] -> "**bold** _italic_\n\n"
    5. Link: text with mark type "link", attrs.href -> "[text](href)"
    6. Bullet list with 2 items -> "- Item 1\n- Item 2\n\n"
    7. Nested bullet list -> "- Parent\n  - Child\n\n"
    8. Ordered list -> "1. First\n2. Second\n\n"
    9. Task list checked/unchecked -> "- [x] Done\n- [ ] Todo\n\n"
    10. Code block with language -> "```python\nprint('hi')\n```\n\n"
    11. Blockquote -> "> Quoted text\n\n"
    12. Table (2x2) -> "| H1 | H2 |\n| --- | --- |\n| A | B |\n\n"
    13. Horizontal rule -> "---\n\n"
    14. Image -> "![alt text](https://example.com/img.png)\n\n"
    15. Complex document with multiple node types combined
    16. Plain text extraction for same cases (text only, no formatting)
    17. None/empty/malformed input returns ""
  </behavior>
  <implementation>
    Create `fastapi-backend/app/services/content_converter.py` following the architecture pattern from the research document's "Code Examples" section.

    The module has two public functions:
    - `tiptap_json_to_markdown(doc: dict[str, Any]) -> str`
    - `tiptap_json_to_plain_text(doc: dict[str, Any]) -> str`

    Internal helper functions:
    - `_md_nodes(nodes, list_indent)` -- recursive block-level renderer
    - `_md_inline(nodes)` -- inline text + marks renderer
    - `_md_list_item(item, indent)` -- renders a single list item (may contain nested lists)
    - `_md_table(node)` -- renders a table node to Markdown table
    - `_extract_text_from_nodes(nodes)` -- recursive text extractor for plain text

    Mark wrapping uses a dict: `{"bold": "**", "italic": "_", "strike": "~~", "code": "\`"}`. Links are special-cased since they use `[text](href)` syntax.

    After the converter is working and tested, update the import in `fastapi-backend/app/routers/documents.py` to use `content_converter.tiptap_json_to_markdown` and `content_converter.tiptap_json_to_plain_text` instead of the Phase 1 stubs from document_service.py. If plan 04-01 has already created the endpoint, update the import there. If not, add a comment noting the import location.

    Also remove or deprecate the stubs in document_service.py (`convert_tiptap_to_markdown`, `convert_tiptap_to_plain_text`) by replacing them with thin wrappers that call the new converter, or by removing them if no other code references them.
  </implementation>
</feature>

<verification>
1. `cd fastapi-backend && pytest tests/test_content_converter.py -v` -- all tests pass
2. `cd fastapi-backend && ruff check app/services/content_converter.py` -- no lint errors
3. `cd fastapi-backend && python -c "from app.services.content_converter import tiptap_json_to_markdown, tiptap_json_to_plain_text; print(tiptap_json_to_markdown({'type': 'doc', 'content': [{'type': 'paragraph', 'content': [{'type': 'text', 'text': 'Hello'}]}]}))"` prints "Hello\n\n"
4. Empty/None inputs return empty string without exceptions
5. Table rendering produces valid Markdown table syntax
6. Nested lists indent correctly with 2 spaces per level
</verification>

<success_criteria>
- tiptap_json_to_markdown produces correct Markdown for all supported TipTap node types
- tiptap_json_to_plain_text extracts clean text from any TipTap JSON document
- All edge cases (null, empty, malformed, unknown nodes) handled gracefully
- Test suite covers all 17+ test cases listed in behavior section
- No external dependencies added (pure stdlib + typing)
- Phase 1 stubs replaced or deprecated
</success_criteria>

<output>
After completion, create `.planning/phases/04-auto-save-content-pipeline/04-04-SUMMARY.md`
</output>
