---
phase: 04-auto-save-content-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - electron-app/src/renderer/lib/draft-db.ts
  - electron-app/src/renderer/hooks/use-draft.ts
autonomous: true

must_haves:
  truths:
    - "Unsaved editor content is auto-buffered to IndexedDB every 2 seconds of inactivity"
    - "On document open, if a draft newer than the server version exists with different content, user sees a restore/discard prompt"
    - "Drafts are deleted after successful server save"
    - "Drafts older than 7 days are cleaned up on app startup"
  artifacts:
    - path: "electron-app/src/renderer/lib/draft-db.ts"
      provides: "IndexedDB pm-drafts-db store with CRUD operations"
      exports: ["getDraftDB", "getDraft", "saveDraft", "deleteDraft", "cleanupOldDrafts"]
    - path: "electron-app/src/renderer/hooks/use-draft.ts"
      provides: "useDraft hook for draft persistence and restore prompt"
      exports: ["useDraft"]
  key_links:
    - from: "electron-app/src/renderer/lib/draft-db.ts"
      to: "IndexedDB pm-drafts-db"
      via: "idb openDB"
      pattern: "openDB.*pm-drafts-db"
    - from: "electron-app/src/renderer/hooks/use-draft.ts"
      to: "electron-app/src/renderer/lib/draft-db.ts"
      via: "getDraft, saveDraft, deleteDraft imports"
      pattern: "import.*draft-db"
---

<objective>
Create the IndexedDB draft persistence layer that auto-buffers unsaved editor content locally, enabling crash recovery. On document open, check for drafts newer than the server version and prompt restore or discard.

Purpose: This is the crash recovery mechanism. If the app force-quits, OS kills the process, or the browser crashes, the draft written every ~2 seconds survives and can be restored. This is the ONLY reliable crash recovery -- beforeunload and Electron close events may not fire.
Output: A draft-db.ts IndexedDB store and useDraft hook that auto-saves drafts and prompts for recovery.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-auto-save-content-pipeline/04-RESEARCH.md
@electron-app/src/renderer/lib/query-cache-db.ts
@electron-app/src/renderer/lib/per-query-persister.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: IndexedDB draft store (draft-db.ts)</name>
  <files>
    electron-app/src/renderer/lib/draft-db.ts
  </files>
  <action>
    Create `draft-db.ts` following the patterns in the existing `query-cache-db.ts`:

    1. Define a `DraftEntry` interface:
       - `documentId: string` (primary key)
       - `contentJson: string` (TipTap JSON string)
       - `title: string` (document title at draft time)
       - `serverUpdatedAt: number` (server's updated_at timestamp when doc was loaded -- epoch ms)
       - `draftedAt: number` (when this draft was written -- epoch ms)

    2. Define a `DraftDBSchema` extending `DBSchema` from `idb`:
       - Object store name: `drafts`
       - Key: `string` (documentId)
       - Value: `DraftEntry`
       - Index: `by-drafted-at` on `draftedAt` field

    3. `getDraftDB()` function:
       - Uses singleton pattern (match `query-cache-db.ts`'s `let dbPromise` pattern)
       - Opens `pm-drafts-db` version 1
       - upgrade: creates `drafts` object store with `keyPath: 'documentId'` and `by-drafted-at` index
       - `terminated()` callback resets `dbPromise = null`

    4. CRUD functions:
       - `saveDraft(entry: DraftEntry): Promise<void>` -- put into drafts store
       - `getDraft(documentId: string): Promise<DraftEntry | undefined>` -- get by key
       - `deleteDraft(documentId: string): Promise<void>` -- delete by key
       - `cleanupOldDrafts(maxAgeDays: number = 7): Promise<number>` -- open cursor on `by-drafted-at` index, delete entries where `draftedAt < Date.now() - maxAgeDays * 86400000`, return count deleted

    Export all functions and the `DraftEntry` type.
  </action>
  <verify>
    Run `cd D:/FTX_CODE/pm-project/electron-app && npx tsc --noEmit --pretty 2>&1 | head -30` to check for type errors.
    Grep for `pm-drafts-db` in `draft-db.ts`.
    Grep for `cleanupOldDrafts` export.
  </verify>
  <done>
    draft-db.ts exists with getDraftDB, saveDraft, getDraft, deleteDraft, cleanupOldDrafts. Uses idb library with pm-drafts-db database, separate from query-cache-db.
  </done>
</task>

<task type="auto">
  <name>Task 2: useDraft hook for auto-buffering and restore prompt</name>
  <files>
    electron-app/src/renderer/hooks/use-draft.ts
  </files>
  <action>
    Create `use-draft.ts` with a `useDraft` hook:

    1. Parameters:
       - `documentId: string`
       - `editor: Editor | null` (TipTap editor instance)
       - `serverUpdatedAt: number` (epoch ms -- the server's updated_at for the loaded document)
       - `documentTitle: string` (current document title)

    2. State:
       - `pendingDraft: DraftEntry | null` -- set when a recoverable draft is found on mount
       - `draftTimerRef = useRef<ReturnType<typeof setTimeout>>()` -- 2-second debounce for draft writes

    3. On mount (useEffect with documentId + serverUpdatedAt deps):
       - Call `getDraft(documentId)`
       - If draft exists AND `draft.draftedAt > serverUpdatedAt`:
         - If draft content differs from current editor content (or editor not loaded yet): set `pendingDraft`
         - Else: silently `deleteDraft(documentId)` (draft matches server)
       - If draft exists but is older than server: silently `deleteDraft(documentId)`

    4. Auto-buffer on editor changes (useEffect with editor dep):
       - Listen to `editor.on('update', handler)`
       - handler: clear existing timer, set new 2_000ms timeout that calls `saveDraft({ documentId, contentJson: JSON.stringify(editor.getJSON()), title: documentTitle, serverUpdatedAt, draftedAt: Date.now() })`
       - Cleanup: remove listener, clear timer

    5. `restoreDraft()` callback:
       - Returns the parsed JSON content from pendingDraft (`JSON.parse(pendingDraft.contentJson)`)
       - Sets pendingDraft to null
       - Does NOT delete the draft from IndexedDB yet (it will be deleted on next successful server save)

    6. `discardDraft()` async callback:
       - Calls `deleteDraft(documentId)`
       - Sets pendingDraft to null

    7. `clearDraftAfterSave()` callback:
       - Calls `deleteDraft(documentId)` -- called by auto-save hook after successful server save

    8. Return: `{ pendingDraft, restoreDraft, discardDraft, clearDraftAfterSave }`

    Also, run `cleanupOldDrafts(7)` once on module load (or in a top-level useEffect in App.tsx). The simplest approach: call it at the top of `getDraftDB()` after DB opens, guarded by a `let cleanupRan = false` flag.
  </action>
  <verify>
    Run `cd D:/FTX_CODE/pm-project/electron-app && npx tsc --noEmit --pretty 2>&1 | head -30` to check for type errors.
    Grep for `useDraft` export in `use-draft.ts`.
    Grep for `clearDraftAfterSave` in `use-draft.ts`.
  </verify>
  <done>
    useDraft hook exists. Editor changes auto-buffer to IndexedDB every 2s. On document open, checks for newer draft and exposes pendingDraft for restore/discard UI. clearDraftAfterSave is available for auto-save hook integration. Old drafts are cleaned up on app startup.
  </done>
</task>

</tasks>

<verification>
1. `draft-db.ts` creates a separate `pm-drafts-db` IndexedDB (not reusing `pm-query-cache-db`)
2. `saveDraft` writes DraftEntry with documentId as key
3. `cleanupOldDrafts` deletes entries older than 7 days via cursor on `by-drafted-at` index
4. `useDraft` auto-buffers editor content to IndexedDB every 2 seconds of inactivity
5. `useDraft` checks for newer drafts on document open and exposes pendingDraft
6. `restoreDraft()` returns parsed JSON content for editor to load
7. `discardDraft()` deletes from IndexedDB
8. `clearDraftAfterSave()` cleans up draft after successful server save
9. TypeScript compiles without errors
</verification>

<success_criteria>
- IndexedDB draft store is separate from query cache (different database name)
- Editor changes are auto-buffered to IndexedDB every 2 seconds
- On document open, drafts newer than server version trigger a restore/discard prompt
- Drafts matching server content are silently cleaned up
- clearDraftAfterSave() is available for integration with auto-save hook
- Old drafts (>7 days) are cleaned up on app startup
</success_criteria>

<output>
After completion, create `.planning/phases/04-auto-save-content-pipeline/04-02-SUMMARY.md`
</output>
