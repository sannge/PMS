---
phase: 04-auto-save-content-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  # Frontend CREATE
  - electron-app/src/renderer/components/knowledge/save-status.tsx
  # Frontend MODIFY
  - electron-app/src/renderer/hooks/use-auto-save.ts
  # Electron MODIFY
  - electron-app/src/main/index.ts
  - electron-app/src/preload/index.ts
autonomous: true

must_haves:
  truths:
    - "When the user navigates away from a document (component unmount), unsaved content is saved to both IndexedDB and the server"
    - "When the user closes the Electron app (Cmd+Q, Alt+F4, window close), unsaved content is saved to IndexedDB and a server save is attempted"
    - "Status bar shows 'Saving...' during save, 'Saved Xs ago' after success (updating every second), and 'Save failed' with error on failure"
    - "The save status indicator is a reusable component that accepts save state props"
    - "Electron main process coordinates shutdown: sends IPC to renderer, waits up to 3 seconds for save, then quits"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/save-status.tsx"
      provides: "SaveStatus component displaying real-time save state"
      exports: ["SaveStatus"]
    - path: "electron-app/src/renderer/hooks/use-auto-save.ts"
      provides: "Updated useAutoSave with save-on-unmount and beforeunload handler"
      contains: "beforeunload"
    - path: "electron-app/src/main/index.ts"
      provides: "Electron main process with before-quit IPC coordination"
      contains: "before-quit"
    - path: "electron-app/src/preload/index.ts"
      provides: "IPC bridge for save-before-quit channel"
      contains: "save-before-quit"
  key_links:
    - from: "electron-app/src/main/index.ts"
      to: "electron-app/src/preload/index.ts"
      via: "IPC channel 'save-before-quit' and 'save-complete'"
      pattern: "save-before-quit"
    - from: "electron-app/src/preload/index.ts"
      to: "electron-app/src/renderer/hooks/use-auto-save.ts"
      via: "window.electronAPI.onSaveBeforeQuit listener"
      pattern: "onSaveBeforeQuit"
    - from: "electron-app/src/renderer/components/knowledge/save-status.tsx"
      to: "electron-app/src/renderer/hooks/use-auto-save.ts"
      via: "Receives isSaving, lastSavedAt, saveError as props"
      pattern: "SaveStatus"
---

<objective>
Add save-on-navigate-away, save-on-app-close (Electron IPC coordination), and a visual save status indicator component.

Purpose: Ensures zero data loss during normal usage patterns (switching documents, closing tabs, quitting the app) and gives users real-time feedback on save state. Combined with plan 04-02's IndexedDB drafts, this provides comprehensive data loss prevention.

Output: Updated useAutoSave with unmount/beforeunload handling, Electron main process before-quit IPC, preload bridge, and SaveStatus UI component.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-auto-save-content-pipeline/04-RESEARCH.md
@.planning/phases/04-auto-save-content-pipeline/04-01-SUMMARY.md
@.planning/phases/04-auto-save-content-pipeline/04-02-SUMMARY.md

Key reference files:
@electron-app/src/main/index.ts
@electron-app/src/preload/index.ts
@electron-app/src/renderer/hooks/use-auto-save.ts
@electron-app/src/renderer/lib/draft-db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add save-on-navigate and Electron before-quit IPC coordination</name>
  <files>
    electron-app/src/renderer/hooks/use-auto-save.ts (MODIFY)
    electron-app/src/main/index.ts (MODIFY)
    electron-app/src/preload/index.ts (MODIFY)
  </files>
  <action>
    **1. Update `use-auto-save.ts` -- add save-on-unmount and beforeunload:**

    Add to the existing useAutoSave hook:

    a) **Save on component unmount (navigate away from document):**
    Add a useEffect cleanup function that:
    - Checks `isDirty()` (compare current editor JSON against lastSavedJsonRef)
    - If dirty: call `saveDraftToIndexedDB()` (import from draft-db.ts -- saveDraft with current editor content)
    - If dirty: fire-and-forget `saveToServer()` (call the save mutation without awaiting -- component is unmounting)
    - Clear the debounce timer

    b) **beforeunload handler:**
    Add a useEffect that registers `window.addEventListener('beforeunload', handler)`:
    - In handler: if dirty, call `saveDraft()` from draft-db (IndexedDB write is fast and usually completes before teardown)
    - Call `e.preventDefault()` to signal the browser there are unsaved changes
    - Cleanup: remove the event listener

    c) **Electron IPC listener for save-before-quit:**
    Add a useEffect that listens for the Electron IPC `save-before-quit` event:
    - `window.electronAPI?.onSaveBeforeQuit(async () => { ... })`
    - If dirty: save draft to IndexedDB, attempt server save (with 2s timeout), then signal completion
    - Call `window.electronAPI?.saveComplete()` when done (whether save succeeded or not)
    - If not dirty: immediately call `window.electronAPI?.saveComplete()`

    **2. Update `electron-app/src/main/index.ts` -- add before-quit handler:**

    Add a `before-quit` event handler on the Electron app:

    ```typescript
    app.on('before-quit', (event) => {
      // Send IPC to all renderer windows
      const windows = BrowserWindow.getAllWindows()
      if (windows.length === 0) return

      event.preventDefault()

      // Send save-before-quit to renderer
      windows.forEach(win => {
        win.webContents.send('save-before-quit')
      })

      // Wait for save-complete IPC or timeout after 3 seconds
      let completed = false
      const timeout = setTimeout(() => {
        if (!completed) {
          completed = true
          app.exit(0)
        }
      }, 3000)

      ipcMain.once('save-complete', () => {
        if (!completed) {
          completed = true
          clearTimeout(timeout)
          app.exit(0)
        }
      })
    })
    ```

    Examine the existing main/index.ts to understand the current app lifecycle setup and integrate the before-quit handler without breaking existing behavior. If there's already a quit handler, merge with it.

    **3. Update `electron-app/src/preload/index.ts` -- add IPC bridge:**

    Add to the existing `contextBridge.exposeInMainWorld('electronAPI', { ... })`:

    ```typescript
    onSaveBeforeQuit: (callback: () => Promise<void>) => {
      ipcRenderer.on('save-before-quit', async () => {
        await callback()
        ipcRenderer.send('save-complete')
      })
    },
    saveComplete: () => {
      ipcRenderer.send('save-complete')
    },
    removeSaveBeforeQuitListener: () => {
      ipcRenderer.removeAllListeners('save-before-quit')
    }
    ```

    Check existing preload/index.ts for the current IPC bridge structure and follow the same patterns.

    **Important:** The `onSaveBeforeQuit` callback should be registered once per renderer process (not per document). The useAutoSave hook should register/unregister its listener on mount/unmount to avoid stale closures.
  </action>
  <verify>
    - `cd electron-app && npx tsc --noEmit` passes
    - `cd electron-app && npm run lint` passes
    - Preload exposes `onSaveBeforeQuit`, `saveComplete`, `removeSaveBeforeQuitListener`
    - Main process has `before-quit` handler with 3-second timeout
    - useAutoSave cleanup function saves draft and fires server save on unmount
  </verify>
  <done>
    Save-on-navigate (component unmount), save-on-beforeunload (tab/window close), and Electron before-quit IPC coordination all wired. Main process sends save-before-quit, waits up to 3 seconds for renderer to save, then force-exits. Draft is always written to IndexedDB as primary crash recovery; server save is best-effort.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SaveStatus indicator component</name>
  <files>
    electron-app/src/renderer/components/knowledge/save-status.tsx (CREATE)
  </files>
  <action>
    Create `electron-app/src/renderer/components/knowledge/save-status.tsx` -- a small, reusable status indicator.

    **Props interface:**
    ```typescript
    interface SaveStatusProps {
      isSaving: boolean
      lastSavedAt: number | null  // Date.now() timestamp of last successful save
      saveError: string | null    // Error message from last failed save
      className?: string          // For layout positioning
    }
    ```

    **State machine display:**
    - `isSaving === true` -> Show "Saving..." with a subtle spinner or pulsing dot (use Tailwind `animate-pulse`)
    - `saveError !== null` -> Show "Save failed" in red/destructive color with the error message as title/tooltip. Include a small "Retry" text or icon that the parent can wire to `saveNow()`.
    - `lastSavedAt !== null && !isSaving && !saveError` -> Show "Saved Xs ago" with relative time. Update every second using a `useEffect` with `setInterval(1000)`.
    - All null/false -> Show nothing or "No changes" in muted text

    **Relative time formatting:**
    - < 5 seconds: "Saved just now"
    - < 60 seconds: "Saved Xs ago"
    - < 60 minutes: "Saved Xm ago"
    - >= 60 minutes: "Saved Xh ago"

    No external library needed for this. Simple `Date.now() - lastSavedAt` calculation.

    **Styling:**
    - Use Tailwind classes, follow shadcn/ui patterns for text colors:
      - Saving: `text-muted-foreground` with animate-pulse
      - Saved: `text-muted-foreground` (subtle, not distracting)
      - Error: `text-destructive` (red)
    - Small text size (`text-xs` or `text-sm`)
    - Inline flex layout with icon + text
    - Use Lucide icons: `Loader2` for saving spinner, `Check` for saved, `AlertCircle` for error

    **Export:** Named export `SaveStatus` from the file.

    Follow component structure conventions: section comments, types at top, component below.
  </action>
  <verify>
    - `cd electron-app && npx tsc --noEmit` passes
    - `cd electron-app && npm run lint` passes
    - Component renders all 4 states: saving, saved, error, idle
    - Relative time updates every second when in "saved" state
    - Uses Tailwind + Lucide icons (no new dependencies)
  </verify>
  <done>
    SaveStatus component created showing real-time save state: "Saving..." with spinner, "Saved Xs ago" with live-updating relative time, "Save failed" in red with error details. Uses Tailwind + Lucide icons, follows shadcn/ui conventions.
  </done>
</task>

</tasks>

<verification>
1. `cd electron-app && npx tsc --noEmit` passes
2. `cd electron-app && npm run lint` passes
3. Navigate away from a document with unsaved changes -> draft saved to IndexedDB, server save attempted
4. Close Electron app with unsaved changes -> main process sends IPC, renderer saves draft, app exits within 3 seconds
5. SaveStatus shows all 4 states correctly with proper styling
6. "Saved Xs ago" updates every second
7. No console errors during normal save/navigate/close flow
</verification>

<success_criteria>
- No data loss on navigate away (draft saved + server save attempted)
- No data loss on app close (Electron IPC coordination with 3s timeout)
- SaveStatus shows real-time feedback: Saving / Saved Xs ago / Save failed
- Relative time updates live (not stale)
- TypeScript compiles, ESLint passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-auto-save-content-pipeline/04-03-SUMMARY.md`
</output>
