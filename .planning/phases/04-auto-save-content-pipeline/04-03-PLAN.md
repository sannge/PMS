---
phase: 04-auto-save-content-pipeline
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - electron-app/src/renderer/components/knowledge/SaveStatus.tsx
  - electron-app/src/main/index.ts
  - electron-app/src/preload/index.ts
autonomous: true

must_haves:
  truths:
    - "Document saves immediately when user navigates away from the editor"
    - "Document saves immediately when user closes the Electron app (before-quit IPC)"
    - "Status bar shows 'Saving...' during save, 'Saved Xs ago' after save, and 'Save failed' on error"
    - "If Electron close save takes >3 seconds, app quits anyway (IndexedDB draft is the fallback)"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/SaveStatus.tsx"
      provides: "Save status indicator component"
      exports: ["SaveStatus"]
    - path: "electron-app/src/main/index.ts"
      provides: "before-quit IPC coordination with 3s timeout"
      contains: "before-quit-save"
    - path: "electron-app/src/preload/index.ts"
      provides: "onBeforeQuit and confirmQuitSave IPC bridge"
      contains: "onBeforeQuit"
  key_links:
    - from: "electron-app/src/main/index.ts"
      to: "electron-app/src/preload/index.ts"
      via: "IPC channel before-quit-save"
      pattern: "before-quit-save"
    - from: "electron-app/src/preload/index.ts"
      to: "renderer (useAutoSave.saveNow)"
      via: "onBeforeQuit callback triggers saveNow()"
      pattern: "onBeforeQuit"
    - from: "electron-app/src/renderer/components/knowledge/SaveStatus.tsx"
      to: "useAutoSave saveStatus"
      via: "SaveStatus prop from useAutoSave hook"
      pattern: "saveStatus"
---

<objective>
Wire save-on-navigate-away (React effect cleanup), save-on-app-close (Electron IPC), and a visual save status indicator that shows real-time save state.

Purpose: Prevents data loss during navigation and app close. The status indicator gives users confidence their work is saved. The Electron IPC pattern with 3-second timeout ensures the app doesn't hang on close.
Output: SaveStatus component, Electron before-quit IPC coordination, and React cleanup that calls saveNow() on navigate away.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-auto-save-content-pipeline/04-RESEARCH.md
@.planning/phases/04-auto-save-content-pipeline/04-01-SUMMARY.md
@.planning/phases/04-auto-save-content-pipeline/04-02-SUMMARY.md
@electron-app/src/main/index.ts
@electron-app/src/preload/index.ts
@electron-app/src/renderer/hooks/use-auto-save.ts
@electron-app/src/renderer/hooks/use-draft.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Electron before-quit IPC and save-on-navigate cleanup</name>
  <files>
    electron-app/src/main/index.ts
    electron-app/src/preload/index.ts
  </files>
  <action>
    **Electron main process (`index.ts`):**

    1. Add an `isQuitting` flag (let isQuitting = false) near the top of the file (module scope).

    2. On the `mainWindow.on('close', ...)` handler (add new or modify existing):
       - If `isQuitting` is true, allow default close (do nothing, let it proceed).
       - If `isQuitting` is false:
         - `event.preventDefault()` to stop the close
         - `mainWindow.webContents.send('before-quit-save')` to notify renderer
         - Set a 3-second timeout: after 3000ms, set `isQuitting = true` and call `mainWindow.close()`

    3. Add IPC listener: `ipcMain.on('quit-save-complete', () => { isQuitting = true; mainWindow?.close() })`
       - Import `ipcMain` from electron if not already imported.

    **Preload (`index.ts`):**

    4. Follow the existing callback Set pattern used in preload.ts (e.g., `notificationCallbacks`, `webSocketCallbacks`, `maximizedCallbacks`). Specifically:
       - Create a `beforeQuitCallbacks = new Set<() => void>()` at module scope
       - Register ONE `ipcRenderer.on('before-quit-save', ...)` listener at module scope that iterates the Set and calls each callback
       - Expose `onBeforeQuit: (callback: () => void) => () => void` that adds the callback to the Set and returns a cleanup function that removes it from the Set
       - Expose `confirmQuitSave: () => void` that sends `ipcRenderer.send('quit-save-complete')` to main process

    5. Update the TypeScript type declaration for the exposed API (if there's an `ElectronAPI` interface or similar) to include the new methods.

    **Save-on-navigate (note for integration -- the actual wiring happens when the editor component integrates useAutoSave):**

    The useAutoSave hook from Plan 01 already returns saveNow(). When the editor component unmounts (user navigates away), a useEffect cleanup should call saveNow(). This is a one-line integration in the editor component:

    ```typescript
    // In the editor component that uses useAutoSave:
    useEffect(() => {
      return () => { saveNow() }
    }, [saveNow])
    ```

    Add this pattern as a comment in use-auto-save.ts near the return statement, documenting that consumers should call saveNow() in their cleanup effect. OR, add a `useSaveOnUnmount(saveNow)` utility hook inside use-auto-save.ts that the editor component can call.

    **Save-on-close (Electron IPC integration):**

    Add a `useSaveOnQuit` hook (can be in use-auto-save.ts or a separate file) that:
    - Takes `saveNow: () => Promise<void>` as parameter
    - Uses useEffect to register for `window.electronAPI.onBeforeQuit` (or however the preload API is accessed)
    - When before-quit fires: calls `await saveNow()`, then calls `window.electronAPI.confirmQuitSave()`
    - Cleanup: unregisters the listener

    Check how the existing preload API is accessed in the renderer (look for `window.electronAPI` or `window.api` patterns in existing code).
  </action>
  <verify>
    Grep for `before-quit-save` in both main/index.ts and preload/index.ts.
    Grep for `isQuitting` in main/index.ts.
    Grep for `confirmQuitSave` in preload/index.ts.
    Grep for `beforeQuitCallbacks` in preload/index.ts to confirm Set pattern is used.
    Run `cd D:/FTX_CODE/pm-project/electron-app && npx tsc --noEmit --pretty 2>&1 | head -30`.
  </verify>
  <done>
    Electron main process intercepts close, sends IPC to renderer, waits up to 3 seconds. Preload exposes onBeforeQuit and confirmQuitSave following the existing callback Set pattern. useSaveOnQuit hook wires the IPC to saveNow(). Save-on-unmount pattern documented or provided as utility hook.
  </done>
</task>

<task type="auto">
  <name>Task 2: SaveStatus indicator component</name>
  <files>
    electron-app/src/renderer/components/knowledge/SaveStatus.tsx
  </files>
  <action>
    Create a `SaveStatus` React component that displays the current save state:

    1. Props: `{ status: SaveStatusType }` where `SaveStatusType` is imported from `use-auto-save.ts` (the type created in Plan 01).

    2. Rendering logic:
       - `state: 'idle'` -- render nothing (or faint "No changes" text if desired)
       - `state: 'saving'` -- render "Saving..." with a subtle spinner/pulse animation
       - `state: 'saved'` -- render "Saved Xs ago" where X updates every second
         - Use a `useEffect` with `setInterval(1000)` that recalculates `Math.floor((Date.now() - status.at) / 1000)` each tick
         - Display: "Saved just now" for <5s, "Saved Xs ago" for 5-59s, "Saved Xm ago" for 60s+
       - `state: 'error'` -- render "Save failed" in red/destructive color with the error message

    3. Styling:
       - Use Tailwind classes
       - Small, unobtrusive text (text-xs or text-sm, text-muted-foreground)
       - Meant to sit in the editor's bottom status bar (next to word count, per Phase 3)
       - Match the design language of existing components (check existing knowledge/ components)

    4. Export the component as named export.
  </action>
  <verify>
    Run `cd D:/FTX_CODE/pm-project/electron-app && npx tsc --noEmit --pretty 2>&1 | head -30`.
    Grep for `SaveStatus` export in the file.
    Confirm the component handles all four states (idle, saving, saved, error).
  </verify>
  <done>
    SaveStatus component renders real-time save state. "Saving..." with pulse during save, "Saved Xs ago" with live updating timer after save, "Save failed" in red on error. Styled with Tailwind to match existing knowledge base components.
  </done>
</task>

</tasks>

<verification>
1. Electron main process has `isQuitting` flag and `close` event handler with 3s timeout
2. Preload exposes `onBeforeQuit` and `confirmQuitSave` following existing callback Set pattern (beforeQuitCallbacks Set)
3. useSaveOnQuit hook (or equivalent) wires Electron IPC to saveNow()
4. SaveStatus component handles all four states: idle, saving, saved (with live timer), error
5. TypeScript compiles without errors
6. No new npm dependencies introduced
</verification>

<success_criteria>
- Electron app close triggers save via IPC before quitting (3s timeout prevents hang)
- Save-on-navigate pattern is available via useEffect cleanup calling saveNow()
- SaveStatus shows "Saving..." during save
- SaveStatus shows "Saved Xs ago" with live-updating relative time after save
- SaveStatus shows "Save failed" in red on error
- All wiring uses existing preload IPC patterns (callback Set pattern, not ad-hoc listeners)
</success_criteria>

<output>
After completion, create `.planning/phases/04-auto-save-content-pipeline/04-03-SUMMARY.md`
</output>
