---
phase: 03-rich-text-editor-core
plan: 04
type: execute
wave: 4
depends_on: ["03-03"]
files_modified:
  - electron-app/src/renderer/components/knowledge/editor-toolbar.tsx
  - electron-app/src/renderer/components/knowledge/document-editor.tsx
autonomous: true

must_haves:
  truths:
    - "User can insert and edit links via a dialog with URL input"
    - "User can select font family from a dropdown of 10 options"
    - "User can select font size from a dropdown of 4 options"
    - "User can set text foreground color from a color palette"
    - "Word count displays at the bottom of the editor"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/editor-toolbar.tsx"
      provides: "Link dialog, font family dropdown, font size dropdown, text color picker, highlight color picker"
      contains: "setLink"
    - path: "electron-app/src/renderer/components/knowledge/document-editor.tsx"
      provides: "EditorStatusBar with reactive word count"
      contains: "characterCount"
  key_links:
    - from: "editor-toolbar.tsx"
      to: "editor (TipTap)"
      via: "editor.chain().focus().setLink/setFontFamily/setMark for font size and color"
      pattern: "setLink|setFontFamily|fontSize|setColor"
    - from: "document-editor.tsx"
      to: "@tiptap/react useEditorState"
      via: "useEditorState selector reading characterCount storage"
      pattern: "useEditorState.*characterCount"
---

<objective>
Add link insertion dialog, font family/size dropdowns, text color/highlight pickers, and word count status bar to complete the editor toolbar.

Purpose: Covers requirements EDIT-07 (links), EDIT-08 (font family + size), EDIT-09 (text color), EDIT-14 (word count).
Output: Complete editor toolbar and status bar -- Phase 3 feature-complete.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-rich-text-editor-core/03-RESEARCH.md
@.planning/phases/03-rich-text-editor-core/03-03-SUMMARY.md
@electron-app/src/renderer/components/editor/RichTextEditor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add link dialog, font family/size dropdowns, and color pickers to toolbar</name>
  <files>
    electron-app/src/renderer/components/knowledge/editor-toolbar.tsx
  </files>
  <action>
    Read the current editor-toolbar.tsx. Replace the remaining placeholder comment with:

    1. **Link Insert/Edit** (new separator + group):
       - Import icons: Link2, Unlink from lucide-react
       - Import Popover, PopoverTrigger, PopoverContent from `@/components/ui/popover`
       - Import Input from `@/components/ui/input`
       - Import useState from react
       - Link button opens a Popover containing:
         - Input field for URL (controlled state, initialized from current link if editing: `editor.getAttributes('link').href`)
         - "Apply" button: `editor.chain().focus().extendMarkRange('link').setLink({ href: url }).run()` -- validate URL starts with http:// or https://, prepend https:// if missing
         - "Remove link" button (only when link is active): `editor.chain().focus().unsetLink().run()`
       - Link2 icon with active state when `editor.isActive('link')`

    2. **Separator** then **Font Family Dropdown**:
       - Import FONT_FAMILIES, DEFAULT_FONT_FAMILY from ./editor-extensions
       - Popover trigger shows current font family label (derive from `editor.getAttributes('textStyle').fontFamily` matching against FONT_FAMILIES array, default to "Arial")
       - PopoverContent: list of 10 font families, each renders in its own font (`style={{ fontFamily: family.value }}`)
       - On click: `editor.chain().focus().setFontFamily(family.value).run()`
       - Active family highlighted with `bg-primary/10`

    3. **Font Size Dropdown** (right after font family):
       - Import FONT_SIZES from ./editor-extensions
       - Popover trigger shows current size label (derive from `editor.getAttributes('textStyle').fontSize` matching FONT_SIZES, default "Normal")
       - PopoverContent: 4 size options
       - On click: `editor.chain().focus().setMark('textStyle', { fontSize: size.value }).run()`
       - Active size highlighted

    4. **Separator** then **Text Color Picker**:
       - Import COLORS from ./editor-extensions
       - Import icons: Palette (or Type with color indicator) from lucide-react
       - Popover trigger: icon with a colored underline bar showing current text color (from `editor.getAttributes('textStyle').color` or default black)
       - PopoverContent: grid of 60 color swatches (6 columns x 10 rows), each a 6x6 (w-6 h-6) rounded button with the color as background
       - On click: `editor.chain().focus().setColor(color).run()`
       - Include a "Reset" / "Default" option that calls `editor.chain().focus().unsetColor().run()`

    5. **Highlight Color Picker** (right after text color):
       - Import HIGHLIGHT_COLORS from ./editor-extensions
       - Import icon: Highlighter from lucide-react
       - Same Popover pattern as text color but with HIGHLIGHT_COLORS (40 swatches, 4 columns x 10 rows)
       - On click: `editor.chain().focus().toggleHighlight({ color }).run()`
       - Include "Remove highlight" option: `editor.chain().focus().unsetHighlight().run()`

    Reference the RichTextEditor.tsx toolbar (lines 400-900+) for the exact patterns used for color pickers, font dropdowns, and link handling. Match the visual style (color swatch grids, popover layouts).
  </action>
  <verify>
    - `cd electron-app && npx tsc --noEmit` passes
    - editor-toolbar.tsx contains setLink, setFontFamily, setColor, toggleHighlight calls
    - Link popover has URL input and apply/remove buttons
    - Font family shows 10 options, font size shows 4 options
    - Color pickers show swatch grids
  </verify>
  <done>
    Toolbar has link insert/edit popover with URL input, font family dropdown (10 options), font size dropdown (4 options), text color picker (60 colors + reset), and highlight color picker (40 colors + remove). All use Popover components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add word count status bar to DocumentEditor</name>
  <files>
    electron-app/src/renderer/components/knowledge/document-editor.tsx
  </files>
  <action>
    Read the current document-editor.tsx. Add the word count status bar:

    1. Create an `EditorStatusBar` component (inline in document-editor.tsx or as a small helper):
       - Import useEditorState from '@tiptap/react'
       - Accept `{ editor: Editor }` prop
       - Use useEditorState for reactive word/character count:
         ```typescript
         const { wordCount, charCount } = useEditorState({
           editor,
           selector: (ctx) => ({
             wordCount: ctx.editor.storage.characterCount?.words() ?? 0,
             charCount: ctx.editor.storage.characterCount?.characters() ?? 0,
           }),
         })
         ```
       - Render: `<div className="flex items-center justify-between px-3 py-1.5 border-t text-xs text-muted-foreground">`
       - Left side: `{wordCount} words`
       - Right side: `{charCount} characters`

    2. In the DocumentEditor render, replace the status bar placeholder comment with:
       ```
       <EditorStatusBar editor={editor} />
       ```
       This should appear below the EditorContent, inside the outer container div.
       Show the status bar regardless of editable state (word count is useful in read-only too).
  </action>
  <verify>
    - `cd electron-app && npx tsc --noEmit` passes
    - document-editor.tsx imports useEditorState and reads characterCount storage
    - Status bar renders word count and character count
  </verify>
  <done>
    Word count and character count display reactively at the bottom of the editor. Updates as user types. Visible in both editable and read-only modes.
  </done>
</task>

</tasks>

<verification>
- `cd electron-app && npx tsc --noEmit` passes
- ALL toolbar sections complete: undo/redo, basic formatting, headings, lists, code block, indent, table, link, fonts, colors
- Word count displays at bottom of editor
- Editor is feature-complete for Phase 3 requirements
</verification>

<success_criteria>
- EDIT-01: Bold, italic, underline, strikethrough in toolbar (from 03-01)
- EDIT-02: Headings H1-H6 via dropdown (from 03-02)
- EDIT-03: Bullet lists, numbered lists, indentation (from 03-02)
- EDIT-04: Interactive checklists (from 03-02)
- EDIT-05: Tables with resizable columns, add/remove rows/cols (from 03-03)
- EDIT-06: Code blocks with syntax highlighting (from 03-02 button + 03-01 extension)
- EDIT-07: Links insertable and clickable (this plan)
- EDIT-08: Font family and font size controls (this plan)
- EDIT-09: Text foreground color (this plan)
- EDIT-14: Word count at bottom of editor (this plan)
- Phase 3 is COMPLETE
</success_criteria>

<output>
After completion, create `.planning/phases/03-rich-text-editor-core/03-04-SUMMARY.md`
</output>
