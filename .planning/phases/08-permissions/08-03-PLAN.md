---
phase: 08-permissions
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - electron-app/src/renderer/hooks/use-document-permissions.ts
  - electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
  - electron-app/src/renderer/components/knowledge/folder-context-menu.tsx
  - electron-app/src/renderer/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "useDocumentPermissions hook derives canCreate, canEdit, canDelete, canForceUnlock, and isReadOnly from existing user_role data"
    - "Viewers cannot see create/edit/delete controls in the sidebar (buttons hidden, context menu items removed)"
    - "Editors see create and edit controls but not delete controls for application-scoped documents"
    - "Personal scope shows full controls only for the document owner"
  artifacts:
    - path: "electron-app/src/renderer/hooks/use-document-permissions.ts"
      provides: "useDocumentPermissions hook returning DocumentPermissions object"
      min_lines: 30
    - path: "electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx"
      provides: "Permission-aware sidebar hiding create controls for viewers"
      contains: "useDocumentPermissions"
    - path: "electron-app/src/renderer/components/knowledge/folder-context-menu.tsx"
      provides: "Permission-aware context menu hiding edit/delete items for unauthorized users"
      contains: "canCreate\\|canEdit\\|canDelete"
  key_links:
    - from: "electron-app/src/renderer/hooks/use-document-permissions.ts"
      to: "application.user_role"
      via: "derives permissions from cached TanStack Query data"
      pattern: "user_role|applicationUserRole"
    - from: "electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx"
      to: "electron-app/src/renderer/hooks/use-document-permissions.ts"
      via: "imports and uses permission hook to conditionally render controls"
      pattern: "useDocumentPermissions"
---

<objective>
Create a frontend permission hook and apply it to knowledge base UI components so that edit/create/delete controls are hidden or disabled based on the user's role.

Purpose: The backend enforces permissions (Plan 02), but the UI should not show controls the user cannot use. This prevents confusing 403 errors and provides a clean experience for viewers and editors.
Output: New `useDocumentPermissions` hook and updated sidebar/context-menu components.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-permissions/08-RESEARCH.md

Key source files:
@electron-app/src/renderer/hooks/use-document-permissions.ts (NEW)
@electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
@electron-app/src/renderer/components/knowledge/folder-context-menu.tsx
@electron-app/src/renderer/components/knowledge/folder-tree.tsx
@electron-app/src/renderer/contexts/knowledge-base-context.tsx
@electron-app/src/renderer/pages/applications/[id].tsx (existing user_role pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDocumentPermissions hook</name>
  <files>
    electron-app/src/renderer/hooks/use-document-permissions.ts
    electron-app/src/renderer/hooks/index.ts
  </files>
  <action>
Create `electron-app/src/renderer/hooks/use-document-permissions.ts` with:

1. Export a `DocumentPermissions` interface:
```typescript
export interface DocumentPermissions {
  canCreate: boolean
  canEdit: boolean
  canDelete: boolean
  canForceUnlock: boolean
  isReadOnly: boolean
}
```

2. Export a `useDocumentPermissions` function that takes:
   - `scope: 'personal' | 'application' | 'project'`
   - `applicationUserRole: string | null | undefined` (the user_role field from the application response)
   - `isPersonalOwner: boolean` (whether the current user owns the personal scope)

Logic:
- If `scope === 'personal'`:
  - All permissions based on `isPersonalOwner`
  - `canForceUnlock: false` (no force-unlock on personal docs)
  - `isReadOnly: !isPersonalOwner`

- If `scope === 'application'` or `scope === 'project'`:
  - `isOwner = applicationUserRole === 'owner'`
  - `isEditor = applicationUserRole === 'editor'`
  - `canCreate: isOwner || isEditor`
  - `canEdit: isOwner || isEditor`
  - `canDelete: isOwner` (only owners delete)
  - `canForceUnlock: isOwner` (PERM-02)
  - `isReadOnly: !isOwner && !isEditor`

- Default (no role): all false, `isReadOnly: true`

Use `useMemo` to memoize the result based on the three inputs.

3. Add the export to `electron-app/src/renderer/hooks/index.ts`:
```typescript
export { useDocumentPermissions } from './use-document-permissions'
export type { DocumentPermissions } from './use-document-permissions'
```
  </action>
  <verify>
Run:
```bash
cd D:/FTX_CODE/pm-project/electron-app
npx tsc --noEmit --pretty 2>&1 | head -30
```
Should compile without errors related to the new hook.
  </verify>
  <done>
useDocumentPermissions hook exists, exported from hooks/index.ts, returns memoized DocumentPermissions object based on scope and user role. Personal scope checks isPersonalOwner. App/project scope derives from applicationUserRole string.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply permissions to sidebar and context menu</name>
  <files>
    electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
    electron-app/src/renderer/components/knowledge/folder-context-menu.tsx
  </files>
  <action>
**knowledge-sidebar.tsx changes:**

The sidebar needs to know the current scope and user role to decide whether to show "New Document" and "New Folder" buttons.

1. Import `useDocumentPermissions` from `@/hooks`.

2. Determine how the sidebar currently gets scope information -- it uses `useKnowledgeBase()` context which has the current scope selection. Read the KnowledgeBaseContext to find the current scope and scope ID.

3. The sidebar needs the `applicationUserRole` for the selected scope. This is likely available from the application data fetched by TanStack Query hooks. Check how the scope filter component gets application data. The user_role should come from the application response object that's already cached.

4. Call `useDocumentPermissions(scope, applicationUserRole, isPersonalOwner)` in the sidebar.

5. Conditionally render the "New Folder" button area in the folder tree section: only show if `permissions.canCreate` is true.

6. Pass `permissions` (or individual boolean props `canCreate`, `canEdit`, `canDelete`) down to the `FolderTree` component as a prop.

**folder-context-menu.tsx changes:**

The context menu currently shows: New Folder, New Document, Rename, Move, Delete.

1. Accept permission props: `canCreate: boolean`, `canEdit: boolean`, `canDelete: boolean`.

2. Conditionally render menu items:
   - "New Folder" and "New Document": only if `canCreate`
   - "Rename" and "Move": only if `canEdit`
   - "Delete": only if `canDelete`

3. If no actions are available (viewer on app scope), either show a minimal context menu with just "Copy Name" or don't show the context menu at all. Simplest: if `!canCreate && !canEdit && !canDelete`, return null from the context menu trigger or show only read-only items.

**Important notes:**
- Do NOT add new API calls to fetch permissions. Derive everything from already-cached `user_role` data.
- The `user_role` comes from the application response which is already fetched by TanStack Query when the scope is selected.
- For personal scope, `isPersonalOwner` is always true for the current user (since they can only select their own personal scope).
- Read the actual component code before making changes to understand the current prop signatures and state flow.
  </action>
  <verify>
Run:
```bash
cd D:/FTX_CODE/pm-project/electron-app
npx tsc --noEmit --pretty 2>&1 | head -30
```
Should compile without errors.

Visual verification notes (for future UAT):
- As an owner: all sidebar controls visible, full context menu
- As an editor: create/edit visible, no delete in context menu
- As a viewer: no create/edit/delete controls visible
  </verify>
  <done>
Sidebar conditionally shows create controls based on permissions. Context menu conditionally shows CRUD items based on canCreate/canEdit/canDelete. Viewers see no mutation controls. Editors see create and edit but not delete (for app-scoped). Owners see all controls. No new API calls added -- all derived from cached user_role.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new errors
2. `use-document-permissions.ts` exports `useDocumentPermissions` and `DocumentPermissions`
3. `knowledge-sidebar.tsx` imports and uses `useDocumentPermissions`
4. `folder-context-menu.tsx` conditionally renders items based on permission props
5. No new API calls or fetch hooks added (permissions derived from existing cached data)
</verification>

<success_criteria>
- useDocumentPermissions hook exists and is properly typed
- Sidebar hides create controls for viewers
- Context menu hides edit/delete items for unauthorized users
- All permission decisions derived from cached user_role (no extra API calls)
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-permissions/08-03-SUMMARY.md`
</output>
