---
phase: 08-permissions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fastapi-backend/app/services/document_permission_service.py
autonomous: true

must_haves:
  truths:
    - "DocumentPermissionService exists and correctly resolves permissions for all three scopes (personal, application, project)"
    - "Personal scope checks enforce user_id == current_user.id"
    - "Application scope checks use PermissionService.get_user_application_role() for role-based decisions"
    - "Project scope checks apply the ProjectMember gate for editors (consistent with tasks.py)"
    - "Owner can create/edit/delete in application scope; editor can create/edit but not delete"
  artifacts:
    - path: "fastapi-backend/app/services/document_permission_service.py"
      provides: "DocumentPermissionService with can_read, can_edit, can_delete, can_create_in_scope, can_force_unlock, get_scope_filter_for_list methods"
      min_lines: 120
  key_links:
    - from: "fastapi-backend/app/services/document_permission_service.py"
      to: "fastapi-backend/app/services/permission_service.py"
      via: "wraps PermissionService for role lookups"
      pattern: "PermissionService"
    - from: "fastapi-backend/app/services/document_permission_service.py"
      to: "fastapi-backend/app/models/document.py"
      via: "reads scope FKs (application_id, project_id, user_id)"
      pattern: "document\\.(application_id|project_id|user_id)"
---

<objective>
Create the DocumentPermissionService class that encapsulates all document permission logic for the three scopes (personal, application, project).

Purpose: Centralizes permission decisions so that endpoint guards in Plan 02 call a single service rather than duplicating role-lookup logic. This is the foundation all other permission work builds on.
Output: `fastapi-backend/app/services/document_permission_service.py` with 6 methods covering PERM-01 through PERM-06.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-permissions/08-RESEARCH.md

Key source files to reference:
@fastapi-backend/app/services/permission_service.py
@fastapi-backend/app/models/document.py
@fastapi-backend/app/models/document_folder.py
@fastapi-backend/app/routers/tasks.py (lines 107-179 for verify_project_access pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DocumentPermissionService class</name>
  <files>fastapi-backend/app/services/document_permission_service.py</files>
  <action>
Create `fastapi-backend/app/services/document_permission_service.py` with a `DocumentPermissionService` class that wraps `PermissionService`.

The class takes `AsyncSession` in its constructor and creates an internal `PermissionService` instance.

Implement these methods:

1. `async def can_read_document(self, user: User, document: Document) -> bool`:
   - Personal scope (`document.user_id is not None`): return `document.user_id == user.id`
   - Application scope (`document.application_id is not None`): return `await self.permission_service.is_application_member(user.id, document.application_id)`
   - Project scope (`document.project_id is not None`): resolve project's application_id, then check `is_application_member(user.id, project.application_id)`
   - If none match, return False

2. `async def can_edit_document(self, user: User, document: Document) -> bool`:
   - Personal scope: return `document.user_id == user.id`
   - Application scope: get role via `get_user_application_role()`, return `role in ("owner", "editor")`
   - Project scope: get role via `get_user_application_role()` on project's application; if "owner" return True; if "editor" also check `is_project_member(user.id, document.project_id)` (ProjectMember gate, consistent with tasks.py); else return False

3. `async def can_delete_document(self, user: User, document: Document) -> bool`:
   - Personal scope: return `document.user_id == user.id` (creator is sole owner)
   - Application scope: only owner can delete (`role == "owner"`)
   - Project scope: only application owner can delete (`role == "owner"`)

4. `async def can_create_in_scope(self, user: User, scope: str, scope_id: UUID) -> bool`:
   - "personal": return `scope_id == user.id`
   - "application": get role, return `role in ("owner", "editor")`
   - "project": get role on project's application; owner always True; editor requires `is_project_member()`
   - Otherwise return False

5. `async def can_force_unlock(self, user: User, document: Document) -> bool`:
   - Personal scope: return `document.user_id == user.id` (only owner)
   - Application scope: return `role == "owner"` (PERM-02)
   - Project scope: return `role == "owner"` on project's application

6. `async def get_scope_filter_for_list(self, user: User, scope: str, scope_id: UUID) -> bool`:
   - "personal": return `scope_id == user.id` (PERM-05 hard-check)
   - "application": return `await is_application_member(user.id, scope_id)`
   - "project": resolve project's application_id, return `is_application_member(user.id, project.application_id)`

Helper method for DRY:
- `async def _get_project_application_id(self, project_id: UUID) -> Optional[UUID]`: fetches project with selectinload(Project.application), returns application_id or None.

Use the same import patterns as permission_service.py. Add module docstring explaining the three-scope permission model. Type hints on all methods.

Do NOT use `get_scope_filter()` from document_service.py -- that's for query filtering, not permission checking.
  </action>
  <verify>
Run: `cd D:/FTX_CODE/pm-project/fastapi-backend && python -c "from app.services.document_permission_service import DocumentPermissionService; print('Import OK')"`

Verify the file has all 6 public methods plus the helper:
`grep -c "async def " fastapi-backend/app/services/document_permission_service.py` should return 7.
  </verify>
  <done>
DocumentPermissionService exists with can_read_document, can_edit_document, can_delete_document, can_create_in_scope, can_force_unlock, get_scope_filter_for_list methods. All methods use PermissionService for role lookups. Personal scope always hard-checks user_id. Project scope applies ProjectMember gate for editors. Application delete is owner-only.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add convenience factory and verify with typecheck</name>
  <files>fastapi-backend/app/services/document_permission_service.py</files>
  <action>
At the bottom of the new file, add a module-level factory function matching the existing pattern in permission_service.py:

```python
def get_document_permission_service(db: AsyncSession) -> DocumentPermissionService:
    """Factory function for dependency injection."""
    return DocumentPermissionService(db)
```

Then run ruff to check the file:
```bash
cd D:/FTX_CODE/pm-project/fastapi-backend
ruff check app/services/document_permission_service.py --fix
```

Fix any linting issues (unused imports, formatting).

Verify the service can be instantiated by running a quick Python import check.
  </action>
  <verify>
Run:
```bash
cd D:/FTX_CODE/pm-project/fastapi-backend
ruff check app/services/document_permission_service.py
python -c "from app.services.document_permission_service import DocumentPermissionService, get_document_permission_service; print('All exports OK')"
```
Both commands should succeed with no errors.
  </verify>
  <done>
DocumentPermissionService passes ruff lint checks, imports cleanly, has factory function for FastAPI dependency injection. File is ready for Plan 02 to consume.
  </done>
</task>

</tasks>

<verification>
1. File exists: `fastapi-backend/app/services/document_permission_service.py`
2. Imports succeed: `from app.services.document_permission_service import DocumentPermissionService`
3. Ruff clean: `ruff check app/services/document_permission_service.py` returns 0 errors
4. Method count: 7 async methods (6 public + 1 private helper)
5. PermissionService is used (not re-implementing role lookups)
6. Personal scope uses `== user.id` checks (not membership lookups)
</verification>

<success_criteria>
- DocumentPermissionService class exists with all 6 public permission methods
- All methods type-hinted and documented
- Personal scope enforces strict user_id == current_user.id
- Project scope applies ProjectMember gate for editors
- Application delete is owner-only
- Ruff passes with zero errors
- Factory function available for FastAPI Depends()
</success_criteria>

<output>
After completion, create `.planning/phases/08-permissions/08-01-SUMMARY.md`
</output>
