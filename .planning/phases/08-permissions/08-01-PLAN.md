---
phase: 08-permissions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fastapi-backend/app/services/document_permission_service.py
autonomous: true

must_haves:
  truths:
    - "DocumentPermissionService correctly determines read/edit/delete/create permissions for all three scopes"
    - "Personal scope returns true only for the document creator"
    - "Application scope returns owner+editor for edit, owner-only for delete"
    - "Project scope applies ProjectMember gate for editors (consistent with tasks.py)"
    - "Scope list access check prevents unauthorized users from listing documents in a scope"
  artifacts:
    - path: "fastapi-backend/app/services/document_permission_service.py"
      provides: "DocumentPermissionService class with can_read, can_edit, can_delete, can_create_in_scope, get_scope_filter_for_list"
      exports: ["DocumentPermissionService"]
      min_lines: 80
  key_links:
    - from: "fastapi-backend/app/services/document_permission_service.py"
      to: "fastapi-backend/app/services/permission_service.py"
      via: "Wraps PermissionService for role lookups"
      pattern: "PermissionService"
    - from: "document_permission_service.py"
      to: "fastapi-backend/app/models/document.py"
      via: "Reads document scope FKs (application_id, project_id, user_id)"
      pattern: "document\\.(application_id|project_id|user_id)"
---

<objective>
Create the DocumentPermissionService class that maps document scopes (personal, application, project) to the correct permission checks using the existing PermissionService.

Purpose: This is the centralized authorization layer for all document, folder, and tag operations. Plan 08-02 will wire it into every endpoint.
Output: A single new service file with 5 public methods covering all permission scenarios.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-permissions/08-RESEARCH.md

@fastapi-backend/app/services/permission_service.py
@fastapi-backend/app/models/document.py
@fastapi-backend/app/models/document_folder.py
@fastapi-backend/app/routers/tasks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DocumentPermissionService</name>
  <files>fastapi-backend/app/services/document_permission_service.py</files>
  <action>
Create `fastapi-backend/app/services/document_permission_service.py` with a `DocumentPermissionService` class that wraps the existing `PermissionService`.

The class takes `db: AsyncSession` in its constructor (same pattern as PermissionService) and creates an internal PermissionService instance.

Implement these 5 public async methods:

1. `can_read_document(user: User, document: Document) -> bool`
   - Personal (user_id set): return document.user_id == user.id
   - Application (application_id set): return is_application_member(user.id, document.application_id)
   - Project (project_id set): get project with application, return is_application_member(user.id, project.application_id)
   - Default: return False

2. `can_edit_document(user: User, document: Document) -> bool`
   - Personal: return document.user_id == user.id
   - Application: get_user_application_role, return role in ("owner", "editor")
   - Project: get role via get_user_application_role on project.application_id. Owner=True. Editor=True only if also is_project_member(user.id, document.project_id). Viewer/None=False.
   - Default: return False

3. `can_delete_document(user: User, document: Document) -> bool`
   - Personal: return document.user_id == user.id (creator can delete own)
   - Application: owner-only (get_user_application_role, return role == "owner")
   - Project: same as can_edit_document (editors who are project members can delete project docs)
   - Default: return False

4. `can_create_in_scope(user: User, scope: str, scope_id: UUID) -> bool`
   - "personal": return scope_id == user.id
   - "application": get_user_application_role, return role in ("owner", "editor")
   - "project": get project with application, owner=True, editor=True only if is_project_member
   - Default: return False

5. `get_scope_filter_for_list(user: User, scope: str, scope_id: UUID) -> bool`
   - "personal": return scope_id == user.id
   - "application": return is_application_member(user.id, scope_id)
   - "project": get project with application, return is_application_member(user.id, project.application_id)
   - Default: return False

Use existing PermissionService methods -- do NOT hand-roll role lookups:
- `self.permission_service.get_user_application_role(user_id, application_id)` returns Optional[str] ("owner"/"editor"/"viewer")
- `self.permission_service.is_application_member(user_id, application_id)` returns bool
- `self.permission_service.is_project_member(user_id, project_id)` returns bool
- `self.permission_service.get_project_with_application(project_id)` returns Optional[Project] with application eager-loaded

Import User from `app.models.user`, Document from `app.models.document`, UUID from `uuid`, AsyncSession from `sqlalchemy.ext.asyncio`.

Add proper docstrings matching existing codebase style (see permission_service.py).
  </action>
  <verify>
Run: `cd D:/FTX_CODE/pm-project/fastapi-backend && python -c "from app.services.document_permission_service import DocumentPermissionService; print('Import OK')"`

Verify the class has all 5 methods: `python -c "from app.services.document_permission_service import DocumentPermissionService; methods = [m for m in dir(DocumentPermissionService) if not m.startswith('_')]; print(methods); assert 'can_read_document' in methods; assert 'can_edit_document' in methods; assert 'can_delete_document' in methods; assert 'can_create_in_scope' in methods; assert 'get_scope_filter_for_list' in methods; print('All methods present')"`
  </verify>
  <done>DocumentPermissionService class exists with all 5 methods, imports cleanly, and delegates to PermissionService for all role lookups.</done>
</task>

<task type="auto">
  <name>Task 2: Verify existing force-take implementation (PERM-02)</name>
  <files>fastapi-backend/app/routers/document_locks.py</files>
  <action>
Read `fastapi-backend/app/routers/document_locks.py` and verify the force-take endpoint already:
1. Rejects force-take on personal documents (application_id is None check)
2. Checks owner role via PermissionService.get_user_application_role
3. Returns 403 for non-owners

If all three are confirmed, this task is done with no code changes.

Also verify the lock acquire endpoint (`POST /{document_id}/lock`). Per research open question 4, lock acquire should check can_edit_document to prevent viewers from locking. If it does NOT currently check permissions, add an inline permission check:
- Import DocumentPermissionService
- After fetching the document, instantiate DocumentPermissionService(db)
- Call can_edit_document(current_user, document)
- Raise 403 if False with message "You do not have permission to edit this document"

Do NOT modify force-take -- it already works. Only add the acquire guard if missing.
  </action>
  <verify>
Read `document_locks.py` and confirm:
1. Force-take has owner check (grep for "owner" in force_take function)
2. Lock acquire has can_edit_document check (grep for "can_edit" or "permission" in acquire function)
  </verify>
  <done>PERM-02 (force-unlock by owner) is verified working. Lock acquire prevents viewers from locking documents they cannot edit.</done>
</task>

</tasks>

<verification>
- `python -c "from app.services.document_permission_service import DocumentPermissionService"` succeeds
- DocumentPermissionService has exactly 5 public methods
- No direct role-lookup queries in DocumentPermissionService (all delegated to PermissionService)
- Lock acquire endpoint has permission check
</verification>

<success_criteria>
- DocumentPermissionService is importable and has can_read, can_edit, can_delete, can_create_in_scope, get_scope_filter_for_list
- Personal scope always checks user_id == user.id
- Application scope checks owner/editor roles via PermissionService
- Project scope applies ProjectMember gate for editors
- Lock acquire endpoint prevents viewers from acquiring locks
</success_criteria>

<output>
After completion, create `.planning/phases/08-permissions/08-01-SUMMARY.md`
</output>
