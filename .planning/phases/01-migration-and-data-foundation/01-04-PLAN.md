---
phase: 01-migration-and-data-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-03"]
files_modified:
  # Backend CREATE
  - fastapi-backend/app/models/document_tag.py
  - fastapi-backend/app/schemas/document_tag.py
  - fastapi-backend/app/routers/document_tags.py
  - fastapi-backend/alembic/versions/XXX_add_document_tags_and_trash.py
  # Backend MODIFY
  - fastapi-backend/app/models/__init__.py
  - fastapi-backend/app/models/document.py
  - fastapi-backend/app/schemas/__init__.py
  - fastapi-backend/app/schemas/document.py
  - fastapi-backend/app/routers/__init__.py
  - fastapi-backend/app/routers/documents.py
  - fastapi-backend/app/services/document_service.py
  - fastapi-backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "Tags can be created within an application scope (scoped per application)"
    - "Tags can be created in a personal namespace (scoped per user)"
    - "Tags can be assigned to documents via API"
    - "A project-scoped document can use tags from its parent application"
    - "A personal document can only use tags from its personal namespace"
    - "Tags can be queried by scope — GET /api/document-tags returns tags for a given scope"
    - "Soft-deleted documents are excluded from normal list queries"
    - "Soft-deleted documents appear in the trash endpoint (GET /api/documents/trash)"
    - "Soft-deleted documents can be restored via POST /api/documents/{id}/restore"
    - "Permanently deleted documents are gone via DELETE /api/documents/{id}/permanent"
  artifacts:
    - path: "fastapi-backend/app/models/document_tag.py"
      provides: "DocumentTag and DocumentTagAssignment models"
      contains: "class DocumentTag"
    - path: "fastapi-backend/app/schemas/document_tag.py"
      provides: "Pydantic schemas for tag CRUD and assignment"
      exports: ["TagCreate", "TagUpdate", "TagResponse", "TagAssignment"]
    - path: "fastapi-backend/app/routers/document_tags.py"
      provides: "Tag CRUD and assignment endpoints"
      contains: "router = APIRouter"
    - path: "fastapi-backend/app/routers/documents.py"
      provides: "Trash, restore, and permanent delete endpoints"
      contains: "restore"
  key_links:
    - from: "fastapi-backend/app/routers/document_tags.py"
      to: "fastapi-backend/app/models/document_tag.py"
      via: "SQLAlchemy queries"
      pattern: "select\\(DocumentTag\\)"
    - from: "fastapi-backend/app/routers/documents.py"
      to: "fastapi-backend/app/models/document.py"
      via: "deleted_at filter for trash"
      pattern: "deleted_at\\.isnot\\(None\\)"
    - from: "fastapi-backend/app/services/document_service.py"
      to: "tag scope validation"
      via: "validate_tag_scope function"
      pattern: "validate_tag_scope"
---

<objective>
Add the tag system (DocumentTag + DocumentTagAssignment models, CRUD endpoints, tag assignment to documents) and the trash/restore/permanent-delete endpoints for soft-deleted documents.

Purpose: Tags provide cross-cutting organization for documents (filtering by tag in sidebar, Phase 2). Soft delete with trash completes the document lifecycle — users can recover accidentally deleted documents within 30 days. Together these satisfy DATA-04, DATA-07, and complete the data model foundation.

Output: Working tag CRUD and assignment API. Working trash, restore, and permanent delete endpoints. Alembic migration for tag tables.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-migration-and-data-foundation/01-CONTEXT.md
@.planning/phases/01-migration-and-data-foundation/01-RESEARCH.md
@.planning/phases/01-migration-and-data-foundation/01-03-SUMMARY.md

Key reference files:
@fastapi-backend/app/models/document.py
@fastapi-backend/app/models/document_folder.py
@fastapi-backend/app/schemas/document.py
@fastapi-backend/app/routers/documents.py
@fastapi-backend/app/services/document_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DocumentTag and DocumentTagAssignment models with Alembic migration</name>
  <files>
    fastapi-backend/app/models/document_tag.py (CREATE)
    fastapi-backend/app/models/__init__.py (MODIFY)
    fastapi-backend/app/models/document.py (MODIFY)
    fastapi-backend/alembic/env.py (MODIFY if needed)
    fastapi-backend/alembic/versions/XXX_add_document_tags.py (CREATE via alembic)
  </files>
  <action>
    **1. Create `fastapi-backend/app/models/document_tag.py`:**

    This file contains TWO models:

    **DocumentTag** — the tag definition:
    - `__tablename__ = "DocumentTags"`, `__allow_unmapped__ = True`
    - `id`: UUID primary key, default uuid.uuid4
    - `name`: String(100), not null
    - `color`: String(7), nullable — hex color code (e.g., "#FF5733") for UI display
    - Scope columns (tags are scoped per application or per user for personal):
      - `application_id`: nullable FK to Applications.id (ondelete CASCADE), indexed
      - `user_id`: nullable FK to Users.id (ondelete CASCADE), indexed — for personal tag namespace
    - CHECK constraint: exactly one of (application_id, user_id) is non-null (name: `ck_document_tags_exactly_one_scope`)
    - Unique constraint: (application_id, name) and (user_id, name) — no duplicate tag names within a scope. Use two partial unique indexes (where application_id is not null / where user_id is not null).
    - `created_at`: DateTime with utcnow default
    - Relationships: `assignments` (one-to-many to DocumentTagAssignment)
    - Docstring

    **DocumentTagAssignment** — the many-to-many join table:
    - `__tablename__ = "DocumentTagAssignments"`, `__allow_unmapped__ = True`
    - `id`: UUID primary key, default uuid.uuid4
    - `document_id`: FK to Documents.id (ondelete CASCADE), not null, indexed
    - `tag_id`: FK to DocumentTags.id (ondelete CASCADE), not null, indexed
    - Unique constraint: (document_id, tag_id) — no duplicate assignments
    - `created_at`: DateTime with utcnow default
    - Relationships: `document` (many-to-one), `tag` (many-to-one)

    **2. Update `fastapi-backend/app/models/document.py`:**
    - Add `tags` relationship: `relationship("DocumentTagAssignment", back_populates="document", cascade="all, delete-orphan")`
    - This allows eager loading of tags when fetching a document

    **3. Update `fastapi-backend/app/models/__init__.py`:**
    - Add imports for DocumentTag and DocumentTagAssignment

    **4. Generate Alembic migration:**
    - `cd fastapi-backend && alembic revision --autogenerate -m "add document tags"`
    - Review and ensure CHECK constraints and unique indexes are included
    - Run `alembic upgrade head` to apply
  </action>
  <verify>
    - `python -c "from app.models import DocumentTag, DocumentTagAssignment; print('OK')"`
    - `alembic upgrade head` succeeds
    - Database has DocumentTags and DocumentTagAssignments tables
    - Unique constraints exist on (application_id, name) and (user_id, name) for tags
    - Unique constraint exists on (document_id, tag_id) for assignments
  </verify>
  <done>
    DocumentTag and DocumentTagAssignment models created. Tags are scoped per application (for app/project docs) or per user (for personal docs). Unique constraints prevent duplicate tag names within a scope and duplicate assignments. Alembic migration applied successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tag schemas, tag endpoints, and trash/restore endpoints</name>
  <files>
    fastapi-backend/app/schemas/document_tag.py (CREATE)
    fastapi-backend/app/routers/document_tags.py (CREATE)
    fastapi-backend/app/routers/documents.py (MODIFY)
    fastapi-backend/app/services/document_service.py (MODIFY)
    fastapi-backend/app/schemas/document.py (MODIFY)
    fastapi-backend/app/schemas/__init__.py (MODIFY)
    fastapi-backend/app/routers/__init__.py (MODIFY)
    fastapi-backend/app/main.py (MODIFY)
  </files>
  <action>
    **1. Create `fastapi-backend/app/schemas/document_tag.py`:**

    - `TagCreate(BaseModel)`:
      - `name`: str (min 1, max 100)
      - `color`: str | None = None (hex color, validate pattern)
      - `scope`: Literal["application", "personal"]
      - `scope_id`: UUID — application_id or user_id

    - `TagUpdate(BaseModel)`:
      - `name`: str | None = None
      - `color`: str | None = None

    - `TagResponse(BaseModel)`:
      - id, name, color, application_id, user_id, created_at
      - `model_config = ConfigDict(from_attributes=True)`

    - `TagAssignment(BaseModel)`:
      - `tag_id`: UUID

    - `TagAssignmentResponse(BaseModel)`:
      - id, document_id, tag_id, created_at
      - `model_config = ConfigDict(from_attributes=True)`

    **2. Create `fastapi-backend/app/routers/document_tags.py`:**

    Endpoints:
    - `GET /api/document-tags` — list tags for a scope
      - Query params: `scope` (required: "application" | "personal"), `scope_id` (required)
      - Returns `list[TagResponse]`
    - `POST /api/document-tags` — create tag
      - Body: `TagCreate`
      - Validates scope, sets correct FK
      - Returns `TagResponse` with 201
    - `PUT /api/document-tags/{tag_id}` — update tag name/color
      - Body: `TagUpdate`
      - Returns `TagResponse`
    - `DELETE /api/document-tags/{tag_id}` — delete tag
      - Cascades to delete all assignments
      - Returns 204
    - `POST /api/documents/{document_id}/tags` — assign tag to document
      - Body: `TagAssignment`
      - **Validates tag scope compatibility:**
        - If document is application-scoped: tag must belong to that application
        - If document is project-scoped: tag must belong to the project's parent application (look up project.application_id)
        - If document is personal: tag must belong to the same user
      - Returns `TagAssignmentResponse` with 201
      - Returns 409 if already assigned
    - `DELETE /api/documents/{document_id}/tags/{tag_id}` — remove tag from document
      - Returns 204

    **3. Add tag scope validation to `fastapi-backend/app/services/document_service.py`:**
    - `validate_tag_scope(db: AsyncSession, document: Document, tag: DocumentTag) -> bool`
      - Check that the tag's scope is compatible with the document's scope
      - For project-scoped documents: look up the project to get its application_id, then check tag.application_id matches

    **4. Add trash/restore endpoints to `fastapi-backend/app/routers/documents.py`:**

    Add these endpoints to the existing documents router:
    - `GET /api/documents/trash` — list user's trashed documents
      - Filters `deleted_at IS NOT NULL`
      - Shows documents across all scopes that the user created (created_by = current_user.id)
      - Cursor-based pagination
      - Returns `DocumentListResponse`
    - `POST /api/documents/{document_id}/restore` — restore from trash
      - Sets `deleted_at = None`
      - Returns `DocumentResponse`
      - Returns 404 if document not found or not in trash
    - `DELETE /api/documents/{document_id}/permanent` — permanently delete
      - Hard deletes the document record
      - Returns 204
      - Returns 404 if not found

    **IMPORTANT:** The `GET /api/documents/trash` route MUST be registered BEFORE `GET /api/documents/{document_id}` to avoid the path parameter matching "trash" as a document_id.

    **5. Update `fastapi-backend/app/schemas/document.py`:**
    - Add `tags: list[TagResponse] = []` to `DocumentResponse` for including tags on single document fetch

    **6. Update `fastapi-backend/app/schemas/__init__.py`:**
    - Add tag schema imports/exports

    **7. Update `fastapi-backend/app/routers/__init__.py`:**
    - Add `document_tags_router` import

    **8. Update `fastapi-backend/app/main.py`:**
    - Include document_tags router: `app.include_router(document_tags_router, prefix="/api", tags=["document-tags"])`
  </action>
  <verify>
    - Server starts: `uvicorn app.main:app --port 8001` boots clean
    - Tag CRUD works: create tag in application scope, list tags for that application
    - Tag assignment works: assign tag to document, verify tag appears in document GET response
    - Tag scope validation works: assigning a tag from wrong application returns 400/403
    - Trash works: soft-delete a document, verify it appears in trash list, not in normal list
    - Restore works: restore document, verify it appears in normal list, not in trash
    - Permanent delete works: permanently delete, verify 404 on subsequent GET
    - Project-scoped doc can use parent application's tags
    - Personal doc can only use personal tags
  </verify>
  <done>
    Tag system fully working: tags scoped per application (used by app and project docs) and per user (personal docs). Tags can be assigned to documents with scope validation. Trash endpoint lists soft-deleted documents. Restore moves documents out of trash. Permanent delete hard-removes documents. All endpoints require authentication.
  </done>
</task>

</tasks>

<verification>
1. Server starts cleanly with all new routes registered
2. Tag CRUD: create, list, update, delete tags within a scope
3. Tag assignment: assign/unassign tags on documents, scope validation enforced
4. Trash: soft-deleted docs in trash, not in normal list
5. Restore: document moves out of trash back to normal
6. Permanent delete: document fully removed
7. Tag scope inheritance: project docs use application tags
8. Personal tag isolation: personal tags only on personal docs
</verification>

<success_criteria>
- Tags can be created, listed, updated, deleted within application and personal scopes
- Tags can be assigned to documents with scope compatibility validation
- Project-scoped documents can use their parent application's tags
- Personal documents can only use personal-namespace tags
- Soft-deleted documents appear in trash, not in normal queries
- Documents can be restored from trash
- Documents can be permanently deleted
- All new routes are registered and server boots clean
</success_criteria>

<output>
After completion, create `.planning/phases/01-migration-and-data-foundation/01-04-SUMMARY.md`
</output>
