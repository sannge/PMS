---
phase: 01-migration-and-data-foundation
plan: 04
subsystem: knowledge-base-tags-and-trash
tags: [models, schemas, api, tags, trash, restore, soft-delete, alembic]
dependency-graph:
  requires: [01-03]
  provides: [document-tag-system, trash-restore-api, tag-scope-validation]
  affects: [02-01, 02-02, 04-01]
tech-stack:
  added: []
  removed: []
  patterns: [scoped-tags, partial-unique-indexes, scope-compatibility-validation, soft-delete-lifecycle]
key-files:
  created:
    - fastapi-backend/app/models/document_tag.py
    - fastapi-backend/app/schemas/document_tag.py
    - fastapi-backend/app/routers/document_tags.py
    - fastapi-backend/alembic/versions/20260131_183412_add_document_tags.py
  modified:
    - fastapi-backend/app/models/__init__.py
    - fastapi-backend/app/models/document.py
    - fastapi-backend/app/schemas/__init__.py
    - fastapi-backend/app/schemas/document.py
    - fastapi-backend/app/routers/__init__.py
    - fastapi-backend/app/routers/documents.py
    - fastapi-backend/app/services/document_service.py
    - fastapi-backend/app/main.py
    - fastapi-backend/alembic/env.py
decisions:
  - id: tag-scope-model
    decision: "Tags scoped per application (shared across app + project docs) or per user (personal docs only)"
    rationale: "Application tags cover project-scoped documents via parent application lookup; simpler than project-level tags"
  - id: partial-unique-indexes
    decision: "Partial unique indexes for tag name uniqueness within scope instead of composite unique constraint"
    rationale: "PostgreSQL partial indexes handle nullable FK columns correctly where composite unique would not"
metrics:
  duration: ~7 min
  completed: 2026-01-31
---

# Phase 01 Plan 04: Document Tags and Trash Summary

**One-liner:** Scoped tag system (application + personal) with assignment validation, plus trash/restore/permanent-delete document lifecycle endpoints.

## What Was Done

### Task 1: DocumentTag and DocumentTagAssignment models + migration
- Created `DocumentTag` model with application_id/user_id scope columns and CHECK constraint enforcing exactly one scope
- Created `DocumentTagAssignment` many-to-many join table with unique (document_id, tag_id) constraint
- Added partial unique indexes `uq_document_tags_app_name` and `uq_document_tags_user_name` for tag name uniqueness within scope
- Added `tags` relationship on Document model
- Generated and cleaned Alembic migration (removed autogenerate noise from unrelated tables)
- Commit: `bac9a06`

### Task 2: Tag schemas, endpoints, and trash/restore
- Created Pydantic schemas: TagCreate, TagUpdate, TagResponse, TagAssignment, TagAssignmentResponse
- Created tag CRUD router (`/api/document-tags`): list, create, update, delete tags within a scope
- Added tag assignment endpoints on documents router: POST/DELETE `/{document_id}/tags`
- Implemented `validate_tag_scope` service function:
  - Application docs: tag must match application_id
  - Project docs: tag must match project's parent application_id (looked up via DB query)
  - Personal docs: tag must match user_id
- Added trash endpoint: GET `/api/documents/trash` (registered before `/{document_id}` to avoid path matching)
- Added restore endpoint: POST `/api/documents/{id}/restore`
- Added permanent delete endpoint: DELETE `/api/documents/{id}/permanent`
- Updated DocumentResponse to include `tags` list
- Registered document_tags router in main.py
- Commit: `f84e964`

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Tags scoped per application or user (not per project) | Application-level tags cover project docs via parent lookup; simpler model, fewer tables |
| Partial unique indexes for tag name uniqueness | PostgreSQL handles nullable FK columns correctly with partial indexes; composite unique would allow duplicates |
| Trash route before parameterized route | FastAPI matches routes in order; `/trash` must precede `/{document_id}` |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Cleaned autogenerated Alembic migration**
- **Found during:** Task 1
- **Issue:** Alembic autogenerate detected spurious index drops and server_default changes for unrelated tables
- **Fix:** Manually cleaned migration to only include DocumentTags and DocumentTagAssignments table creation
- **Files modified:** alembic/versions/20260131_183412_add_document_tags.py
- **Commit:** bac9a06

**2. [Rule 2 - Missing Critical] Fixed lint violations in new files**
- **Found during:** Task 2
- **Issue:** Unused imports (Document, DocumentTagAssignment, TagAssignment, etc.) in document_tags router and TYPE_CHECKING block in model
- **Fix:** Removed unused imports to satisfy ruff linting
- **Commit:** f84e964

## Verification

- All model imports work: `from app.models import DocumentTag, DocumentTagAssignment`
- Alembic migration applied successfully (DocumentTags and DocumentTagAssignments tables created)
- Server boots cleanly with all new routes registered (115 total routes)
- Tag CRUD router has 4 endpoints
- Documents router has 10 endpoints including trash, restore, permanent delete, and tag assignment
- Ruff lint passes on all modified files

## Next Phase Readiness

Phase 1 (Migration & Data Foundation) is now complete. All 4 plans executed:
- 01-01: Audit and WebSocket migration
- 01-02: Remove store shims
- 01-03: Knowledge base data model and CRUD API
- 01-04: Document tags and trash/restore (this plan)

Ready for Phase 2 (Knowledge Base UI Shell).
