---
phase: 01-migration-and-data-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  # Backend CREATE
  - fastapi-backend/app/models/document.py
  - fastapi-backend/app/models/document_folder.py
  - fastapi-backend/app/models/document_snapshot.py
  - fastapi-backend/app/schemas/document.py
  - fastapi-backend/app/schemas/document_folder.py
  - fastapi-backend/app/routers/documents.py
  - fastapi-backend/app/routers/document_folders.py
  - fastapi-backend/app/services/document_service.py
  - fastapi-backend/alembic/versions/XXX_drop_notes_create_documents.py
  # Backend MODIFY
  - fastapi-backend/app/models/__init__.py
  - fastapi-backend/app/schemas/__init__.py
  - fastapi-backend/app/routers/__init__.py
  - fastapi-backend/app/main.py
  - fastapi-backend/alembic/env.py
autonomous: true

must_haves:
  truths:
    - "Documents can be created in personal scope (user_id set)"
    - "Documents can be created in application scope (application_id set)"
    - "Documents can be created in project scope (project_id set)"
    - "Creating a document with more than one scope FK set is rejected (CHECK constraint)"
    - "Folders can be created and nested up to 5 levels deep within any scope"
    - "Folder tree endpoint returns the full tree for a scope in a single call"
    - "Documents without a folder_id appear in queries for unfiled documents"
    - "The database has a DocumentSnapshots table (empty, schema only)"
    - "Old Notes table is dropped in the same migration that creates new tables"
    - "Conversion stub functions exist in document_service.py for TipTap JSON to Markdown and plain text (returning empty string, ready for Phase 4)"
  artifacts:
    - path: "fastapi-backend/app/models/document.py"
      provides: "Document SQLAlchemy model with scope FKs, content columns, row_version, schema_version, soft delete"
      contains: "class Document"
    - path: "fastapi-backend/app/models/document_folder.py"
      provides: "DocumentFolder model with materialized_path, depth, scope FKs"
      contains: "class DocumentFolder"
    - path: "fastapi-backend/app/models/document_snapshot.py"
      provides: "DocumentSnapshot model (empty, for future version history)"
      contains: "class DocumentSnapshot"
    - path: "fastapi-backend/app/schemas/document.py"
      provides: "Pydantic schemas for document CRUD"
      exports: ["DocumentCreate", "DocumentUpdate", "DocumentResponse", "DocumentListItem"]
    - path: "fastapi-backend/app/schemas/document_folder.py"
      provides: "Pydantic schemas for folder CRUD"
      exports: ["FolderCreate", "FolderUpdate", "FolderResponse", "FolderTreeNode"]
    - path: "fastapi-backend/app/routers/documents.py"
      provides: "Document CRUD endpoints"
      contains: "router = APIRouter"
    - path: "fastapi-backend/app/routers/document_folders.py"
      provides: "Folder CRUD + tree endpoints"
      contains: "router = APIRouter"
    - path: "fastapi-backend/app/services/document_service.py"
      provides: "Document business logic (cursor pagination, scope validation, content conversion stubs)"
      contains: "async def"
  key_links:
    - from: "fastapi-backend/app/routers/documents.py"
      to: "fastapi-backend/app/models/document.py"
      via: "SQLAlchemy queries"
      pattern: "select\\(Document\\)"
    - from: "fastapi-backend/app/routers/document_folders.py"
      to: "fastapi-backend/app/models/document_folder.py"
      via: "SQLAlchemy queries"
      pattern: "select\\(DocumentFolder\\)"
    - from: "fastapi-backend/app/main.py"
      to: "fastapi-backend/app/routers/documents.py"
      via: "include_router"
      pattern: "include_router.*documents"
    - from: "fastapi-backend/app/services/document_service.py"
      to: "content conversion"
      via: "stub functions for Phase 4 auto-save pipeline"
      pattern: "def convert_tiptap_to_markdown|def convert_tiptap_to_plain_text"
---

<objective>
Create the Document, DocumentFolder, and DocumentSnapshot SQLAlchemy models, Pydantic schemas, CRUD API endpoints, and a single Alembic migration that atomically drops old Notes tables and creates new document tables.

Purpose: Establish the data foundation for the knowledge base. Documents support three scopes (personal, application, project), hierarchical folders with materialized path, and the schema supports future version history via the snapshot table.

Output: Working backend with document and folder CRUD endpoints, tested via curl or API calls.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-migration-and-data-foundation/01-CONTEXT.md
@.planning/phases/01-migration-and-data-foundation/01-RESEARCH.md
@.planning/phases/01-migration-and-data-foundation/01-01-SUMMARY.md

Key reference files for patterns:
@fastapi-backend/app/models/task.py
@fastapi-backend/app/models/attachment.py
@fastapi-backend/app/schemas/task.py
@fastapi-backend/app/routers/tasks.py
@fastapi-backend/app/database.py
@fastapi-backend/app/models/__init__.py
@fastapi-backend/app/routers/__init__.py
@fastapi-backend/app/main.py
@fastapi-backend/alembic/env.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Document, DocumentFolder, and DocumentSnapshot models with Alembic migration</name>
  <files>
    fastapi-backend/app/models/document.py (CREATE)
    fastapi-backend/app/models/document_folder.py (CREATE)
    fastapi-backend/app/models/document_snapshot.py (CREATE)
    fastapi-backend/app/models/__init__.py (MODIFY)
    fastapi-backend/alembic/env.py (MODIFY)
    fastapi-backend/alembic/versions/XXX_drop_notes_create_documents.py (CREATE via alembic)
  </files>
  <action>
    **1. Create `fastapi-backend/app/models/document_folder.py`** (create folders first since Document references it):

    Follow existing model patterns (task.py, attachment.py). Include:
    - `__tablename__ = "DocumentFolders"`, `__allow_unmapped__ = True`
    - `id`: UUID primary key, default uuid.uuid4
    - `parent_id`: nullable FK to DocumentFolders.id (ondelete CASCADE) — self-referential
    - `materialized_path`: String(4000), not null, default="/", indexed. Format: `/{ancestor-uuid}/{self-uuid}/`
    - `depth`: Integer, not null, default 0
    - `name`: String(255), not null
    - `sort_order`: Integer, not null, default 0
    - Scope FKs (exactly one non-null, same pattern as Document below):
      - `application_id`: nullable FK to Applications.id (ondelete CASCADE), indexed
      - `project_id`: nullable FK to Projects.id (ondelete CASCADE), indexed
      - `user_id`: nullable FK to Users.id (ondelete CASCADE), indexed
    - `created_by`: nullable FK to Users.id (ondelete SET NULL), indexed
    - `created_at`, `updated_at`: DateTime with utcnow defaults
    - CHECK constraint: exactly one scope FK non-null (name: `ck_document_folders_exactly_one_scope`)
    - Relationships: `parent` (self-referential), `children` (self-referential, back_populates), `documents` (one-to-many)
    - Docstring following codebase convention

    **2. Create `fastapi-backend/app/models/document.py`:**

    Follow existing model patterns. Include:
    - `__tablename__ = "Documents"`, `__allow_unmapped__ = True`
    - `id`: UUID primary key, default uuid.uuid4
    - Scope FKs (exactly one non-null):
      - `application_id`: nullable FK to Applications.id (ondelete CASCADE), indexed
      - `project_id`: nullable FK to Projects.id (ondelete CASCADE), indexed
      - `user_id`: nullable FK to Users.id (ondelete CASCADE), indexed
    - `folder_id`: nullable FK to DocumentFolders.id (ondelete SET NULL), indexed — null means "unfiled"
    - `title`: String(255), not null, indexed
    - `content_json`: Text, nullable — TipTap JSON (editor format)
    - `content_markdown`: Text, nullable — Markdown (AI format)
    - `content_plain`: Text, nullable — plain text (search)
    - `sort_order`: Integer, not null, default 0
    - `created_by`: nullable FK to Users.id (ondelete SET NULL), indexed
    - `row_version`: Integer, not null, default 1 — optimistic concurrency
    - `schema_version`: Integer, not null, default 1 — TipTap schema evolution
    - `deleted_at`: DateTime, nullable, indexed — soft delete timestamp
    - `created_at`, `updated_at`: DateTime with utcnow defaults
    - CHECK constraint: exactly one scope FK non-null (name: `ck_documents_exactly_one_scope`)
    - Composite indexes: `ix_documents_app_folder` (application_id, folder_id), `ix_documents_project_folder` (project_id, folder_id)
    - Relationships: `folder` (many-to-one to DocumentFolder), `creator` (many-to-one to User)
    - Docstring following codebase convention

    **3. Create `fastapi-backend/app/models/document_snapshot.py`:**

    Empty model for future version history (DATA-06). Include:
    - `__tablename__ = "DocumentSnapshots"`, `__allow_unmapped__ = True`
    - `id`: UUID primary key, default uuid.uuid4
    - `document_id`: FK to Documents.id (ondelete CASCADE), not null, indexed
    - `content_json`: Text, nullable — snapshot of TipTap JSON at point in time
    - `snapshot_type`: String(50), not null, default "auto" — e.g., "auto", "manual", "restore"
    - `created_by`: nullable FK to Users.id (ondelete SET NULL)
    - `created_at`: DateTime with utcnow default
    - Docstring noting this is a placeholder for future version history

    **4. Update `fastapi-backend/app/models/__init__.py`:**
    - Add imports for Document, DocumentFolder, DocumentSnapshot
    - Add them to `__all__` if the file uses it

    **5. Update `fastapi-backend/alembic/env.py`:**
    - Add imports for Document, DocumentFolder, DocumentSnapshot so Alembic sees them for autogenerate

    **6. Generate Alembic migration:**
    - Run `cd fastapi-backend && alembic revision --autogenerate -m "drop notes create documents"`
    - The migration should:
      - Drop the old Notes table (and any related tables like NoteAttachments if they exist)
      - Drop the note_id column from Attachments table (if not already handled by column removal in model)
      - Create DocumentFolders table
      - Create Documents table
      - Create DocumentSnapshots table
      - Create CHECK constraints and indexes
    - Review the generated migration and fix any issues (autogenerate may miss CHECK constraints — add them manually if needed)
    - Ensure the migration is reversible (downgrade drops new tables, recreates Notes table stub)
  </action>
  <verify>
    - `cd fastapi-backend && python -c "from app.models import Document, DocumentFolder, DocumentSnapshot; print('OK')"` succeeds
    - `cd fastapi-backend && alembic upgrade head` runs without errors
    - The database has tables: Documents, DocumentFolders, DocumentSnapshots
    - CHECK constraints exist on Documents and DocumentFolders tables
    - Notes table no longer exists in the database
  </verify>
  <done>
    Three new models created (Document, DocumentFolder, DocumentSnapshot) following existing codebase patterns. Alembic migration atomically drops old Notes tables and creates new document tables. Database schema includes scope CHECK constraints, materialized path column, soft delete column, row_version, schema_version, and composite indexes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Pydantic schemas, CRUD endpoints, and content conversion stubs for documents and folders</name>
  <files>
    fastapi-backend/app/schemas/document.py (CREATE)
    fastapi-backend/app/schemas/document_folder.py (CREATE)
    fastapi-backend/app/services/document_service.py (CREATE)
    fastapi-backend/app/routers/documents.py (CREATE)
    fastapi-backend/app/routers/document_folders.py (CREATE)
    fastapi-backend/app/schemas/__init__.py (MODIFY)
    fastapi-backend/app/routers/__init__.py (MODIFY)
    fastapi-backend/app/main.py (MODIFY)
  </files>
  <action>
    **1. Create `fastapi-backend/app/schemas/document.py`:**

    Follow existing schema patterns (task.py, application.py). Include:

    - `DocumentCreate(BaseModel)`:
      - `title`: str (min 1, max 255)
      - `scope`: Literal["application", "project", "personal"] — used to determine which FK to set
      - `scope_id`: UUID — the application_id, project_id, or user_id
      - `folder_id`: UUID | None = None
      - `content_json`: str | None = None

    - `DocumentUpdate(BaseModel)`:
      - `title`: str | None = None
      - `folder_id`: UUID | None = None (use a sentinel to distinguish "move to unfiled" from "don't change")
      - `content_json`: str | None = None
      - `sort_order`: int | None = None
      - `row_version`: int — required for optimistic concurrency check

    - `DocumentResponse(BaseModel)`:
      - All document fields including content_json, content_markdown, content_plain
      - `model_config = ConfigDict(from_attributes=True)`

    - `DocumentListItem(BaseModel)`:
      - id, title, folder_id, sort_order, created_by, created_at, updated_at, deleted_at
      - NO content fields (list endpoint is lightweight)
      - `model_config = ConfigDict(from_attributes=True)`

    - `DocumentListResponse(BaseModel)`:
      - `items`: list[DocumentListItem]
      - `next_cursor`: str | None

    **2. Create `fastapi-backend/app/schemas/document_folder.py`:**

    - `FolderCreate(BaseModel)`:
      - `name`: str (min 1, max 255)
      - `parent_id`: UUID | None = None
      - `scope`: Literal["application", "project", "personal"]
      - `scope_id`: UUID

    - `FolderUpdate(BaseModel)`:
      - `name`: str | None = None
      - `parent_id`: UUID | None (move folder — triggers materialized path recalculation)
      - `sort_order`: int | None = None

    - `FolderResponse(BaseModel)`:
      - All folder fields
      - `model_config = ConfigDict(from_attributes=True)`

    - `FolderTreeNode(BaseModel)`:
      - id, name, parent_id, materialized_path, depth, sort_order
      - `children`: list["FolderTreeNode"] = []
      - `document_count`: int = 0

    **3. Create `fastapi-backend/app/services/document_service.py`:**

    Business logic helpers:
    - `validate_scope(scope: str, scope_id: UUID, db: AsyncSession)` — verify the application/project/user exists
    - `set_scope_fks(obj, scope: str, scope_id: UUID)` — set the correct FK column based on scope
    - `get_scope_filter(model, scope: str, scope_id: UUID)` — return SQLAlchemy filter for scope
    - `encode_cursor(created_at: datetime, id: UUID) -> str` — base64-encode cursor
    - `decode_cursor(cursor: str) -> tuple[datetime, UUID]` — decode cursor
    - `validate_folder_depth(db: AsyncSession, parent_id: UUID | None) -> int` — check parent depth < 5, return new depth
    - `compute_materialized_path(parent_path: str | None, folder_id: UUID) -> str` — build path string
    - `update_descendant_paths(db: AsyncSession, old_path: str, new_path: str, depth_delta: int)` — bulk update descendants when folder moves

    **Content conversion stubs (DATA-05):**

    Add two stub functions that Phase 4 (auto-save pipeline, SAVE-05) will call to populate content_markdown and content_plain columns:

    - `def convert_tiptap_to_markdown(content_json: str | None) -> str`:
      - For now, return empty string `""`.
      - Add a docstring: "Convert TipTap JSON to Markdown format. Stub for Phase 4 auto-save pipeline (SAVE-05). Will be implemented with a proper TipTap JSON walker or library."
      - Include a `# TODO(Phase-4): Implement TipTap JSON -> Markdown conversion` comment.

    - `def convert_tiptap_to_plain_text(content_json: str | None) -> str`:
      - For now, return empty string `""`.
      - Add a docstring: "Convert TipTap JSON to plain text for search indexing. Stub for Phase 4 auto-save pipeline (SAVE-05). Will be implemented to extract text nodes from TipTap JSON."
      - Include a `# TODO(Phase-4): Implement TipTap JSON -> plain text extraction` comment.

    These are intentionally simple stubs. The schema columns (content_markdown, content_plain) are created in Task 1. The actual conversion logic will be implemented in Phase 4 when auto-save triggers the conversion on each document save.

    **4. Create `fastapi-backend/app/routers/documents.py`:**

    Endpoints (follow existing router patterns in tasks.py):
    - `GET /api/documents` — list documents by scope with cursor pagination
      - Query params: `scope` (required), `scope_id` (required), `folder_id` (optional, null = unfiled), `cursor` (optional), `limit` (default 30, max 100)
      - Filters `deleted_at IS NULL` by default
      - Orders by `created_at DESC, id DESC`
      - Returns `DocumentListResponse`
    - `POST /api/documents` — create document
      - Body: `DocumentCreate`
      - Validates scope, sets scope FKs, sets `created_by` from current user
      - Returns `DocumentResponse` with 201
    - `GET /api/documents/{document_id}` — get single document with content
      - Returns `DocumentResponse` (includes content_json, content_markdown, content_plain)
      - Returns 404 if not found or soft-deleted
    - `PUT /api/documents/{document_id}` — update document
      - Body: `DocumentUpdate`
      - Checks `row_version` matches (optimistic concurrency — returns 409 if mismatch)
      - Increments `row_version` on successful update
      - Returns updated `DocumentResponse`
    - `DELETE /api/documents/{document_id}` — soft delete (move to trash)
      - Sets `deleted_at = utcnow()`
      - Returns 204

    All endpoints require authentication via `get_current_user` dependency.

    **5. Create `fastapi-backend/app/routers/document_folders.py`:**

    Endpoints:
    - `GET /api/document-folders/tree` — get full folder tree for a scope
      - Query params: `scope` (required), `scope_id` (required)
      - Fetches all folders for scope ordered by materialized_path ASC, sort_order ASC
      - Builds tree structure from flat list using materialized_path
      - Returns `list[FolderTreeNode]` (root-level nodes with nested children)
      - Each node includes `document_count` (count of non-deleted documents in that folder)
    - `POST /api/document-folders` — create folder
      - Body: `FolderCreate`
      - Validates depth <= 5 (if parent_id set, check parent's depth + 1 <= 5)
      - Computes materialized_path from parent's path
      - Sets scope FKs
      - Returns `FolderResponse` with 201
    - `PUT /api/document-folders/{folder_id}` — update folder
      - Body: `FolderUpdate`
      - If `parent_id` changes: validate new depth, update own materialized_path, bulk-update all descendant paths
      - Returns `FolderResponse`
    - `DELETE /api/document-folders/{folder_id}` — delete folder
      - Cascade: all documents in folder have `folder_id` set to NULL (moved to unfiled) — this is handled by ondelete SET NULL in the FK
      - Subfolder cascade: child folders are deleted (ondelete CASCADE in FK)
      - Returns 204

    **6. Update `fastapi-backend/app/schemas/__init__.py`:**
    - Add imports for new document and folder schemas
    - Add to `__all__`

    **7. Update `fastapi-backend/app/routers/__init__.py`:**
    - Import `documents_router` and `document_folders_router`
    - Add to `__all__`

    **8. Update `fastapi-backend/app/main.py`:**
    - Import and include both routers:
      - `app.include_router(documents_router, prefix="/api", tags=["documents"])`
      - `app.include_router(document_folders_router, prefix="/api", tags=["document-folders"])`
  </action>
  <verify>
    - `cd fastapi-backend && python -c "from app.main import app; print('Routes:', [r.path for r in app.routes])"` shows document and folder routes
    - `cd fastapi-backend && python -c "from app.schemas import DocumentCreate, DocumentResponse, FolderCreate, FolderTreeNode; print('Schemas OK')"`
    - `cd fastapi-backend && python -c "from app.services.document_service import convert_tiptap_to_markdown, convert_tiptap_to_plain_text; assert convert_tiptap_to_markdown('{\"type\":\"doc\"}') == ''; assert convert_tiptap_to_plain_text('{\"type\":\"doc\"}') == ''; print('Conversion stubs OK')"` — stubs exist and return empty strings
    - Start the server: `cd fastapi-backend && uvicorn app.main:app --port 8001` boots without errors
    - Test document creation with curl (or similar) for each scope type
    - Test folder creation and tree retrieval
    - Test folder nesting depth enforcement (creating 6th level should fail)
  </verify>
  <done>
    Complete document and folder CRUD API is working. Documents can be created in all three scopes (personal, application, project). Folders support nesting up to 5 levels with materialized path. Folder tree endpoint returns full tree in single call. Document list uses cursor-based pagination and excludes content. Single document GET includes all content fields. Optimistic concurrency via row_version on document updates. Content conversion stub functions (convert_tiptap_to_markdown, convert_tiptap_to_plain_text) exist in document_service.py, returning empty strings as placeholders for Phase 4 auto-save implementation.
  </done>
</task>

</tasks>

<verification>
1. Models import: `python -c "from app.models import Document, DocumentFolder, DocumentSnapshot"`
2. Migration runs: `alembic upgrade head` succeeds, `alembic downgrade -1` succeeds, `alembic upgrade head` succeeds again
3. Server starts: `uvicorn app.main:app --port 8001` boots clean
4. Document CRUD works for all three scopes
5. Folder tree returns nested structure
6. Folder depth limit enforced at 5
7. Unfiled documents (no folder_id) queryable
8. Document update with wrong row_version returns 409
9. Conversion stubs exist and are callable: `from app.services.document_service import convert_tiptap_to_markdown, convert_tiptap_to_plain_text`
</verification>

<success_criteria>
- Documents can be created in personal, application, and project scopes via API
- Folders can be created and nested up to 5 levels within any scope
- Folder tree endpoint returns complete tree for a scope
- Documents without folder_id are queryable (unfiled section)
- DocumentSnapshot table exists in schema (empty, for future use)
- Old Notes table is dropped
- Cursor-based pagination works on document list
- Optimistic concurrency (row_version) is enforced on document updates
- convert_tiptap_to_markdown and convert_tiptap_to_plain_text stubs exist in document_service.py and return empty strings (ready for Phase 4 SAVE-05 implementation)
</success_criteria>

<output>
After completion, create `.planning/phases/01-migration-and-data-foundation/01-03-SUMMARY.md`
</output>
