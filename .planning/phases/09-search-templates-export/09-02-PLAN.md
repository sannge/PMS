---
phase: 09-search-templates-export
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - fastapi-backend/app/models/document_template.py
  - fastapi-backend/app/models/__init__.py
  - fastapi-backend/app/schemas/document_template.py
  - fastapi-backend/app/routers/document_templates.py
  - fastapi-backend/app/routers/__init__.py
  - fastapi-backend/app/main.py
  - fastapi-backend/alembic/versions/YYYYMMDD_create_document_templates.py
  - electron-app/src/renderer/lib/query-client.ts
  - electron-app/src/renderer/hooks/use-templates.ts
  - electron-app/src/renderer/components/knowledge/template-picker.tsx
  - electron-app/src/renderer/components/knowledge/save-as-template-dialog.tsx
  - electron-app/src/renderer/components/knowledge/folder-context-menu.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a new document from a built-in template (Meeting Notes, Design Doc, Decision Record, Project Brief, Sprint Retrospective)"
    - "User can save any existing document as a custom template"
    - "User can create a new document from a custom template"
    - "Template picker shows all built-in templates plus custom templates for the current scope"
  artifacts:
    - path: "fastapi-backend/app/models/document_template.py"
      provides: "DocumentTemplate SQLAlchemy model"
      contains: "DocumentTemplate"
    - path: "fastapi-backend/app/routers/document_templates.py"
      provides: "Template CRUD endpoints"
      exports: ["router"]
    - path: "fastapi-backend/alembic/versions/YYYYMMDD_create_document_templates.py"
      provides: "Migration creating DocumentTemplates table and seeding built-in templates"
      contains: "DocumentTemplates"
    - path: "electron-app/src/renderer/components/knowledge/template-picker.tsx"
      provides: "Dialog for choosing a template when creating a document"
      min_lines: 50
    - path: "electron-app/src/renderer/components/knowledge/save-as-template-dialog.tsx"
      provides: "Dialog for saving a document as a custom template"
      min_lines: 30
  key_links:
    - from: "electron-app/src/renderer/components/knowledge/template-picker.tsx"
      to: "/api/document-templates"
      via: "useTemplates hook fetches available templates"
      pattern: "document-templates"
    - from: "electron-app/src/renderer/components/knowledge/template-picker.tsx"
      to: "/api/documents"
      via: "Creates document with template's content_json"
      pattern: "useCreateDocument"
    - from: "electron-app/src/renderer/components/knowledge/save-as-template-dialog.tsx"
      to: "/api/document-templates/from-document"
      via: "POST to save document as template"
      pattern: "from-document"
---

<objective>
Add document templates: backend model with built-in template seeding, template CRUD endpoints, and frontend template picker dialog and save-as-template flow.

Purpose: Users need to create documents from predefined structures (TMPL-01) and save their own documents as reusable templates (TMPL-02, TMPL-03).
Output: DocumentTemplate model, seeded built-in templates, template picker dialog, and save-as-template dialog.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-search-templates-export/09-RESEARCH.md

@fastapi-backend/app/models/document.py
@fastapi-backend/app/models/__init__.py
@fastapi-backend/app/routers/__init__.py
@fastapi-backend/app/routers/documents.py
@fastapi-backend/app/schemas/document.py
@fastapi-backend/app/services/document_service.py
@fastapi-backend/app/main.py
@electron-app/src/renderer/hooks/use-documents.ts
@electron-app/src/renderer/components/knowledge/folder-context-menu.tsx
@electron-app/src/renderer/lib/query-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend -- DocumentTemplate model, migration with built-in seeds, schemas, and CRUD endpoints</name>
  <files>
    fastapi-backend/app/models/document_template.py
    fastapi-backend/app/models/__init__.py
    fastapi-backend/app/schemas/document_template.py
    fastapi-backend/app/routers/document_templates.py
    fastapi-backend/app/routers/__init__.py
    fastapi-backend/app/main.py
    fastapi-backend/alembic/versions/YYYYMMDD_create_document_templates.py
  </files>
  <action>
    1. Create `fastapi-backend/app/models/document_template.py` with DocumentTemplate model:
       - __tablename__ = "DocumentTemplates"
       - id: UUID primary key (default uuid4)
       - name: String(255), not null
       - description: String(500), nullable
       - category: String(100), not null, default="custom"
       - content_json: Text, not null (TipTap JSON)
       - is_builtin: Boolean, not null, default=False
       - application_id: UUID FK to Applications.id, nullable (null for built-in)
       - project_id: UUID FK to Projects.id, nullable
       - user_id: UUID FK to Users.id, nullable (for personal scope custom templates)
       - created_by: UUID FK to Users.id, nullable
       - created_at: DateTime, default utcnow
       - updated_at: DateTime, default utcnow, onupdate utcnow
       - Follow same patterns as Document model (imports, Column definitions, etc.)

    2. Register in `models/__init__.py`: import DocumentTemplate and add to __all__.

    3. Create Alembic migration (manual, not autogenerate):
       - Create "DocumentTemplates" table with all columns above
       - Add foreign key constraints
       - Seed 5 built-in templates with is_builtin=True, category set appropriately:
         a. "Meeting Notes" (category="meetings") -- H1 title, H2 sections: Date, Attendees (bullet list), Agenda (ordered list), Discussion (paragraph), Action Items (task list)
         b. "Design Doc" (category="engineering") -- H1 title, H2 sections: Overview, Goals, Non-Goals, Design, Alternatives Considered, Open Questions
         c. "Decision Record" (category="engineering") -- H1 title, H2 sections: Context, Decision, Consequences, Status
         d. "Project Brief" (category="management") -- H1 title, H2 sections: Problem Statement, Objectives, Scope, Timeline, Success Metrics
         e. "Sprint Retrospective" (category="agile") -- H1 title, H2 sections: What Went Well (bullet list), What Could Be Better (bullet list), Action Items (task list)
       - Each template's content_json must be valid TipTap JSON ({"type": "doc", "content": [...]})
       - Use op.bulk_insert() or raw INSERT with the template data
       - Downgrade: DROP TABLE "DocumentTemplates"

    4. Create `fastapi-backend/app/schemas/document_template.py`:
       - TemplateResponse: id, name, description, category, content_json, is_builtin, application_id, project_id, user_id, created_by, created_at, updated_at (model_config from_attributes=True)
       - SaveAsTemplateRequest: name (str, min 1, max 255), description (str, optional, max 500)
       - TemplateListResponse: items (list[TemplateResponse])

    5. Create `fastapi-backend/app/routers/document_templates.py`:
       - router = APIRouter(prefix="/document-templates", tags=["document-templates"])
       - GET "" -- list templates: query params scope (Optional), scope_id (Optional). Returns all built-in templates PLUS custom templates matching the scope. Use `or_(DocumentTemplate.is_builtin == True, get_scope_filter(...))` when scope provided. If no scope, return only built-ins.
       - GET "/{template_id}" -- get single template by ID
       - POST "/from-document/{document_id}" -- save document as template: body is SaveAsTemplateRequest. Fetches document, copies content_json, sets is_builtin=False, copies scope from document, sets created_by to current_user.id
       - DELETE "/{template_id}" -- delete a custom template. Only allow deleting non-builtin templates (return 403 for built-in). Verify created_by matches current_user.id.
       - All endpoints require get_current_user dependency.

    6. Register router:
       - In `routers/__init__.py`: import and add `document_templates_router`
       - In `main.py`: add `app.include_router(document_templates_router, prefix="/api", tags=["document-templates"])`

    IMPORTANT: Template content_json must be valid TipTap doc format. Each template should have realistic placeholder content with proper TipTap node types (heading, paragraph, bulletList, orderedList, taskList, listItem, taskItem).
  </action>
  <verify>
    Run `cd fastapi-backend && python -c "from app.models.document_template import DocumentTemplate; print('Model OK')"` to verify model imports.
    Run `cd fastapi-backend && python -c "from app.routers.document_templates import router; print([r.path for r in router.routes])"` to verify routes.
    Run `cd fastapi-backend && python -m pytest tests/ -v --tb=short -q 2>&1 | tail -20` to check no import errors.
  </verify>
  <done>
    DocumentTemplate model exists with all fields. Migration creates table and seeds 5 built-in templates. CRUD endpoints: list, get, save-from-document, delete. Router registered in main.py. All Python imports succeed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend -- template query hooks, template picker dialog, save-as-template dialog, and context menu integration</name>
  <files>
    electron-app/src/renderer/lib/query-client.ts
    electron-app/src/renderer/hooks/use-templates.ts
    electron-app/src/renderer/components/knowledge/template-picker.tsx
    electron-app/src/renderer/components/knowledge/save-as-template-dialog.tsx
    electron-app/src/renderer/components/knowledge/folder-context-menu.tsx
  </files>
  <action>
    1. Add query keys to `query-client.ts`:
       ```typescript
       // Templates
       documentTemplates: (scope: string, scopeId: string) =>
         ['documentTemplates', scope, scopeId] as const,
       ```

    2. Create `electron-app/src/renderer/hooks/use-templates.ts`:
       - Define Template interface: id, name, description, category, content_json, is_builtin, application_id, project_id, user_id, created_by, created_at, updated_at
       - `useTemplates(scope: string, scopeId: string | null)`: fetches GET /api/document-templates with scope params. Returns UseQueryResult<Template[]>. For 'personal' scope, resolve scopeId to userId. For 'all' scope, omit scope params (gets built-ins only).
       - `useSaveAsTemplate()`: mutation POST /api/document-templates/from-document/{documentId} with body {name, description}. Invalidates documentTemplates queries on success.
       - `useDeleteTemplate()`: mutation DELETE /api/document-templates/{templateId}. Invalidates documentTemplates on success.
       - Follow same patterns as use-documents.ts (getAuthHeaders, parseApiError, window.electronAPI calls).

    3. Create `template-picker.tsx` -- a Radix Dialog for choosing a template when creating a new document:
       - Props: open (boolean), onOpenChange, onSelect (template: Template) => void, scope (string), scopeId (string | null)
       - Calls useTemplates(scope, scopeId) to get available templates
       - Layout: Dialog with title "New from Template", description "Choose a template to start with"
       - Group templates by category: show category as section headers (capitalize first letter)
       - Built-in templates first, then custom templates
       - Each template card: name (font-medium), description (text-xs text-muted-foreground), "Built-in" badge or "Custom" badge
       - Click a template card -> calls onSelect(template) and closes dialog
       - Also include a "Blank Document" option at the top (no template, creates empty doc)
       - Use existing Radix Dialog component (@/components/ui/dialog)

    4. Create `save-as-template-dialog.tsx`:
       - Props: open (boolean), onOpenChange, documentId (string), documentTitle (string)
       - Contains a form with: name input (pre-filled with document title), description textarea (optional)
       - Submit calls useSaveAsTemplate mutation with documentId, name, description
       - On success: close dialog, show no toast (keep it simple for now)
       - Use Dialog, Input, Label from existing ui components

    5. Update `folder-context-menu.tsx` to add "New from Template..." option:
       - Read the existing context menu structure
       - Add a new menu item "New from Template..." that opens the TemplatePicker dialog
       - When a template is selected from the picker, create a new document using useCreateDocument with the template's content_json as the initial content
       - The create document params should include: title (template.name or "Untitled"), scope, scope_id, folder_id (current folder), content_json (template.content_json)
       - This requires extending DocumentCreate to accept content_json (already supported in the backend schema)

    IMPORTANT: The TemplatePicker should work even when scope is 'all' (shows only built-in templates).
    IMPORTANT: Use the existing Dialog, Input, Label, ScrollArea shadcn/ui components.
  </action>
  <verify>
    Run `cd electron-app && npx tsc --noEmit 2>&1 | tail -20` to verify TypeScript compilation.
    Visually confirm: template-picker.tsx exists, save-as-template-dialog.tsx exists, use-templates.ts exports useTemplates and useSaveAsTemplate, folder-context-menu.tsx has "New from Template" option.
  </verify>
  <done>
    useTemplates hook fetches templates from API. TemplatePicker dialog shows built-in and custom templates grouped by category. SaveAsTemplateDialog saves a document as custom template. FolderContextMenu has "New from Template..." option that opens the picker and creates a document with template content. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. Backend: GET /api/document-templates returns 5 built-in templates
2. Backend: POST /api/document-templates/from-document/{id} creates a custom template from an existing document
3. Frontend: "New from Template" in context menu opens template picker dialog
4. Frontend: Selecting a template creates a new document pre-filled with template content
5. Frontend: Save-as-template dialog saves current document as a custom template
</verification>

<success_criteria>
- 5 built-in templates seeded in database via migration
- Template picker dialog shows templates grouped by category
- Creating from template populates document with template content_json
- Save-as-template copies document content into a new template
- TypeScript compiles, Python imports succeed
</success_criteria>

<output>
After completion, create `.planning/phases/09-search-templates-export/09-02-SUMMARY.md`
</output>
