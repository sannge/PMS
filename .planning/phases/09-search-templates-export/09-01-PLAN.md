---
phase: 09-search-templates-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fastapi-backend/alembic/versions/YYYYMMDD_add_search_vector_column.py
  - fastapi-backend/app/models/document.py
  - fastapi-backend/app/schemas/document.py
  - fastapi-backend/app/services/search_service.py
  - fastapi-backend/app/routers/documents.py
  - electron-app/src/renderer/lib/query-client.ts
  - electron-app/src/renderer/hooks/use-documents.ts
  - electron-app/src/renderer/components/knowledge/search-bar.tsx
  - electron-app/src/renderer/components/knowledge/search-results.tsx
  - electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User types in the search bar and sees relevant results ranked by relevance"
    - "Search results display document title, content snippet with highlighted matches, scope, and last edited date"
    - "Clicking a search result navigates to that document"
    - "Empty or whitespace-only queries show no results (no errors)"
  artifacts:
    - path: "fastapi-backend/alembic/versions/YYYYMMDD_add_search_vector_column.py"
      provides: "tsvector generated column + GIN index on Documents table"
      contains: "search_vector"
    - path: "fastapi-backend/app/services/search_service.py"
      provides: "Full-text search query builder"
      exports: ["search_documents"]
    - path: "fastapi-backend/app/routers/documents.py"
      provides: "GET /documents/search endpoint"
      contains: "search"
    - path: "electron-app/src/renderer/components/knowledge/search-results.tsx"
      provides: "Search results list with snippets"
      min_lines: 40
    - path: "electron-app/src/renderer/hooks/use-documents.ts"
      provides: "useSearchDocuments query hook"
      contains: "useSearchDocuments"
  key_links:
    - from: "electron-app/src/renderer/components/knowledge/search-bar.tsx"
      to: "search-results.tsx"
      via: "searchQuery from KnowledgeBaseContext triggers useSearchDocuments"
      pattern: "useSearchDocuments"
    - from: "electron-app/src/renderer/hooks/use-documents.ts"
      to: "/api/documents/search"
      via: "fetch in useSearchDocuments"
      pattern: "documents/search"
    - from: "fastapi-backend/app/routers/documents.py"
      to: "fastapi-backend/app/services/search_service.py"
      via: "search endpoint calls search_documents service"
      pattern: "search_documents"
---

<objective>
Add PostgreSQL full-text search to the knowledge base: backend tsvector column with GIN index, search API endpoint, and frontend search results UI wired into the existing search bar.

Purpose: Users need to find documents by searching titles and content (SRCH-01, SRCH-02, SRCH-03). The existing search bar only filters locally; this plan wires it to server-side FTS.
Output: Working search endpoint and search results panel in the sidebar that shows ranked results with snippets.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-search-templates-export/09-RESEARCH.md

@fastapi-backend/app/models/document.py
@fastapi-backend/app/routers/documents.py
@fastapi-backend/app/services/document_service.py
@fastapi-backend/app/schemas/document.py
@electron-app/src/renderer/hooks/use-documents.ts
@electron-app/src/renderer/components/knowledge/search-bar.tsx
@electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
@electron-app/src/renderer/contexts/knowledge-base-context.tsx
@electron-app/src/renderer/lib/query-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend -- tsvector migration, model update, search service, and search endpoint</name>
  <files>
    fastapi-backend/alembic/versions/YYYYMMDD_add_search_vector_column.py
    fastapi-backend/app/models/document.py
    fastapi-backend/app/schemas/document.py
    fastapi-backend/app/services/search_service.py
    fastapi-backend/app/routers/documents.py
  </files>
  <action>
    1. Create a MANUAL Alembic migration (do NOT use autogenerate -- see Research pitfall 6). Use raw SQL:
       - ALTER TABLE "Documents" ADD COLUMN search_vector tsvector GENERATED ALWAYS AS (setweight(to_tsvector('english', COALESCE(title, '')), 'A') || setweight(to_tsvector('english', COALESCE(content_plain, '')), 'B')) STORED
       - CREATE INDEX ix_documents_search_vector ON "Documents" USING GIN (search_vector)
       - Downgrade: DROP INDEX + DROP COLUMN
       - Use `op.execute()` for raw SQL. Follow the naming convention of existing migrations (YYYYMMDD prefix).

    2. Add `search_vector` column to the Document model in `document.py`:
       ```python
       from sqlalchemy.dialects.postgresql import TSVECTOR
       search_vector = Column(TSVECTOR, nullable=True)
       ```
       This is read-only (PostgreSQL maintains it). Place it after content_plain.

    3. Create `fastapi-backend/app/services/search_service.py` with an async function `search_documents()`:
       - Parameters: db (AsyncSession), query_text (str), scope (str | None), scope_id (UUID | None), limit (int = 20), offset (int = 0)
       - Validate query_text.strip() is non-empty, return empty list if not
       - Build ts_query using `func.websearch_to_tsquery('english', query_text)`
       - Filter: `Document.search_vector.op('@@')(ts_query)` AND `Document.deleted_at.is_(None)`
       - If scope and scope_id provided, add scope filter using `get_scope_filter` from document_service
       - Select Document columns + `func.ts_rank(Document.search_vector, ts_query).label('rank')` + `func.ts_headline('english', func.coalesce(Document.content_plain, ''), ts_query, 'MaxFragments=2, MaxWords=30, MinWords=15, StartSel=<mark>, StopSel=</mark>, FragmentDelimiter= ... ').label('snippet')`
       - Order by rank DESC, then updated_at DESC
       - Apply limit and offset
       - Also compute total_count with a separate COUNT query (same filters, no ts_headline)
       - Return tuple of (items list, total_count)

    4. Add search schemas to `schemas/document.py`:
       - `SearchResult`: id (UUID), title (str), snippet (str), scope (str), scope_id (UUID), updated_at (datetime), rank (float)
       - `SearchResponse`: items (list[SearchResult]), total_count (int)

    5. Add GET `/search` endpoint to `routers/documents.py`. It MUST be placed BEFORE the `/{document_id}` route (same pattern as `/trash`):
       - Query params: q (str, min_length=1, max_length=500), scope (Optional Literal), scope_id (Optional UUID), limit (int, default=20, ge=1, le=50), offset (int, default=0, ge=0)
       - Depends: get_current_user, get_db
       - Call search_service.search_documents()
       - Map results: determine scope/scope_id from document's application_id/project_id/user_id
       - Return SearchResponse

    IMPORTANT: Do NOT use `to_tsquery` (requires formatted input). Use `websearch_to_tsquery` which handles natural user input safely.
    IMPORTANT: Write the Alembic migration manually with op.execute(), NOT with autogenerate.
  </action>
  <verify>
    Run `cd fastapi-backend && python -m pytest tests/ -v --tb=short -q 2>&1 | tail -20` to check no import errors.
    Run `cd fastapi-backend && python -c "from app.services.search_service import search_documents; print('OK')"` to verify import.
    Run `cd fastapi-backend && python -c "from app.routers.documents import router; print([r.path for r in router.routes])"` to verify /search route exists.
  </verify>
  <done>
    Alembic migration file exists with manual SQL for tsvector column + GIN index. Document model has search_vector column. search_service.py exports search_documents(). documents router has GET /search endpoint before /{document_id}. SearchResult and SearchResponse schemas exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend -- search query hook, search results component, and sidebar integration</name>
  <files>
    electron-app/src/renderer/lib/query-client.ts
    electron-app/src/renderer/hooks/use-documents.ts
    electron-app/src/renderer/components/knowledge/search-results.tsx
    electron-app/src/renderer/components/knowledge/search-bar.tsx
    electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
  </files>
  <action>
    1. Add query key to `query-client.ts`:
       ```typescript
       // Search
       documentSearch: (query: string, scope: string, scopeId: string) =>
         ['documentSearch', query, scope, scopeId] as const,
       ```

    2. Add `useSearchDocuments` hook to `use-documents.ts`:
       - Parameters: query (string), scope (string), scopeId (string | null)
       - Returns UseQueryResult with SearchResponse type
       - Define interfaces: SearchResultItem (id, title, snippet, scope, scopeId, updatedAt, rank), SearchResponse (items: SearchResultItem[], total_count: number)
       - Calls GET `/api/documents/search?q={query}&scope={scope}&scope_id={scopeId}&limit=20`
       - enabled: only when query.trim().length > 0 AND token exists AND scope is not 'all' (search requires a scope per research)
       - staleTime: 10 * 1000 (10s, shorter than default since search is dynamic)
       - For 'personal' scope, resolve scope_id to userId (same pattern as useDocuments)

    3. Create `search-results.tsx` component:
       - Import useSearchDocuments hook and useKnowledgeBase context
       - Read searchQuery, scope, scopeId, selectDocument from context
       - Call useSearchDocuments(searchQuery, scope, scopeId)
       - If query is empty, render null (show folder tree instead)
       - If loading, show "Searching..." text
       - If no results, show "No results found" text
       - If results, render a list of clickable items:
         - Each item: document title (text-sm font-medium truncate), snippet rendered with dangerouslySetInnerHTML (contains <mark> tags from ts_headline), relative date (text-xs text-muted-foreground)
         - onClick: call selectDocument(result.id)
         - Use hover:bg-muted/50 for hover state, rounded-md, p-2
       - Show total_count at the top: "{N} results" in text-xs text-muted-foreground
       - Helper: formatRelativeTime that shows "just now", "5m ago", "2h ago", "3d ago" etc.

    4. Update `knowledge-sidebar.tsx` to conditionally show SearchResults when searchQuery is non-empty:
       - Import SearchResults component
       - Read searchQuery from useKnowledgeBase()
       - When searchQuery.trim() is non-empty, replace the FolderTree ScrollArea with SearchResults in a ScrollArea
       - When searchQuery is empty, show FolderTree as before
       - This means the sidebar toggles between folder browsing and search results based on the search bar input

    5. The search-bar.tsx itself needs NO changes -- it already debounces and updates searchQuery in the context. The SearchResults component reactively responds to searchQuery changes via the hook.

    IMPORTANT: For scope='all', search is not supported in v1 (research recommendation). When scope is 'all', show a small info text like "Select a scope to search" instead of results. The search bar can still accept input but results panel shows the message.
  </action>
  <verify>
    Run `cd electron-app && npx tsc --noEmit 2>&1 | tail -20` to verify TypeScript compilation.
    Visually confirm: search-results.tsx exists, knowledge-sidebar.tsx conditionally renders SearchResults, use-documents.ts exports useSearchDocuments.
  </verify>
  <done>
    useSearchDocuments hook exists and calls /api/documents/search. SearchResults component renders search results with title, snippet (HTML), and relative date. KnowledgeSidebar shows SearchResults when searchQuery is non-empty, FolderTree when empty. Query key for documentSearch added to query-client.ts. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. Backend: Alembic migration creates search_vector column and GIN index
2. Backend: GET /api/documents/search?q=test&scope=application&scope_id=xxx returns SearchResponse with ranked results
3. Frontend: Typing in search bar shows search results in sidebar replacing folder tree
4. Frontend: Clicking a search result calls selectDocument and navigates to the document
5. Frontend: Empty search query shows folder tree (no search results panel)
6. Frontend: scope='all' shows "Select a scope to search" message
</verification>

<success_criteria>
- Search endpoint returns relevance-ranked results with snippets
- Search results display in sidebar with title, snippet, and date
- Clicking a result navigates to the document
- TypeScript compiles, Python imports succeed
</success_criteria>

<output>
After completion, create `.planning/phases/09-search-templates-export/09-01-SUMMARY.md`
</output>
