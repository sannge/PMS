---
phase: 09-search-templates-export
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - fastapi-backend/app/routers/documents.py
  - electron-app/src/renderer/hooks/use-documents.ts
  - electron-app/src/renderer/components/knowledge/export-button.tsx
  - electron-app/src/renderer/components/knowledge/editor-toolbar.tsx
autonomous: true

must_haves:
  truths:
    - "User can click an export button and download the document as a .md file"
    - "Downloaded file contains the document title as H1 and content in Markdown format"
    - "Filename is sanitized from the document title"
  artifacts:
    - path: "fastapi-backend/app/routers/documents.py"
      provides: "GET /{document_id}/export/markdown endpoint"
      contains: "export"
    - path: "electron-app/src/renderer/components/knowledge/export-button.tsx"
      provides: "Download button component"
      min_lines: 20
  key_links:
    - from: "electron-app/src/renderer/components/knowledge/export-button.tsx"
      to: "/api/documents/{id}/export/markdown"
      via: "fetch blob and trigger download"
      pattern: "export/markdown"
    - from: "electron-app/src/renderer/components/knowledge/editor-toolbar.tsx"
      to: "export-button.tsx"
      via: "ExportButton rendered in toolbar"
      pattern: "ExportButton"
---

<objective>
Add Markdown export: backend endpoint serving content_markdown as a downloadable .md file, and frontend download button in the editor toolbar.

Purpose: Users need to export documents as Markdown files (EXPR-01). The content_markdown field is already maintained by the Phase 4 auto-save pipeline.
Output: Export endpoint and download button that triggers a .md file download.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-search-templates-export/09-RESEARCH.md

@fastapi-backend/app/routers/documents.py
@fastapi-backend/app/models/document.py
@fastapi-backend/app/services/document_service.py
@electron-app/src/renderer/hooks/use-documents.ts
@electron-app/src/renderer/components/knowledge/editor-toolbar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend export endpoint and frontend download button</name>
  <files>
    fastapi-backend/app/routers/documents.py
    electron-app/src/renderer/hooks/use-documents.ts
    electron-app/src/renderer/components/knowledge/export-button.tsx
    electron-app/src/renderer/components/knowledge/editor-toolbar.tsx
  </files>
  <action>
    1. Add GET `/{document_id}/export/markdown` endpoint to `routers/documents.py`:
       - Place it AFTER the search and trash routes but BEFORE the generic PUT/DELETE /{document_id} routes (route ordering matters for FastAPI path matching -- actually this path is specific enough that it won't conflict, so place it after the tag endpoints at the bottom)
       - Depends: get_current_user, get_db
       - Fetch document by ID (404 if not found or deleted)
       - Build markdown content: `f"# {doc.title}\n\n{doc.content_markdown or ''}"`
       - If content_markdown is NULL or empty, fall back to `convert_tiptap_to_markdown(doc.content_json)` from document_service (research pitfall 5)
       - Sanitize filename: keep only alphanumeric, spaces, hyphens, underscores. Strip. Default to "document" if empty. Append ".md"
       - Return `Response(content=markdown.encode("utf-8"), media_type="text/markdown", headers={"Content-Disposition": f'attachment; filename="{filename}"'})`
       - Import Response from fastapi

    2. Add `useExportMarkdown` function (not a hook, just an async utility) to `use-documents.ts`:
       - Parameters: documentId (string), token (string)
       - Calls GET `/api/documents/${documentId}/export/markdown` via window.electronAPI
       - Since window.electronAPI returns parsed JSON but we need raw blob, check if there's a raw/blob method. If not, construct the download from the response data.
       - Alternative approach (more reliable for Electron): Have the function call the API and get the markdown text content, then create a Blob in the renderer, create an object URL, and trigger download via a temporary <a> element.
       - Actually, since the Electron API wrapper likely returns the response body as text/JSON, the simplest approach is:
         a. Fetch the endpoint and get the markdown text back
         b. Create a Blob from the text
         c. Use URL.createObjectURL + temporary <a download> to trigger the download
       - Export this as a standalone function (not a hook): `exportDocumentMarkdown(documentId: string, token: string): Promise<void>`

    3. Create `export-button.tsx`:
       - Props: documentId (string | null)
       - Uses useAuthStore to get token
       - Renders a button with Download icon from lucide-react
       - onClick: calls exportDocumentMarkdown(documentId, token)
       - Disabled when documentId is null
       - Show loading state while exporting (local useState)
       - Styling: match toolbar button style (the existing toolbar uses icon buttons with tooltips)
       - Include tooltip text "Export as Markdown"

    4. Add ExportButton to `editor-toolbar.tsx`:
       - Read the current toolbar structure
       - Add ExportButton at the end of the toolbar (right side), separated by a divider from the formatting controls
       - Pass the current document ID (from props or context) to ExportButton
       - If the toolbar doesn't receive documentId, thread it through from the parent component or read from KnowledgeBaseContext's selectedDocumentId

    IMPORTANT: The export endpoint uses `content_markdown` which is populated by Phase 4's auto-save pipeline. Since Phase 4 may not be implemented yet in the current codebase, the fallback to `convert_tiptap_to_markdown()` handles the case where content_markdown is empty. The stub returns "" but that's acceptable for now -- once Phase 4 is built, export will work fully.
    IMPORTANT: For the frontend download, use the Blob + createObjectURL + <a download> pattern, not window.open(). This works reliably in Electron.
  </action>
  <verify>
    Run `cd fastapi-backend && python -c "from app.routers.documents import router; paths = [r.path for r in router.routes]; assert any('export' in p for p in paths); print('Export route OK')"` to verify endpoint exists.
    Run `cd electron-app && npx tsc --noEmit 2>&1 | tail -20` to verify TypeScript compilation.
    Visually confirm: export-button.tsx exists, editor-toolbar.tsx includes ExportButton.
  </verify>
  <done>
    GET /{document_id}/export/markdown endpoint returns a downloadable .md file with Content-Disposition header. Frontend ExportButton triggers download via Blob+createObjectURL pattern. Button appears in editor toolbar. TypeScript compiles, Python imports succeed.
  </done>
</task>

</tasks>

<verification>
1. Backend: GET /api/documents/{id}/export/markdown returns text/markdown with Content-Disposition: attachment header
2. Backend: Filename is sanitized from document title
3. Backend: Falls back to convert_tiptap_to_markdown when content_markdown is empty
4. Frontend: Export button visible in editor toolbar
5. Frontend: Clicking export triggers .md file download in Electron
</verification>

<success_criteria>
- Export endpoint serves content_markdown as downloadable .md file
- Filename derived from document title, sanitized for filesystem safety
- Download button in editor toolbar triggers export
- TypeScript compiles, Python imports succeed
</success_criteria>

<output>
After completion, create `.planning/phases/09-search-templates-export/09-03-SUMMARY.md`
</output>
