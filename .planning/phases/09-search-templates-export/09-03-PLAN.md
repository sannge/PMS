---
phase: 09-search-templates-export
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - electron-app/src/main/ipc/handlers.ts
  - electron-app/src/preload/index.ts
  - electron-app/src/preload/index.d.ts
  - electron-app/src/renderer/components/knowledge/editor-toolbar.tsx
autonomous: true

must_haves:
  truths:
    - "User can export any document as a Markdown .md file download"
    - "Export uses the pre-generated content_markdown field (no client-side conversion)"
    - "Save dialog shows .md file filter and uses sanitized document title as default filename"
  artifacts:
    - path: "electron-app/src/main/ipc/handlers.ts"
      provides: "file:writeFile IPC handler"
      contains: "file:writeFile"
    - path: "electron-app/src/preload/index.ts"
      provides: "writeFile method on ElectronAPI"
      contains: "writeFile"
    - path: "electron-app/src/renderer/components/knowledge/editor-toolbar.tsx"
      provides: "Export as Markdown button in toolbar"
      contains: "exportAsMarkdown"
  key_links:
    - from: "electron-app/src/renderer/components/knowledge/editor-toolbar.tsx"
      to: "electron-app/src/preload/index.ts"
      via: "window.electronAPI.showSaveDialog + window.electronAPI.writeFile"
      pattern: "writeFile"
---

<objective>
Add Markdown export capability: an IPC handler to write files to disk, and an export button in the editor toolbar that saves the document's pre-generated Markdown content as an .md file.

Purpose: Users can export documents for external sharing or backup (EXPR-01).
Output: Export button in toolbar, file write IPC, save dialog integration.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-search-templates-export/09-RESEARCH.md

@electron-app/src/main/ipc/handlers.ts
@electron-app/src/preload/index.ts
@electron-app/src/preload/index.d.ts
@electron-app/src/renderer/components/knowledge/editor-toolbar.tsx
@electron-app/src/renderer/hooks/use-documents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file:writeFile IPC handler and preload API, then add Export button to editor toolbar</name>
  <files>
    electron-app/src/main/ipc/handlers.ts
    electron-app/src/preload/index.ts
    electron-app/src/preload/index.d.ts
    electron-app/src/renderer/components/knowledge/editor-toolbar.tsx
  </files>
  <action>
**1. IPC handler (`main/ipc/handlers.ts`):**

Add a `file:writeFile` handler inside `registerIpcHandlers()`, in a new "File System Handlers" section:

```typescript
// ============================================
// File System Handlers
// ============================================

ipcMain.handle(
  'file:writeFile',
  async (_event, { filePath, content }: { filePath: string; content: string }) => {
    const { writeFile } = await import('fs/promises')
    await writeFile(filePath, content, 'utf-8')
  }
)
```

Add `'file:writeFile'` to the `handlers` array in `removeIpcHandlers()` for proper cleanup.

Import `fs/promises` dynamically inside the handler (or at the top of the file -- either pattern works, but dynamic import is simpler for a single use).

**2. Preload (`preload/index.ts`):**

Add `writeFile` to the `ElectronAPI` interface:

```typescript
writeFile: (filePath: string, content: string) => Promise<void>
```

Add the implementation in the `contextBridge.exposeInMainWorld` object:

```typescript
writeFile: (filePath: string, content: string) =>
  ipcRenderer.invoke('file:writeFile', { filePath, content }) as Promise<void>,
```

**3. Preload type declaration (`preload/index.d.ts`):**
If a separate `.d.ts` file exists for the ElectronAPI type, add `writeFile` there too. Otherwise, the type in `index.ts` is sufficient.

**4. Export button in editor toolbar (`components/knowledge/editor-toolbar.tsx`):**

Read the existing toolbar to understand its structure and conventions. Add an "Export" button, ideally in a utilities/actions section of the toolbar (near the end, or as a dropdown menu item if there's an overflow menu).

The export function:

```typescript
async function exportAsMarkdown() {
  // Get current document data -- the toolbar needs access to the document's
  // title and content_markdown. These should be available via props or context.
  // The document is likely passed as a prop to the toolbar or accessible
  // via the knowledge base context.

  if (!document?.content_markdown && !document?.content_json) return

  const markdown = document.content_markdown || ''
  const safeTitle = (document.title || 'Untitled')
    .replace(/[<>:"/\\|?*]/g, '_')
    .trim()

  const result = await window.electronAPI.showSaveDialog({
    title: 'Export as Markdown',
    defaultPath: `${safeTitle}.md`,
    filters: [{ name: 'Markdown', extensions: ['md'] }],
  })

  if (result.canceled || !result.filePath) return

  await window.electronAPI.writeFile(result.filePath, markdown)
}
```

Add the button:
- Use `Download` icon from lucide-react (or `FileDown` for clarity)
- Tooltip: "Export as Markdown"
- Style consistent with other toolbar buttons
- Disabled when no document is loaded or content_markdown is empty

**Access to document data:** The toolbar receives the TipTap `editor` instance. It needs the document object (for `title` and `content_markdown`). Check how the toolbar currently receives data:
- If the toolbar has access to document data via props, use that
- If not, add a prop like `document?: { title: string; content_markdown: string | null }` to the toolbar
- The parent component (DocumentEditor) already has the document data from `useDocument` hook -- pass it down

Wire the export function to the button's `onClick`. No additional hooks needed -- this is a direct Electron API call, not a server mutation.
  </action>
  <verify>
1. `cd electron-app && npx tsc --noEmit` passes
2. Verify `handlers.ts` contains `'file:writeFile'` handler
3. Verify `index.ts` (preload) exposes `writeFile` on ElectronAPI
4. Verify `editor-toolbar.tsx` has an export/download button
5. Verify the toolbar button calls `showSaveDialog` and `writeFile`
  </verify>
  <done>
file:writeFile IPC handler writes UTF-8 content to disk. Preload exposes writeFile on ElectronAPI. Editor toolbar has an Export as Markdown button that opens a save dialog with sanitized filename and writes the document's content_markdown to the chosen path.
  </done>
</task>

</tasks>

<verification>
1. IPC: file:writeFile handler registered in main process
2. Preload: writeFile exposed on window.electronAPI
3. Toolbar: Export button visible with Download/FileDown icon
4. Export: Clicking button opens native save dialog with .md filter
5. Export: File is written with document's content_markdown content
6. Export: Filename defaults to sanitized document title
7. `cd electron-app && npx tsc --noEmit` passes
</verification>

<success_criteria>
- User can click Export button in editor toolbar
- Native save dialog opens with .md extension and document title as default name
- Markdown file is written to the selected path with the document's pre-generated content_markdown
- Invalid filename characters in document title are sanitized to underscores
</success_criteria>

<output>
After completion, create `.planning/phases/09-search-templates-export/09-03-SUMMARY.md`
</output>
