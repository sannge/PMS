---
phase: 10-embedded-docs-and-mentions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - electron-app/src/renderer/components/knowledge/mention-list.tsx
  - electron-app/src/renderer/components/knowledge/mention-suggestion.ts
  - electron-app/src/renderer/components/knowledge/editor-extensions.ts
  - electron-app/src/renderer/components/knowledge/editor-styles.css
  - electron-app/src/renderer/components/knowledge/document-editor.tsx
autonomous: true

must_haves:
  truths:
    - "User can type @ in the editor to trigger a suggestion popup listing Applications and Projects"
    - "Suggestion popup filters results as user types after @"
    - "Selecting a suggestion inserts a styled mention node into the document"
    - "Clicking an inserted mention navigates to the referenced Application or Project"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/mention-list.tsx"
      provides: "Suggestion popup React component with keyboard navigation"
      min_lines: 60
    - path: "electron-app/src/renderer/components/knowledge/mention-suggestion.ts"
      provides: "TipTap suggestion config (items, render, command)"
      min_lines: 50
    - path: "electron-app/src/renderer/components/knowledge/editor-extensions.ts"
      provides: "Mention extension added to createDocumentExtensions"
      contains: "Mention"
  key_links:
    - from: "electron-app/src/renderer/components/knowledge/editor-extensions.ts"
      to: "electron-app/src/renderer/components/knowledge/mention-suggestion.ts"
      via: "mentionSuggestion imported and passed to Mention.configure"
      pattern: "import.*mentionSuggestion"
    - from: "electron-app/src/renderer/components/knowledge/mention-suggestion.ts"
      to: "electron-app/src/renderer/components/knowledge/mention-list.tsx"
      via: "ReactRenderer mounts MentionList component"
      pattern: "ReactRenderer.*MentionList"
    - from: "electron-app/src/renderer/components/knowledge/document-editor.tsx"
      to: "DashboardPage navigation"
      via: "onMentionClick callback prop"
      pattern: "onMentionClick"
---

<objective>
Build a TipTap @ mention extension that searches Applications and Projects from TanStack Query cache, shows a suggestion popup with keyboard navigation, inserts styled mention nodes, and navigates to the referenced entity on click.

Purpose: Users can link to Applications and Projects from within documents using @ mentions, creating a navigable knowledge graph.
Output: MentionList popup component, mention suggestion config, Mention extension in editor factory, click-to-navigate handler.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-embedded-docs-and-mentions/10-RESEARCH.md
@electron-app/src/renderer/components/knowledge/editor-extensions.ts
@electron-app/src/renderer/components/knowledge/document-editor.tsx
@electron-app/src/renderer/components/knowledge/editor-styles.css
@electron-app/src/renderer/lib/query-client.ts
@electron-app/src/renderer/hooks/use-queries.ts
@electron-app/src/renderer/pages/dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MentionList popup component and mention suggestion config</name>
  <files>
    electron-app/src/renderer/components/knowledge/mention-list.tsx
    electron-app/src/renderer/components/knowledge/mention-suggestion.ts
  </files>
  <action>
**1. Create MentionList component (mention-list.tsx):**
- A React component that renders the suggestion popup for @ mentions.
- Props (from TipTap suggestion): `items: MentionItem[]`, `command: (item: MentionItem) => void`.
- Interface `MentionItem`: `{ id: string; label: string; type: 'application' | 'project' }`.
- Use `forwardRef` to expose a `MentionListRef` with `onKeyDown({ event }: { event: KeyboardEvent }): boolean` for keyboard navigation.
- Internal state: `selectedIndex` (number, default 0). Reset to 0 when items change.
- Keyboard handling in `onKeyDown`:
  - ArrowUp: decrement selectedIndex (wrap to end).
  - ArrowDown: increment selectedIndex (wrap to start).
  - Enter: call `command(items[selectedIndex])`, return true.
  - Escape: return true (suggestion utility handles dismiss).
  - Other keys: return false (pass through).
- Render a vertical list of items:
  - Container: `div` with classes `bg-popover border border-border rounded-md shadow-md overflow-hidden py-1 w-64`.
  - Each item: `button` with full width, `px-3 py-1.5 text-sm text-left flex items-center gap-2`, hover highlight, selected highlight (use `bg-accent` for selected index).
  - Show an icon per type: `Building2` (lucide) for applications, `FolderKanban` for projects.
  - Show the label text.
  - Show a small type badge: `<span className="ml-auto text-xs text-muted-foreground">App</span>` or `Project`.
- If items is empty, show "No results" text in muted style.
- Export `MentionItem`, `MentionListRef`, and `MentionList`.

**2. Create mention suggestion config (mention-suggestion.ts):**
- Export `setMentionQueryClient(client: QueryClient): void` to store a module-level reference to the QueryClient.
- Export `mentionSuggestion: MentionOptions['suggestion']` object with:
  - `char: '@'`
  - `allowSpaces: false` (mention query stops at space)
  - `items({ query })`: Synchronously read from TanStack Query cache:
    - Get applications list from `queryClient.getQueryData(queryKeys.applications)`.
    - For each application, get its projects from `queryClient.getQueryData(queryKeys.projects(app.id))`.
    - Filter both by `name.toLowerCase().includes(query.toLowerCase())`.
    - Return combined results as `MentionItem[]`, limited to 8 items.
    - Applications first, then projects. Both sorted alphabetically within their group.
  - `render()`: Return object with `onStart`, `onUpdate`, `onKeyDown`, `onExit`:
    - `onStart(props)`: Create `ReactRenderer<MentionListRef>` with MentionList component. Create a popup `div` (absolute positioned, z-index 9999), append component.element, append to document.body. Position using `props.clientRect()` -- set `left` to rect.left, `top` to rect.bottom + 4px.
    - `onUpdate(props)`: Update component props and reposition popup.
    - `onKeyDown({ event })`: Delegate to `component.ref?.onKeyDown({ event }) ?? false`.
    - `onExit()`: Call `component.destroy()`, remove and null-out popup div. This is critical for cleanup.
  - `command({ editor, range, props })`: Insert mention node at range with attrs `{ id: props.id, label: props.label, type: props.type }`, followed by a space text node. Use `editor.chain().focus().insertContentAt(range, [...]).run()`.

- Import types from `@tiptap/extension-mention` (`MentionOptions`), `@tiptap/react` (`ReactRenderer`), and the query client module.
- Import `queryKeys` from `@/lib/query-client`.
  </action>
  <verify>
Run `cd electron-app && npx tsc --noEmit` -- should pass with zero errors.
Verify both files exist: `ls electron-app/src/renderer/components/knowledge/mention-list.tsx electron-app/src/renderer/components/knowledge/mention-suggestion.ts`.
  </verify>
  <done>
- MentionList component renders a styled popup with keyboard navigation (arrow keys + enter).
- Mention suggestion config reads applications/projects from TanStack Query cache.
- Popup positions correctly using clientRect from suggestion utility.
- Cleanup in onExit destroys ReactRenderer and removes popup div.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Mention extension into editor and add click-to-navigate handler</name>
  <files>
    electron-app/src/renderer/components/knowledge/editor-extensions.ts
    electron-app/src/renderer/components/knowledge/editor-styles.css
    electron-app/src/renderer/components/knowledge/document-editor.tsx
  </files>
  <action>
**1. Add Mention extension to editor-extensions.ts:**
- Import `Mention` from `@tiptap/extension-mention`.
- Import `{ mergeAttributes }` from `@tiptap/core` (may already be imported).
- Import `{ mentionSuggestion }` from `./mention-suggestion`.
- In the `createDocumentExtensions()` function, add a configured Mention extension to the returned array:
  ```
  Mention.extend({
    addAttributes() {
      return {
        ...this.parent?.(),
        type: {
          default: 'application',
          parseHTML: element => element.getAttribute('data-mention-type') || 'application',
          renderHTML: attributes => ({
            'data-mention-type': attributes.type,
          }),
        },
      }
    },
  }).configure({
    HTMLAttributes: {
      class: 'mention-node',
    },
    renderHTML({ node, HTMLAttributes }) {
      return [
        'span',
        mergeAttributes(HTMLAttributes, {
          'data-mention-type': node.attrs.type,
          'data-mention-id': node.attrs.id,
        }),
        `@${node.attrs.label ?? node.attrs.id}`,
      ]
    },
    suggestion: mentionSuggestion,
  })
  ```
- Use `<span>` NOT `<a>` to avoid conflicts with the Link extension (see research pitfall #5).
- The `type` attribute stores 'application' or 'project' to distinguish mention entity types.

**2. Add mention styles to editor-styles.css:**
- Add CSS for `.mention-node`:
  ```css
  .mention-node {
    color: hsl(var(--primary));
    font-weight: 500;
    cursor: pointer;
    border-radius: 0.25rem;
    padding: 0 0.125rem;
  }
  .mention-node:hover {
    text-decoration: underline;
    background-color: hsl(var(--primary) / 0.1);
  }
  ```

**3. Add onMentionClick callback and click handler to DocumentEditor (document-editor.tsx):**
- Add `onMentionClick?: (type: 'application' | 'project', id: string) => void` to the DocumentEditor props interface.
- In the component, add a click event handler on the editor container div (or use TipTap's `editorProps.handleDOMEvents.click`) that:
  - Checks if the clicked element (or closest parent) has `data-mention-type` and `data-mention-id` attributes.
  - If so, calls `onMentionClick?.(type, id)` with the attribute values.
  - This approach uses event delegation rather than attaching handlers to each mention node.
- Initialize the mention query client: In the component's mount effect (or a top-level effect), import and call `setMentionQueryClient(queryClient)` from `./mention-suggestion`, passing the queryClient from `@/lib/query-client`. This wires the suggestion's `items` callback to the live cache.

**Important considerations:**
- The `onMentionClick` callback propagates up to the page component, which can then call DashboardPage's navigation handlers (e.g., `setSelectedApplicationId`, `setActiveItem`). The actual navigation wiring at the page level is outside this plan's scope -- pages will receive and forward the callback as they integrate the editor in Phases 4-6.
- The mention node stores the entity name as `label` at insertion time. This is a snapshot -- if the entity is renamed later, the mention text becomes stale. This is accepted behavior for v1 (documented in research).
  </action>
  <verify>
Run `cd electron-app && npx tsc --noEmit` -- should pass with zero errors.
Grep for `Mention` in `editor-extensions.ts` to confirm the extension is registered.
Grep for `onMentionClick` in `document-editor.tsx` to confirm the callback prop exists.
Grep for `.mention-node` in `editor-styles.css` to confirm styles exist.
  </verify>
  <done>
- Mention extension is registered in createDocumentExtensions() with custom type attribute and span rendering.
- Mention nodes render as styled spans with data attributes for type and id.
- Click handler on editor delegates mention clicks to onMentionClick callback prop.
- setMentionQueryClient is called on editor mount to wire suggestion items to TanStack Query cache.
  </done>
</task>

</tasks>

<verification>
1. `cd electron-app && npx tsc --noEmit` passes with zero errors.
2. `mention-list.tsx` exists with MentionList component using forwardRef and keyboard navigation.
3. `mention-suggestion.ts` exists with mentionSuggestion config that reads from queryKeys.applications cache.
4. `editor-extensions.ts` includes Mention.extend().configure() with suggestion and custom type attribute.
5. `editor-styles.css` contains `.mention-node` styles.
6. `document-editor.tsx` has `onMentionClick` prop and click delegation handler for mention nodes.
</verification>

<success_criteria>
- TypeScript compiles without errors.
- Typing @ in the editor triggers the suggestion popup with application/project results from cache.
- Arrow keys navigate the popup, Enter selects and inserts a mention node.
- Inserted mention renders as a styled inline span with @EntityName text.
- Clicking a mention node fires the onMentionClick callback with entity type and id.
- Dismissing the popup (Escape or clicking away) cleans up the popup DOM element.
</success_criteria>

<output>
After completion, create `.planning/phases/10-embedded-docs-and-mentions/10-02-SUMMARY.md`
</output>
