---
phase: 02-notes-screen-shell-folder-navigation
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - electron-app/src/renderer/components/knowledge/scope-filter.tsx
  - electron-app/src/renderer/components/knowledge/tag-filter-list.tsx
  - electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can switch between All docs, My Notes, by Application, and by Project scope using a dropdown"
    - "Switching scope updates the folder tree and document list (via KnowledgeBaseContext scope change)"
    - "Tag list appears in sidebar showing tags for the current scope"
    - "Clicking a tag toggles it active/inactive and filters the document list"
    - "Active tags are visually highlighted"
    - "User can clear all active tag filters"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/scope-filter.tsx"
      provides: "Scope selector dropdown with All docs, My Notes, Application, Project options"
      exports: ["ScopeFilter"]
    - path: "electron-app/src/renderer/components/knowledge/tag-filter-list.tsx"
      provides: "Tag list with click-to-filter, active state highlighting, clear all button"
      exports: ["TagFilterList"]
  key_links:
    - from: "electron-app/src/renderer/components/knowledge/scope-filter.tsx"
      to: "electron-app/src/renderer/contexts/knowledge-base-context.tsx"
      via: "useKnowledgeBase().setScope dispatches SET_SCOPE action"
      pattern: "setScope"
    - from: "electron-app/src/renderer/components/knowledge/scope-filter.tsx"
      to: "electron-app/src/renderer/hooks/use-queries.ts"
      via: "useApplications() to populate application options"
      pattern: "useApplications"
    - from: "electron-app/src/renderer/components/knowledge/tag-filter-list.tsx"
      to: "electron-app/src/renderer/hooks/use-document-tags.ts"
      via: "useDocumentTags(scope, scopeId) for tag data"
      pattern: "useDocumentTags"
    - from: "electron-app/src/renderer/components/knowledge/tag-filter-list.tsx"
      to: "electron-app/src/renderer/contexts/knowledge-base-context.tsx"
      via: "useKnowledgeBase().toggleTag and clearTags"
      pattern: "toggleTag|clearTags"
---

<objective>
Build the scope filter dropdown and tag filter list sidebar sections, then wire them into the knowledge sidebar replacing the placeholders from Plan 01.

Purpose: This delivers requirements UI-10 (scope filter) and UI-03 (tag list with click-to-filter). The scope filter controls which documents/folders are visible across the entire Notes screen. The tag filter provides cross-cutting organization within a scope.

Output: A working scope selector that switches between All/Personal/Application/Project views, and a tag filter list that toggles tags to filter the document list.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@D:\FTX_CODE\pm-project\.planning\PROJECT.md
@D:\FTX_CODE\pm-project\.planning\ROADMAP.md
@D:\FTX_CODE\pm-project\.planning\phases\02-notes-screen-shell-folder-navigation\02-RESEARCH.md
@D:\FTX_CODE\pm-project\.planning\phases\02-notes-screen-shell-folder-navigation\02-01-SUMMARY.md
@D:\FTX_CODE\pm-project\.planning\codebase\CONVENTIONS.md
@D:\FTX_CODE\pm-project\electron-app\src\renderer\contexts\knowledge-base-context.tsx
@D:\FTX_CODE\pm-project\electron-app\src\renderer\hooks\use-document-tags.ts
@D:\FTX_CODE\pm-project\electron-app\src\renderer\hooks\use-queries.ts
@D:\FTX_CODE\pm-project\electron-app\src\renderer\components\knowledge\knowledge-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scope filter dropdown with application and project options</name>
  <files>
    electron-app/src/renderer/components/knowledge/scope-filter.tsx
  </files>
  <action>
    Create `scope-filter.tsx` using Radix UI Select component (`@radix-ui/react-select`, already installed).

    **Component structure:**
    - Import `Select, SelectContent, SelectGroup, SelectItem, SelectLabel, SelectSeparator, SelectTrigger, SelectValue` from `@/components/ui/select` (shadcn/ui wrapper around Radix Select)
    - If the shadcn/ui select component does not exist yet at `@/components/ui/select`, create it following the standard shadcn/ui pattern. Check first if it exists.
    - Read `scope` and `scopeId` from `useKnowledgeBase()`
    - Fetch applications with `useApplications()` from `@/hooks/use-queries` (existing hook that returns all user's applications)
    - Fetch projects: when an application is selected in scope, use existing hooks to get its projects. For the scope selector, we need all accessible projects. Use `useProjects(applicationId)` if available, or render application groups each with their projects.

    **Select options structure:**
    ```
    [All Documents]           -- scope='all', scopeId=null
    [My Notes]                -- scope='personal', scopeId=null (maps to user scope on API)
    ---separator---
    Applications:
      [App A]                 -- scope='application', scopeId=appA.id
      [App B]                 -- scope='application', scopeId=appB.id
    ---separator---
    Projects:
      [App A / Project 1]    -- scope='project', scopeId=project1.id
      [App A / Project 2]    -- scope='project', scopeId=project2.id
      [App B / Project 3]    -- scope='project', scopeId=project3.id
    ```

    **Value encoding:** Use a composite string value like `all`, `personal`, `application:{appId}`, `project:{projectId}` since Radix Select requires a string value. Parse it in the onChange handler:
    ```typescript
    const handleValueChange = (value: string) => {
      if (value === 'all') setScope('all', null)
      else if (value === 'personal') setScope('personal', null)
      else if (value.startsWith('application:')) setScope('application', value.split(':')[1])
      else if (value.startsWith('project:')) setScope('project', value.split(':')[1])
    }
    ```

    **Trigger display:**
    - Show icon + label: Globe icon for All, User icon for My Notes, Building icon for Application (show app name), Folder icon for Project (show project name)
    - Compact size: text-sm, h-8

    **Loading state:**
    - If applications are loading, show "Loading..." in the select groups
    - If no applications exist, still show All Documents and My Notes

    **Icons:** Use lucide-react icons: `Globe`, `User`, `Building2`, `FolderKanban` (or similar for projects)
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - ScopeFilter renders a Select dropdown with All Documents and My Notes as first options
    - Selecting an application sets scope='application' and scopeId to the app ID
    - Selecting a project sets scope='project' and scopeId to the project ID
    - Current scope selection displays correctly in the trigger
  </verify>
  <done>
    - ScopeFilter renders Radix Select with All Documents, My Notes, Applications (grouped), Projects (grouped)
    - Selecting any option dispatches setScope to KnowledgeBaseContext
    - SET_SCOPE action clears selection (handled by context from Plan 01)
    - Trigger shows appropriate icon and label for current scope
    - Applications and projects loaded from existing TanStack Query hooks
  </done>
</task>

<task type="auto">
  <name>Task 2: Tag filter list and wire scope filter + tags into sidebar</name>
  <files>
    electron-app/src/renderer/components/knowledge/tag-filter-list.tsx
    electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
  </files>
  <action>
    **1. Create `tag-filter-list.tsx`:**

    - Read `scope`, `scopeId`, `activeTagIds` from `useKnowledgeBase()`
    - Call `useDocumentTags(scope, scopeId)` to get tags for current scope
    - Read `toggleTag` and `clearTags` from `useKnowledgeBase()`

    **Layout:**
    - Section header: "Tags" label (text-xs font-semibold text-muted-foreground uppercase tracking-wider) with a "Clear" button (text-xs, text-muted-foreground, hover:text-foreground) visible only when activeTagIds.length > 0
    - Tag list: vertical list of tag items, each showing:
      - Small colored dot (tag.color or default gray, 8x8 rounded-full)
      - Tag name (text-sm)
      - Document count badge (optional, if API returns it)
    - Each tag item: `flex items-center gap-2 px-2 py-1 rounded-sm cursor-pointer hover:bg-accent`
    - Active tag: `bg-accent text-accent-foreground font-medium` (visually highlighted)
    - Click: calls `toggleTag(tag.id)` -- adds if not active, removes if active

    **Multiple active tags:** Tags are AND-filtered (a document must have ALL active tags). This matches common knowledge base patterns. The activeTagIds array in context is read by the useDocuments hook (from Plan 01) to filter results.

    **Empty state:** When no tags exist for this scope, show "No tags yet" in muted text.

    **Loading state:** When `useDocumentTags` isLoading, show 3 shimmer rows (same pattern as folder tree skeleton).

    **Scrollable:** If more than ~10 tags, the tag section should scroll. Wrap in `<ScrollArea className="max-h-40">` to cap height with scroll.

    **2. Update `knowledge-sidebar.tsx`** -- replace remaining placeholders:

    Remove the scope filter placeholder (`<div className="text-xs text-muted-foreground">All Documents</div>`) and replace with:
    ```tsx
    <ScopeFilter />
    ```

    Remove the tag filter placeholder (`<div className="text-xs text-muted-foreground">Tags</div>`) and replace with:
    ```tsx
    <TagFilterList />
    ```

    Import both components. The sidebar now has all four sections wired in:
    1. SearchBar (from Plan 01)
    2. ScopeFilter (this plan)
    3. FolderTree (from Plan 02, or placeholder if Plan 02 not yet executed -- handle gracefully)
    4. TagFilterList (this plan)

    **Collapsed sidebar behavior:**
    - When sidebar is collapsed (`isSidebarCollapsed` from context):
      - Hide search bar, scope filter, tag list
      - Show only the sidebar toggle button (PanelLeftOpen icon)
      - Optionally show small icon-only buttons for key actions
    - Width: `w-10` when collapsed, `w-64` when expanded

    **Anti-patterns to avoid:**
    - Do NOT fetch tags in a way that duplicates IndexedDB persistence. useDocumentTags hooks use TanStack Query which auto-persists.
    - Do NOT add tag CRUD (create/edit/delete tags) in this plan. Phase 2 only filters by existing tags. Tag management is implicit through document tag assignment (later phases).
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - Tag list renders tags for the current scope
    - Clicking a tag toggles its active state (visual highlight changes)
    - "Clear" button appears when tags are active and clears all
    - knowledge-sidebar.tsx no longer has placeholder text for scope filter or tags
    - Scope filter dropdown is visible in the sidebar
  </verify>
  <done>
    - TagFilterList shows tags for current scope with colored dots and names
    - Clicking a tag toggles active state via toggleTag in context
    - Active tags highlighted with bg-accent
    - Clear button removes all active tags
    - Empty state shown when no tags exist
    - Scrollable when more than ~10 tags
    - KnowledgeSidebar fully assembled: SearchBar, ScopeFilter, FolderTree, TagFilterList
    - All placeholder text removed from sidebar
    - Collapsed sidebar shows only toggle button
    - TypeScript compiles, lint passes
  </done>
</task>

</tasks>

<verification>
1. `cd electron-app && npm run typecheck` -- zero TypeScript errors
2. `cd electron-app && npm run lint` -- zero warnings
3. Scope filter dropdown shows All Documents, My Notes, and groups for Applications/Projects
4. Switching scope updates the folder tree and tag list (data refetches for new scope)
5. Tag list shows tags for current scope with click-to-toggle filtering
6. Active tags are visually highlighted, Clear button works
7. Sidebar fully assembled with all four sections (search, scope, tree, tags)
8. Collapsed sidebar hides content and shows only expand button
</verification>

<success_criteria>
- Scope filter renders with all 4 scope types (All, Personal, Application, Project) using Radix Select
- Selecting a scope dispatches setScope to context, which clears selection and triggers data refetch
- Tag list renders tags for current scope with colored indicators
- Tag click toggles filter state, multiple tags can be active simultaneously
- Clear button removes all active tag filters
- Sidebar is fully composed: SearchBar + ScopeFilter + FolderTree + TagFilterList
- No Zustand, no custom IndexedDB code, all data via TanStack Query hooks
</success_criteria>

<output>
After completion, create `.planning/phases/02-notes-screen-shell-folder-navigation/02-03-SUMMARY.md`
</output>
