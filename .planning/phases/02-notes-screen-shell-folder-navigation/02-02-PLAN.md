---
phase: 02-notes-screen-shell-folder-navigation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - electron-app/src/renderer/components/knowledge/folder-tree.tsx
  - electron-app/src/renderer/components/knowledge/folder-tree-item.tsx
  - electron-app/src/renderer/components/knowledge/folder-context-menu.tsx
  - electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Folder tree displays in sidebar with expand/collapse on folder click"
    - "Right-clicking a folder shows context menu with New Folder, New Document, Rename, Move, Delete options"
    - "Right-clicking a document shows context menu with Rename, Move, Delete options"
    - "Creating a new folder via context menu calls the API and the tree updates"
    - "Creating a new document via context menu calls the API and the tree updates"
    - "Renaming a folder/document via context menu shows inline edit and saves on Enter/blur"
    - "Folder tree renders immediately from IndexedDB cache on repeat visits (no loading spinner when cached data exists)"
    - "Documents not in a folder appear in an Unfiled section below the folder tree"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/folder-tree.tsx"
      provides: "Recursive folder tree component with expand/collapse, unfiled section, loading skeleton"
      exports: ["FolderTree"]
    - path: "electron-app/src/renderer/components/knowledge/folder-tree-item.tsx"
      provides: "Single tree item (folder or document) with icon, name, expand chevron, click handling"
      exports: ["FolderTreeItem"]
    - path: "electron-app/src/renderer/components/knowledge/folder-context-menu.tsx"
      provides: "Right-click context menu for folder/document tree items"
      exports: ["FolderContextMenu"]
  key_links:
    - from: "electron-app/src/renderer/components/knowledge/folder-tree.tsx"
      to: "electron-app/src/renderer/hooks/use-document-folders.ts"
      via: "useFolderTree hook call"
      pattern: "useFolderTree"
    - from: "electron-app/src/renderer/components/knowledge/folder-tree.tsx"
      to: "electron-app/src/renderer/contexts/knowledge-base-context.tsx"
      via: "useKnowledgeBase for scope, expandedFolderIds, selectedFolderId"
      pattern: "useKnowledgeBase"
    - from: "electron-app/src/renderer/components/knowledge/folder-context-menu.tsx"
      to: "electron-app/src/renderer/hooks/use-document-folders.ts"
      via: "useCreateFolder, useRenameFolder, useDeleteFolder mutations"
      pattern: "useCreateFolder|useRenameFolder|useDeleteFolder"
    - from: "electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx"
      to: "electron-app/src/renderer/components/knowledge/folder-tree.tsx"
      via: "FolderTree component rendered in scrollable area"
      pattern: "<FolderTree"
---

<objective>
Build the folder tree component with expand/collapse, right-click context menus, inline rename, and unfiled documents section. Wire it into the sidebar from Plan 01.

Purpose: This delivers requirement UI-02 (folder tree with context menu) and CACHE-03 (folder tree renders instantly from IndexedDB cache). The folder tree is the primary navigation element in the Notes sidebar.

Output: A fully interactive folder tree with CRUD operations via context menu, immediate rendering from cached data, and proper loading states.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@D:\FTX_CODE\pm-project\.planning\PROJECT.md
@D:\FTX_CODE\pm-project\.planning\ROADMAP.md
@D:\FTX_CODE\pm-project\.planning\phases\02-notes-screen-shell-folder-navigation\02-RESEARCH.md
@D:\FTX_CODE\pm-project\.planning\phases\02-notes-screen-shell-folder-navigation\02-01-SUMMARY.md
@D:\FTX_CODE\pm-project\.planning\codebase\CONVENTIONS.md
@D:\FTX_CODE\pm-project\electron-app\src\renderer\hooks\use-document-folders.ts
@D:\FTX_CODE\pm-project\electron-app\src\renderer\hooks\use-documents.ts
@D:\FTX_CODE\pm-project\electron-app\src\renderer\contexts\knowledge-base-context.tsx
@D:\FTX_CODE\pm-project\electron-app\src\renderer\components\knowledge\knowledge-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Folder tree component with expand/collapse, loading states, and unfiled section</name>
  <files>
    electron-app/src/renderer/components/knowledge/folder-tree.tsx
    electron-app/src/renderer/components/knowledge/folder-tree-item.tsx
  </files>
  <action>
    **1. Create `folder-tree-item.tsx`** -- a single node in the folder tree:

    Props:
    ```typescript
    interface FolderTreeItemProps {
      node: FolderTreeNode | DocumentListItem
      type: 'folder' | 'document'
      depth: number
      isExpanded?: boolean        // only for folders
      isSelected: boolean
      isRenaming: boolean
      onToggleExpand?: () => void // only for folders
      onSelect: () => void
      onContextMenu: (e: React.MouseEvent) => void
      onRenameSubmit: (newName: string) => void
      onRenameCancel: () => void
    }
    ```

    Rendering:
    - Indentation: `paddingLeft: depth * 16 + 8` px
    - Folder icon: `Folder` (closed) or `FolderOpen` (expanded) from lucide-react
    - Document icon: `FileText` from lucide-react
    - Expand chevron: `ChevronRight` icon that rotates 90deg when expanded (CSS transition `transition-transform duration-200`)
    - Name: text-sm, truncate with ellipsis, flex-1
    - Document count badge (for folders): small muted badge showing count if > 0
    - Selected state: `bg-accent text-accent-foreground` background
    - Hover state: `hover:bg-accent/50`
    - Full row is clickable: folders toggle expand, documents call onSelect
    - Right-click: calls onContextMenu with the mouse event
    - Rename mode: when `isRenaming` is true, replace name text with a controlled `<input>` (auto-focused, select-all on mount). Submit on Enter or blur, cancel on Escape.
    - Use `cn()` from `@/lib/utils` for class merging

    **2. Create `folder-tree.tsx`** -- the recursive tree container:

    This component:
    - Reads `scope`, `scopeId`, `expandedFolderIds`, `selectedFolderId`, `selectedDocumentId` from `useKnowledgeBase()`
    - Calls `useFolderTree(scope, scopeId)` to get folder data
    - Calls `useDocuments(scope, scopeId, { folderId: null })` to get unfiled documents (documents with no folder)
    - Manages local state for: `renamingItemId: string | null`, `contextMenuTarget: { id, type, x, y } | null`

    **Loading behavior (CRITICAL for CACHE-03):**
    - Use `isLoading` from useFolderTree (true ONLY when no data at all, including no cached data)
    - When `isLoading` is true: show `<FolderTreeSkeleton />` (3-4 shimmer rows with varying indentation)
    - When data exists (even if `isFetching` is true for background refresh): render the tree immediately
    - Optional: show a subtle refresh indicator when `isFetching && !isLoading` (small spinner in section header)
    - Do NOT show a loading spinner when cached data exists. This is the core of CACHE-03.

    **Tree rendering:**
    - Recursively render `FolderTreeNode[]` from useFolderTree
    - For each folder: render `FolderTreeItem` with type="folder", then if expanded, render children recursively
    - After the folder tree, render an "Unfiled" section separator (small text divider "Unfiled") followed by documents that have no folder_id
    - Each unfiled document: render `FolderTreeItem` with type="document", depth=0

    **Expand/collapse:**
    - On folder click: dispatch `toggleFolder(folderId)` to KnowledgeBaseContext
    - `expandedFolderIds` persists across tree refreshes (stored in Context, not derived from data)
    - Children are only rendered when folder is expanded

    **Selection:**
    - On document click: dispatch `selectDocument(documentId)` and `selectFolder(null)`
    - On folder click (in addition to toggle): dispatch `selectFolder(folderId)` and `selectDocument(null)`
    - Highlight selected item

    **Context menu:**
    - On right-click of any item: set `contextMenuTarget` with item id, type, and mouse position
    - Render `<FolderContextMenu>` (from next task's file, but import it here) when contextMenuTarget is set
    - Pass appropriate handlers for each menu action

    **Empty state:**
    - When tree is empty (no folders and no unfiled documents): show a centered message "No documents yet" with a button "Create your first document"

    **FolderTreeSkeleton sub-component** (inline in same file):
    - 4 shimmer rows using `animate-pulse bg-muted` with heights of h-6 and varying widths (60%, 80%, 50%, 70%) and indentation levels (0, 16, 16, 32 px padding-left)
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - FolderTree component renders without errors when folder data is provided
    - Grep for `useFolderTree` in folder-tree.tsx confirms hook usage
    - Grep for `isLoading` in folder-tree.tsx confirms loading state handling (skeleton, not spinner)
    - Grep for `expandedFolderIds` confirms state from context is used (not derived from data)
  </verify>
  <done>
    - folder-tree-item.tsx renders folder/document nodes with correct icons, indentation, expand chevron, selection highlight, hover state, and inline rename
    - folder-tree.tsx recursively renders the folder tree from useFolderTree data
    - Unfiled documents section appears below folder tree
    - Loading skeleton shown only when no data at all (isLoading); cached data renders immediately
    - Expand/collapse uses expandedFolderIds from KnowledgeBaseContext (persists across refreshes)
    - Empty state shown when no folders or documents exist
  </done>
</task>

<task type="auto">
  <name>Task 2: Context menu with CRUD actions, and wire folder tree into sidebar</name>
  <files>
    electron-app/src/renderer/components/knowledge/folder-context-menu.tsx
    electron-app/src/renderer/components/knowledge/knowledge-sidebar.tsx
  </files>
  <action>
    **1. Create `folder-context-menu.tsx`** -- the right-click context menu:

    Props:
    ```typescript
    interface FolderContextMenuProps {
      target: {
        id: string
        type: 'folder' | 'document'
        name: string
      }
      position: { x: number; y: number }
      onClose: () => void
      onNewFolder: (parentId: string) => void
      onNewDocument: (folderId: string) => void
      onRename: (id: string) => void
      onDelete: (id: string, type: 'folder' | 'document') => void
    }
    ```

    **Implementation pattern** (from existing notes-sidebar.tsx custom context menu):
    - Render a transparent full-screen backdrop (`fixed inset-0 z-50`) that closes menu on click
    - Render menu as `fixed z-50 min-w-[180px] rounded-md border border-border bg-popover p-1 shadow-md` at the given position
    - **Boundary checking:** After rendering, check if menu would overflow viewport. Adjust position:
      ```typescript
      const menuWidth = 180
      const menuHeight = type === 'folder' ? 200 : 140 // estimate
      const adjustedX = Math.min(position.x, window.innerWidth - menuWidth - 8)
      const adjustedY = Math.min(position.y, window.innerHeight - menuHeight - 8)
      ```

    **Menu items for folder:**
    1. New Folder (FolderPlus icon) -- calls onNewFolder(target.id)
    2. New Document (FilePlus icon) -- calls onNewDocument(target.id)
    3. Separator
    4. Rename (Pencil icon) -- calls onRename(target.id)
    5. Separator
    6. Delete (Trash2 icon, text-destructive) -- calls onDelete(target.id, 'folder')

    **Menu items for document:**
    1. Rename (Pencil icon) -- calls onRename(target.id)
    2. Separator
    3. Delete (Trash2 icon, text-destructive) -- calls onDelete(target.id, 'document')

    Each menu item: `flex items-center gap-2 px-2 py-1.5 text-sm rounded-sm cursor-pointer hover:bg-accent hover:text-accent-foreground`. Close menu after any action.

    **CRUD wiring in folder-tree.tsx** (update folder-tree.tsx to wire context menu callbacks to mutations):
    - Import and call `useCreateFolder()`, `useCreateDocument()`, `useRenameFolder()`, `useRenameDocument()`, `useDeleteFolder()`, `useDeleteDocument()` from the hook files created in Plan 01
    - `onNewFolder`: call `createFolder.mutate({ name: 'New Folder', parent_id: parentFolderId, scope, scope_id: scopeId })`. On success, set the new folder ID as renamingItemId so it enters rename mode immediately.
    - `onNewDocument`: call `createDocument.mutate({ title: 'Untitled', scope, scope_id: scopeId, folder_id: folderId })`. On success, select the new document and set renamingItemId.
    - `onRename`: set `renamingItemId` to the target id. The FolderTreeItem will show inline input.
    - `onRenameSubmit`: call `renameFolder.mutate()` or `renameDocument.mutate()` depending on type.
    - `onDelete`: call `deleteFolder.mutate()` or `deleteDocument.mutate()`. If the deleted item was selected, clear selection.
    - After `onNewFolder`, expand the parent folder if it was collapsed.

    **2. Update `knowledge-sidebar.tsx`** -- replace the folder tree placeholder:
    - Remove the placeholder `<div>Folder tree loading...</div>`
    - Import and render `<FolderTree />` inside the `<ScrollArea>` section
    - The FolderTree component is self-contained (reads scope from context, fetches data via hooks)
    - No props needed -- FolderTree gets everything from context and hooks

    **Anti-patterns to avoid:**
    - Do NOT use @radix-ui/react-context-menu (not installed). Use the custom positioned div pattern.
    - Do NOT pass tree data as props through multiple levels. FolderTree reads from hooks directly.
    - Do NOT show confirmation dialog for delete in Phase 2. A simple delete is fine for now. (Confirmation can be added later.)
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run lint` passes
    - Right-clicking a folder in the tree shows the context menu with all 6 items
    - Right-clicking a document shows 3 items (rename, separator, delete)
    - Creating a new folder via context menu calls the API (check network in dev tools)
    - Context menu does not overflow the viewport edges
    - knowledge-sidebar.tsx no longer has the folder tree placeholder text
  </verify>
  <done>
    - FolderContextMenu renders at mouse position with boundary checking
    - Folder context menu shows: New Folder, New Document, Rename, Delete
    - Document context menu shows: Rename, Delete
    - New Folder/Document creates via API and enters inline rename mode immediately
    - Rename shows inline input, saves on Enter/blur, cancels on Escape
    - Delete calls soft-delete API and clears selection if deleted item was selected
    - KnowledgeSidebar renders FolderTree in the scrollable area (placeholder removed)
    - TypeScript compiles, lint passes
  </done>
</task>

</tasks>

<verification>
1. `cd electron-app && npm run typecheck` -- zero TypeScript errors
2. `cd electron-app && npm run lint` -- zero warnings
3. Folder tree renders folders and documents with correct hierarchy and indentation
4. Right-click context menu appears with correct items for folders vs documents
5. CRUD operations (create, rename, delete) call the correct API endpoints via TanStack Query mutations
6. Folder tree renders immediately from cache on repeat visits (no loading spinner when cached data exists)
7. Unfiled documents appear in a separate section below the folder tree
8. Expanded folder state persists through tree data refreshes
</verification>

<success_criteria>
- Folder tree displays with expand/collapse, proper indentation, and folder/document icons
- Right-click context menu works on folders (6 items) and documents (3 items)
- All CRUD operations wired to API mutations from Plan 01 hooks
- Inline rename on new item creation and explicit rename action
- Loading skeleton only shown when no cached data; cached tree renders instantly (CACHE-03)
- Unfiled documents section shows docs without folder_id
- No custom IndexedDB code -- caching is automatic via per-query-persister
</success_criteria>

<output>
After completion, create `.planning/phases/02-notes-screen-shell-folder-navigation/02-02-SUMMARY.md`
</output>
