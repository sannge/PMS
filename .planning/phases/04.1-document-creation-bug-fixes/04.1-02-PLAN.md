---
phase: 04.1-document-creation-bug-fixes
plan: 02
type: execute
wave: 2
depends_on: ["04.1-01"]
files_modified:
  - electron-app/src/renderer/components/knowledge/scope-picker-dialog.tsx
  - electron-app/src/renderer/components/knowledge/folder-tree.tsx
autonomous: true

must_haves:
  truths:
    - "Creating a document from 'All Documents' opens a scope picker dialog before creating"
    - "Creating a document from 'My Notes' sends the current user UUID as scope_id"
    - "Create button is disabled while mutation is in-flight"
    - "Failed document creation shows an error toast"
  artifacts:
    - path: "electron-app/src/renderer/components/knowledge/scope-picker-dialog.tsx"
      provides: "Scope picker dialog for choosing scope when creating from All Documents"
      exports: ["ScopePickerDialog"]
    - path: "electron-app/src/renderer/components/knowledge/folder-tree.tsx"
      provides: "Fixed create flows with scope resolution, loading state, error toast"
  key_links:
    - from: "electron-app/src/renderer/components/knowledge/folder-tree.tsx"
      to: "scope-picker-dialog.tsx"
      via: "ScopePickerDialog open state"
      pattern: "ScopePickerDialog"
    - from: "electron-app/src/renderer/components/knowledge/folder-tree.tsx"
      to: "auth-context"
      via: "useAuthStore for userId resolution"
      pattern: "useAuthStore"
    - from: "electron-app/src/renderer/components/knowledge/folder-tree.tsx"
      to: "sonner"
      via: "toast.error on mutation failure"
      pattern: "toast\\.error"
---

<objective>
Fix document creation flows: scope picker for "All Documents", personal scope resolution, loading/error states.

Purpose: Make document creation work correctly across all scopes with proper UX feedback. After this plan, all six phase success criteria are met.

Output: ScopePickerDialog component, fixed folder-tree.tsx with correct scope resolution, disabled state on create button, and error toasts.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04.1-document-creation-bug-fixes/04.1-RESEARCH.md
@.planning/phases/04.1-document-creation-bug-fixes/04.1-01-SUMMARY.md
@electron-app/src/renderer/components/knowledge/folder-tree.tsx
@electron-app/src/renderer/components/knowledge/folder-context-menu.tsx
@electron-app/src/renderer/hooks/use-documents.ts
@electron-app/src/renderer/contexts/knowledge-base-context.tsx
@electron-app/src/renderer/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScopePickerDialog component</name>
  <files>
    electron-app/src/renderer/components/knowledge/scope-picker-dialog.tsx
  </files>
  <action>
    Create a new ScopePickerDialog component that lets the user choose a scope (application, project, or personal) before creating a document. This dialog is shown when the user tries to create a document from "All Documents" view where no real scope exists.

    **Props interface:**
    ```typescript
    interface ScopePickerDialogProps {
      open: boolean
      onOpenChange: (open: boolean) => void
      onConfirm: (scope: string, scopeId: string) => void
    }
    ```

    **Implementation details:**
    - Use existing Radix Dialog from `@/components/ui/dialog` (Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter)
    - Use existing Button from `@/components/ui/button` (check if exists; if not, use plain `<button>` with Tailwind classes matching the project's button pattern)
    - Fetch available scopes using existing hooks: `useApplications()` and `useProjects(appId)` from `@/hooks/use-queries`
    - Get current user from `useAuthStore((s) => s.user)` from `@/contexts/auth-context`

    **Dialog layout:**
    - Title: "Choose scope"
    - Description: "Select where to create your document"
    - Radio-style list (simple clickable rows with highlight on selection, NOT Radix RadioGroup unless already in project):
      - "My Notes" row with User icon (scope='personal', scopeId=user.id)
      - Then for each application: application name row with Building2 icon (scope='application', scopeId=app.id)
      - Then for each application's projects: "AppName / ProjectName" row with FolderKanban icon (scope='project', scopeId=project.id) -- use per-application ProjectItems pattern similar to scope-filter.tsx
    - Footer: Cancel button + "Create" button (disabled until a scope is selected)

    **State management:**
    - `selectedScope: { scope: string; scopeId: string } | null` -- tracks current selection
    - On "Create" click: call `onConfirm(selectedScope.scope, selectedScope.scopeId)` and let the parent handle closing

    **Styling:** Use existing project patterns -- Tailwind classes, cn() utility, lucide-react icons. Each row should look like a selectable list item: `px-3 py-2 rounded-md cursor-pointer hover:bg-accent` with `bg-accent text-accent-foreground` when selected.

    **Important:** The dialog should NOT call createDocument itself. It only returns the chosen scope to the parent. The parent (folder-tree.tsx) handles the mutation.
  </action>
  <verify>
    `cd electron-app && npx tsc --noEmit` passes.
    File exists at `electron-app/src/renderer/components/knowledge/scope-picker-dialog.tsx`.
    File exports `ScopePickerDialog`.
  </verify>
  <done>
    ScopePickerDialog component exists, typed correctly, renders scope options from real data, returns chosen scope on confirm.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix folder-tree.tsx create flows with scope resolution, scope picker, loading state, and error toast</name>
  <files>
    electron-app/src/renderer/components/knowledge/folder-tree.tsx
  </files>
  <action>
    This task makes four changes to folder-tree.tsx to fix bugs 2, 3, and 5.

    **Change 1: Import additions**
    Add these imports at the top:
    - `import { toast } from 'sonner'`
    - `import { useAuthStore } from '@/contexts/auth-context'`
    - `import { ScopePickerDialog } from './scope-picker-dialog'`

    **Change 2: Personal scope resolution (Bug 3 fix)**
    Inside the FolderTree component, add:
    ```typescript
    const userId = useAuthStore((s) => s.user?.id ?? null)
    ```

    Then in BOTH `handleCreateFirstDocument` and `handleNewDocument` callbacks, change:
    ```typescript
    // BEFORE:
    const resolvedScopeId = scopeId ?? ''
    // AFTER:
    const resolvedScopeId = scope === 'personal' ? (userId ?? '') : (scopeId ?? '')
    ```

    This ensures personal scope sends the user's UUID instead of empty string.

    **Change 3: Scope picker for "All Documents" (Bug 2 fix)**
    Add state for the scope picker dialog:
    ```typescript
    const [scopePickerOpen, setScopePickerOpen] = useState(false)
    const [pendingFolderId, setPendingFolderId] = useState<string | null>(null)
    ```

    Modify `handleCreateFirstDocument` (line 264-280):
    - If `scope === 'all'`, set `scopePickerOpen = true` and `pendingFolderId = null`, then return (do NOT call createDocument.mutate)
    - Otherwise proceed with existing logic (with the scope resolution fix from Change 2)

    Modify `handleNewDocument` (line 161-183):
    - If `scope === 'all'`, set `scopePickerOpen = true` and `setPendingFolderId(folderId)`, then return
    - Otherwise proceed with existing logic (with the scope resolution fix from Change 2)

    Add a scope picker confirm handler:
    ```typescript
    const handleScopePickerConfirm = useCallback(
      (chosenScope: string, chosenScopeId: string) => {
        createDocument.mutate(
          {
            title: 'Untitled',
            scope: chosenScope,
            scope_id: chosenScopeId,
            folder_id: pendingFolderId,
          },
          {
            onSuccess: (data) => {
              setScopePickerOpen(false)
              selectDocument(data.id)
              selectFolder(null)
              if (pendingFolderId) expandFolder(pendingFolderId)
              setRenamingItemId(data.id)
              setRenamingItemType('document')
            },
            onError: (error) => {
              toast.error(error.message)
            },
          }
        )
      },
      [createDocument, pendingFolderId, selectDocument, selectFolder, expandFolder]
    )
    ```

    **Change 4: Loading state and error toast (Bug 5 fix)**
    In the empty-state button (around line 368-379), add:
    - `disabled={createDocument.isPending}` to the button
    - Show Loader2 spinner when pending: swap FilePlus icon with `<Loader2 className="h-4 w-4 animate-spin" />` when `createDocument.isPending`
    - Change text to "Creating..." when pending

    Add `onError` callback to all existing `createDocument.mutate()` calls (handleCreateFirstDocument, handleNewDocument):
    ```typescript
    onError: (error) => {
      toast.error(error.message)
    },
    ```

    **Change 5: Render ScopePickerDialog**
    Add the dialog to the JSX return, just before the closing `</div>` of the main render:
    ```tsx
    <ScopePickerDialog
      open={scopePickerOpen}
      onOpenChange={setScopePickerOpen}
      onConfirm={handleScopePickerConfirm}
    />
    ```

    **Important:** Loader2 is already imported in folder-tree.tsx (line 13). Do not duplicate the import.
  </action>
  <verify>
    `cd electron-app && npx tsc --noEmit` passes.
    Grep confirms:
    - folder-tree.tsx contains `toast.error`
    - folder-tree.tsx contains `useAuthStore`
    - folder-tree.tsx contains `ScopePickerDialog`
    - folder-tree.tsx contains `createDocument.isPending`
    - folder-tree.tsx contains `scope === 'personal' ? (userId` (or similar pattern)
  </verify>
  <done>
    1. "All Documents" create opens scope picker dialog
    2. "My Notes" create resolves userId from auth store
    3. Create button disabled during pending mutation
    4. Error toast shown on create failure
  </done>
</task>

</tasks>

<verification>
All six phase success criteria verifiable:
1. Duplicate icons: Fixed in Plan 01 (ScopeTriggerContent uses static text)
2. "All Documents" scope picker: ScopePickerDialog opens, user chooses scope, document creates
3. "My Notes" scope_id: useAuthStore resolves userId for personal scope
4. Application/Project 500: Fixed in Plan 01 (tags lazy="selectin")
5. Button disabled during pending: createDocument.isPending disables button
6. Error toast: toast.error() called in onError callbacks

TypeScript check: `cd electron-app && npx tsc --noEmit` must pass with zero errors.
</verification>

<success_criteria>
1. ScopePickerDialog component exists and exports correctly
2. folder-tree.tsx uses useAuthStore to resolve personal scope userId
3. folder-tree.tsx shows ScopePickerDialog when scope === 'all'
4. Create button shows loading spinner and is disabled when isPending
5. All createDocument.mutate calls include onError with toast.error
6. TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-document-creation-bug-fixes/04.1-02-SUMMARY.md`
</output>
