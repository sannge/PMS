---
phase: "04.1"
plan: "01"
subsystem: "knowledge-base"
tags: ["bug-fix", "sqlalchemy", "radix-select", "sonner", "toast"]

dependency_graph:
  requires: ["04-01"]
  provides: ["Document.tags selectin loading", "scope filter single-icon rendering", "sonner toast infrastructure"]
  affects: ["04.1-02"]

tech_stack:
  added: ["sonner@2.0.7"]
  patterns: []

file_tracking:
  created: []
  modified:
    - "fastapi-backend/app/models/document.py"
    - "electron-app/src/renderer/components/knowledge/scope-filter.tsx"
    - "electron-app/src/renderer/App.tsx"
    - "electron-app/package.json"

decisions:
  - id: "04.1-01-01"
    decision: "Only Document.tags lazy changed to selectin; other models left as-is"
    rationale: "Only Document.tags confirmed broken with async sessions"

metrics:
  duration: "~3 min"
  completed: "2026-02-01"
---

# Phase 4.1 Plan 01: Backend Tags Fix, Scope Filter Icons, Sonner Install

**One-liner:** Fix Document.tags async crash (selectin), eliminate duplicate scope filter icons (remove SelectValue), install sonner for toast notifications.

## Tasks Completed

| # | Task | Commit | Key Changes |
|---|------|--------|-------------|
| 1 | Fix backend tags relationship and frontend icon duplication | 448de56 | Document.tags lazy="selectin", ScopeTriggerContent uses static spans |
| 2 | Install sonner and mount Toaster in app root | e00a836 | sonner@2.0.7, Toaster richColors in App.tsx ErrorBoundary |

## What Was Done

### Task 1: Backend Tags + Frontend Icons
- **Backend:** Changed `Document.tags` relationship from `lazy="dynamic"` to `lazy="selectin"` in `document.py`. The `dynamic` lazy loader returns a synchronous Query object incompatible with async SQLAlchemy sessions, causing 500 errors when creating/fetching documents with tags.
- **Frontend:** Replaced all `<SelectValue>` elements in `ScopeTriggerContent` with plain `<span>` elements containing static text labels. SelectValue was rendering the full selected item content (which includes an icon), causing duplicate icons alongside the explicitly rendered icon. Removed unused `SelectValue` import.

### Task 2: Sonner Toast Infrastructure
- Installed `sonner@2.0.7` via npm.
- Added `<Toaster richColors />` inside the ErrorBoundary in App.tsx, after QueryClientInitializer. This makes `toast.error()` and `toast.success()` available anywhere in the app via `import { toast } from 'sonner'`.

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

- Backend: `python -c "from app.models.document import Document"` -- OK
- Frontend: `npx tsc --noEmit` -- zero errors in modified files (pre-existing errors in unrelated files)
- scope-filter.tsx: grep confirms zero `SelectValue` references
- App.tsx: contains `<Toaster richColors />`
- sonner: v2.0.7 installed in node_modules

## Next Phase Readiness

Plan 04.1-02 can proceed immediately. Sonner is available for error toast usage. Document creation in Application/Project scopes should no longer 500 on tags loading.
