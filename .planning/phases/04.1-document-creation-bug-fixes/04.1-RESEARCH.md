# Phase 4.1: Document Creation Bug Fixes - Research

**Researched:** 2026-01-31
**Domain:** Frontend (React/Radix UI) + Backend (SQLAlchemy async) bug fixes
**Confidence:** HIGH

## Summary

This phase addresses five diagnosed bugs in the document creation flow across the knowledge base feature. All bugs have been traced to specific files and line numbers. The fixes span both frontend (Radix Select rendering, scope resolution, mutation UX) and backend (SQLAlchemy async relationship loading).

The bugs are well-understood with clear root causes. No library research or architectural investigation is needed -- the fixes are surgical changes to existing code with well-known patterns.

**Primary recommendation:** Fix each bug independently in order of backend-first (unblock creation), then frontend UX (icons, scope picker, loading states).

## Bug Analysis and Fix Patterns

### Bug 1: Duplicate Globe Icons in Scope Filter

**File:** `electron-app/src/renderer/components/knowledge/scope-filter.tsx`
**Root cause:** `ScopeTriggerContent` renders an icon (e.g., `<Globe>`) alongside `<SelectValue>`. But Radix `SelectValue` renders the selected item's `<SelectPrimitive.ItemText>` content, which itself includes an icon inside each `<SelectItem>`. So the trigger shows: [explicit icon] + [SelectValue renders item icon + text].

**Evidence (HIGH confidence):**
- `ScopeTriggerContent` (lines 136-180): Each branch renders `<Icon>` + `<SelectValue placeholder="...">`
- Each `<SelectItem>` (lines 83-93): Contains `<span className="flex items-center gap-2"><Globe .../> All Documents</span>` wrapped in `<SelectPrimitive.ItemText>` (select.tsx line 128)
- When selected, `SelectValue` renders the full `ItemText` children, which includes the icon

**Fix pattern:** Either:
- (A) Remove icons from `SelectItem` children (dropdown loses icons) -- NOT recommended
- (B) Remove `<SelectValue>` from `ScopeTriggerContent` and render static text directly -- RECOMMENDED. Replace `<SelectValue placeholder="...">` with a plain `<span>` containing the label text. This avoids Radix re-rendering item content in the trigger.

**Confidence:** HIGH -- verified by reading both `scope-filter.tsx` and `select.tsx` source

### Bug 2: "All Documents" Scope Sends Invalid Params (422)

**File:** `electron-app/src/renderer/components/knowledge/folder-tree.tsx` (line 264-280)
**Root cause:** When `scope === 'all'`, `scopeId` is `null`. `handleCreateFirstDocument` resolves to `scope_id: ''` (empty string). The backend `DocumentCreate` schema requires `scope_id` to be a valid UUID (`scope_id: UUID`), and `scope` must be one of `"application" | "project" | "personal"`. Sending `scope="all"` with `scope_id=""` triggers Pydantic 422 validation.

**The "All Documents" scope is a UI-only aggregation view.** It does not correspond to any backend scope. Creating a document requires choosing a real scope.

**Fix pattern:** When user clicks "Create" from "All Documents" view, show a scope picker dialog that lets them choose application, project, or personal scope. Only then call the create mutation with the chosen scope. This project already has `electron-app/src/renderer/components/ui/dialog.tsx` (Radix Dialog via shadcn/ui) available for the picker.

**Dialog should contain:**
- Radio group or simple list: "My Notes", then each application and project from the existing scope filter data
- OK/Cancel buttons
- On confirm: call `createDocument.mutate(...)` with chosen scope+scope_id

**Confidence:** HIGH -- verified schema (`DocumentCreate.scope` is `Literal["application", "project", "personal"]`, `scope_id` is `UUID`)

### Bug 3: "My Notes" Sends Empty scope_id (422)

**File:** `electron-app/src/renderer/components/knowledge/folder-tree.tsx` (line 264-265)
**Root cause:** When `scope === 'personal'`, `scopeId` from `KnowledgeBaseContext` is `null` (the context sets `scopeId: null` for personal scope -- see `handleValueChange` in `scope-filter.tsx` line 62). The `handleCreateFirstDocument` does `scopeId ?? ''` which sends empty string as `scope_id`.

Meanwhile, `useDocuments` hook (line 155) correctly resolves personal scope: `const userId = useAuthStore((s) => s.user?.id ?? null)` and `resolveScope()` (lines 129-140) maps personal scope to `apiScopeId: userId`. But the create flow in `folder-tree.tsx` does NOT use `resolveScope()` -- it directly reads `scopeId` from context.

**Fix pattern:** In `handleCreateFirstDocument` and `handleNewDocument`, when `scope === 'personal'`, resolve `scope_id` to the current user's ID from `useAuthStore`. The same `resolveScope` helper from `use-documents.ts` should be reused or the logic duplicated locally.

Specifically:
```typescript
const userId = useAuthStore((s) => s.user?.id ?? null)
// In handleCreateFirstDocument:
const resolvedScopeId = scope === 'personal' ? userId : scopeId
```

**Confidence:** HIGH -- verified exact code flow through context, hook, and backend schema

### Bug 4: Application/Project Scope Returns 500 (lazy="dynamic" + async)

**File:** `fastapi-backend/app/models/document.py` (lines 202-206)
**Root cause:** The `Document.tags` relationship uses `lazy="dynamic"`, which returns a `Query` object (sync-only). When the async session tries to serialize a `Document` that has been `refresh()`ed, SQLAlchemy attempts to load the `tags` relationship. With async sessions, `lazy="dynamic"` raises `MissingGreenlet` / `InvalidRequestError` because dynamic loading requires synchronous access.

The `create_document` endpoint (documents.py line 206-208) does `await db.refresh(document)` then `DocumentResponse.model_validate(document)`. The `DocumentResponse` schema includes `tags: list[TagResponse] = []` (document.py schema line 107), which triggers attribute access on `document.tags`.

**Fix pattern:** Change `lazy="dynamic"` to `lazy="selectin"` on `Document.tags` relationship. `selectin` is async-compatible and will eagerly load tag assignments in a second query when the document is loaded.

```python
tags = relationship(
    "DocumentTagAssignment",
    back_populates="document",
    cascade="all, delete-orphan",
    lazy="selectin",
)
```

**Note:** There are many other `lazy="dynamic"` relationships across the codebase (application.py, project.py, user.py, task.py, document_folder.py, document_tag.py). These should only be changed if they cause errors in currently-exercised code paths. For this phase, only `Document.tags` is confirmed to cause a 500.

**Confidence:** HIGH -- `lazy="dynamic"` incompatibility with async SQLAlchemy is a well-documented issue

### Bug 5: No Loading State or Error Feedback on Create Button

**Files:**
- `electron-app/src/renderer/components/knowledge/folder-tree.tsx` (lines 364-380, empty state button)
- `electron-app/src/renderer/hooks/use-documents.ts` (useCreateDocument mutation)

**Root cause:** The "Create your first document" button has no `disabled` state during mutation. No error feedback mechanism exists -- the mutation `onError` callback is not wired.

**Fix pattern:**
1. **Disable button during mutation:** `createDocument.isPending` from TanStack Query mutation result
2. **Error toast:** The project does NOT have a global toast system (no sonner, no shadcn toast component). The only toast pattern is a custom implementation in `ArchivedTasksList.tsx`. Options:
   - (A) Add sonner (lightweight toast library that works with shadcn/ui) -- most standard approach
   - (B) Build a minimal custom toast using existing Radix primitives -- more coupling
   - (C) Inline error message near the button -- simplest, least reusable

**Recommendation:** Use sonner. It is the standard shadcn/ui toast solution, adds ~3KB, and provides `toast.error()` / `toast.success()` with zero configuration beyond adding `<Toaster />` to the app root.

```bash
cd electron-app && npm install sonner
```

**Confidence:** HIGH for disabled state (standard TanStack Query pattern). MEDIUM for toast choice (sonner is standard for shadcn/ui but project hasn't adopted it yet).

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Toast notifications | Custom toast component | sonner | Already standard for shadcn/ui, handles animations, stacking, auto-dismiss |
| Scope picker dialog | Custom modal positioning | Radix Dialog (already installed) | Accessibility, focus trap, portal handling |
| Mutation loading states | Manual `isLoading` state | TanStack Query `isPending` | Already available on mutation result, handles race conditions |

## Common Pitfalls

### Pitfall 1: SelectValue Rendering Behavior
**What goes wrong:** Developers assume `SelectValue` renders only placeholder text. It actually renders the full `ItemText` children of the selected item when a value is set.
**How to avoid:** When customizing trigger content, either use `SelectValue` alone (it carries the full item content) OR render static content without `SelectValue`.

### Pitfall 2: Scope Resolution Inconsistency
**What goes wrong:** The `resolveScope` helper in `use-documents.ts` correctly maps `personal` to `userId`, but this logic is not reused in mutation call sites in `folder-tree.tsx`.
**How to avoid:** Centralize scope resolution. Either export and reuse `resolveScope` from `use-documents.ts`, or move it to a shared utility.

### Pitfall 3: lazy="dynamic" in Async SQLAlchemy
**What goes wrong:** `lazy="dynamic"` returns a synchronous `Query` object. Accessing it in an async context raises `MissingGreenlet`.
**How to avoid:** Use `lazy="selectin"` or `lazy="noload"` for relationships that need to work with async sessions. Only change relationships that are actually accessed in async code paths.

### Pitfall 4: Dialog State vs. Mutation State
**What goes wrong:** Opening a scope picker dialog, choosing a scope, and triggering mutation involves multiple state transitions. If not managed carefully, the dialog can close before the mutation completes, or errors go unhandled.
**How to avoid:** Keep dialog open until mutation settles. Use `onSuccess` to close dialog and `onError` to show error within dialog.

## Architecture Patterns

### Scope Picker Dialog Pattern
```
ScopePickerDialog (new component)
├── Uses Radix Dialog (existing ui/dialog.tsx)
├── Fetches applications via useApplications() (existing hook)
├── Fetches projects via useProjects() (existing hooks, per app)
├── Returns { scope, scopeId } on confirm
└── Caller handles mutation with returned scope
```

The dialog should be a controlled component:
```typescript
interface ScopePickerDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onConfirm: (scope: ScopeType, scopeId: string) => void
}
```

### Mutation Error Handling Pattern
```typescript
createDocument.mutate(params, {
  onSuccess: (data) => {
    selectDocument(data.id)
    // ... existing success handling
  },
  onError: (error) => {
    toast.error(error.message)
  },
})
```

### Button Loading State Pattern
```tsx
<button
  onClick={handleCreate}
  disabled={createDocument.isPending}
  className={cn(/* ... */)}
>
  {createDocument.isPending ? (
    <Loader2 className="h-4 w-4 animate-spin" />
  ) : (
    <FilePlus className="h-4 w-4" />
  )}
  {createDocument.isPending ? 'Creating...' : 'Create your first document'}
</button>
```

## Code Examples

### Fix: Document.tags relationship (backend)
```python
# Source: fastapi-backend/app/models/document.py lines 202-207
# BEFORE:
tags = relationship(
    "DocumentTagAssignment",
    back_populates="document",
    cascade="all, delete-orphan",
    lazy="dynamic",  # BROKEN with async
)

# AFTER:
tags = relationship(
    "DocumentTagAssignment",
    back_populates="document",
    cascade="all, delete-orphan",
    lazy="selectin",  # async-compatible
)
```

### Fix: ScopeTriggerContent duplicate icons (frontend)
```typescript
// BEFORE (scope-filter.tsx ScopeTriggerContent):
// Renders <Icon> + <SelectValue> where SelectValue re-renders item content with icon

// AFTER: Render icon + static text, no SelectValue
function ScopeTriggerContent({ scope, scopeId, applications }: Props): JSX.Element {
  if (scope === 'personal') {
    return (
      <span className="flex items-center gap-1.5">
        <User className="h-3.5 w-3.5 text-muted-foreground shrink-0" />
        <span>My Notes</span>
      </span>
    )
  }
  // ... similar for other scopes
}
```

### Fix: Personal scope resolution (frontend)
```typescript
// In folder-tree.tsx, add:
const userId = useAuthStore((s) => s.user?.id ?? null)

// In handleCreateFirstDocument / handleNewDocument:
const resolvedScopeId = scope === 'personal' ? (userId ?? '') : (scopeId ?? '')
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| `lazy="dynamic"` | `lazy="selectin"` or `lazy="noload"` | SQLAlchemy 2.0 (async) | Required for async sessions |
| Custom toast components | sonner library | 2024+ shadcn/ui ecosystem | Standard toast solution for shadcn/ui projects |
| Manual loading state | TanStack Query `isPending` | TanStack Query v5 | Renamed from `isLoading` to `isPending` for mutations |

## Open Questions

1. **Scope picker for non-empty "All Documents" view:**
   - The phase description mentions "Create button" -- is there a create button in the non-empty tree view for "All Documents", or only the empty-state button?
   - Recommendation: Check if there's a header/toolbar create button that also needs the scope picker treatment. The folder-tree empty state button is confirmed.

2. **Other lazy="dynamic" relationships:**
   - 25+ other relationships use `lazy="dynamic"` across the codebase
   - Only `Document.tags` is confirmed broken. Others may break as more features are built.
   - Recommendation: Fix only `Document.tags` in this phase. Document the pattern for future phases.

## Sources

### Primary (HIGH confidence)
- `fastapi-backend/app/models/document.py` - Direct code inspection of tags relationship
- `fastapi-backend/app/schemas/document.py` - DocumentCreate schema validation rules
- `electron-app/src/renderer/components/knowledge/scope-filter.tsx` - ScopeTriggerContent rendering
- `electron-app/src/renderer/components/ui/select.tsx` - SelectItem/SelectValue behavior
- `electron-app/src/renderer/components/knowledge/folder-tree.tsx` - Create flow code paths
- `electron-app/src/renderer/hooks/use-documents.ts` - resolveScope helper, mutation hooks
- `electron-app/src/renderer/contexts/knowledge-base-context.tsx` - Scope state management

### Secondary (MEDIUM confidence)
- sonner as shadcn/ui toast standard (based on shadcn/ui ecosystem conventions)

## Metadata

**Confidence breakdown:**
- Bug diagnosis: HIGH - all root causes verified by code inspection
- Fix patterns: HIGH - standard patterns for each technology
- Toast recommendation (sonner): MEDIUM - standard choice but not yet adopted in project
- Scope picker dialog: HIGH - uses existing Radix Dialog component

**Research date:** 2026-01-31
**Valid until:** 2026-03-01 (stable -- bug fixes against existing code)
