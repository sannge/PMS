---
phase: 04.1-document-creation-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fastapi-backend/app/models/document.py
  - electron-app/src/renderer/components/knowledge/scope-filter.tsx
  - electron-app/src/renderer/App.tsx
  - electron-app/package.json
autonomous: true

must_haves:
  truths:
    - "Scope filter trigger shows exactly one icon per scope (no duplicate globe/user/building icons)"
    - "Creating a document in Application or Project scope does not return 500"
    - "Sonner Toaster component is mounted in the app root for downstream toast usage"
  artifacts:
    - path: "fastapi-backend/app/models/document.py"
      provides: "Document.tags relationship with async-compatible loading"
      contains: 'lazy="selectin"'
    - path: "electron-app/src/renderer/components/knowledge/scope-filter.tsx"
      provides: "ScopeTriggerContent without SelectValue duplication"
    - path: "electron-app/src/renderer/App.tsx"
      provides: "Sonner Toaster mounted in app root"
      contains: "Toaster"
  key_links:
    - from: "fastapi-backend/app/models/document.py"
      to: "DocumentTagAssignment"
      via: "selectin relationship loading"
      pattern: 'lazy="selectin"'
---

<objective>
Fix backend tags relationship crash and frontend duplicate icon bug, install sonner toast library.

Purpose: Unblock document creation in Application/Project scopes (500 error) and fix visual duplication in scope filter. Install sonner so Plan 02 can use toast.error() for error feedback.

Output: Backend returns documents with tags correctly, scope filter shows single icon per option, sonner is available globally.
</objective>

<execution_context>
@C:\Users\samng\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\samng\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04.1-document-creation-bug-fixes/04.1-RESEARCH.md
@fastapi-backend/app/models/document.py
@electron-app/src/renderer/components/knowledge/scope-filter.tsx
@electron-app/src/renderer/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix backend tags relationship and frontend icon duplication</name>
  <files>
    fastapi-backend/app/models/document.py
    electron-app/src/renderer/components/knowledge/scope-filter.tsx
  </files>
  <action>
    **Backend (document.py line 202-207):**
    Change Document.tags relationship from `lazy="dynamic"` to `lazy="selectin"`. This is the only change needed -- `lazy="dynamic"` returns a synchronous Query object that crashes with async SQLAlchemy sessions. `selectin` is async-compatible.

    ```python
    tags = relationship(
        "DocumentTagAssignment",
        back_populates="document",
        cascade="all, delete-orphan",
        lazy="selectin",
    )
    ```

    Do NOT change any other `lazy="dynamic"` relationships in other models (application.py, project.py, etc.) -- only Document.tags is confirmed broken.

    **Frontend (scope-filter.tsx ScopeTriggerContent function, lines 136-180):**
    The bug: ScopeTriggerContent renders an explicit icon (Globe, User, Building2, FolderKanban) alongside `<SelectValue>`. But SelectValue renders the full selected item's ItemText children, which ALSO contain an icon. This causes duplicate icons.

    Fix: Replace all `<SelectValue placeholder="...">` in ScopeTriggerContent with plain `<span>` elements containing the label text. The ScopeTriggerContent function should render icon + static text only, no SelectValue.

    For each branch in ScopeTriggerContent:
    - `scope === 'personal'`: icon + `<span>My Notes</span>`
    - `scope === 'application'`: icon + `<span>{app?.name ?? 'Application'}</span>`
    - `scope === 'project'`: icon + `<span>Project</span>` (note: projects don't have easy name lookup here, keep generic label -- OR look up project name if data is available from a parent query)
    - default ('all'): icon + `<span>All Documents</span>`

    Remove the `SelectValue` import if it is no longer used anywhere in the file (check: it is only used in ScopeTriggerContent, so it can be removed from the import).
  </action>
  <verify>
    Backend: `cd fastapi-backend && python -c "from app.models.document import Document; print('OK')"` succeeds.
    Frontend: `cd electron-app && npx tsc --noEmit` passes (typecheck).
    Manual: scope-filter.tsx ScopeTriggerContent contains zero `<SelectValue` references.
  </verify>
  <done>
    Document.tags uses lazy="selectin". ScopeTriggerContent renders static text labels (no SelectValue), eliminating duplicate icons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install sonner and mount Toaster in app root</name>
  <files>
    electron-app/package.json
    electron-app/src/renderer/App.tsx
  </files>
  <action>
    **Install sonner:**
    ```bash
    cd electron-app && npm install sonner
    ```

    **Mount Toaster in App.tsx:**
    Import `Toaster` from `sonner` at the top of App.tsx.

    Add `<Toaster />` inside the App component's JSX, after `</QueryClientProvider>` closing tag (sibling level, inside the fragment or as last child). The Toaster should be outside all providers but inside the root return. Place it right before the ReactQueryDevtools line:

    ```tsx
    function App(): JSX.Element {
      return (
        <QueryClientProvider client={queryClient}>
          <AuthProvider>
            <NotificationUIProvider>
              <ThemeProvider>
                <ErrorBoundary>
                  <QueryClientInitializer>
                    <AuthRouter />
                  </QueryClientInitializer>
                </ErrorBoundary>
              </ThemeProvider>
            </NotificationUIProvider>
          </AuthProvider>
          {import.meta.env.DEV && <ReactQueryDevtools initialIsOpen={false} />}
        </QueryClientProvider>
        // WRONG - can't be sibling of QueryClientProvider
      )
    }
    ```

    Actually, place `<Toaster richColors />` INSIDE the provider tree, after `<QueryClientInitializer>` block, before `</ErrorBoundary>`:

    ```tsx
    <ErrorBoundary>
      <QueryClientInitializer>
        <AuthRouter />
      </QueryClientInitializer>
      <Toaster richColors />
    </ErrorBoundary>
    ```

    Use `richColors` prop for better error/success color contrast. No other configuration needed -- sonner handles positioning, animations, and stacking automatically.
  </action>
  <verify>
    `cd electron-app && npx tsc --noEmit` passes.
    `cd electron-app && node -e "require('./node_modules/sonner/package.json').version"` prints version.
    App.tsx contains `<Toaster` and `import { Toaster } from 'sonner'`.
  </verify>
  <done>
    Sonner installed, Toaster mounted in app root. `toast.error()` and `toast.success()` are now available anywhere in the app via `import { toast } from 'sonner'`.
  </done>
</task>

</tasks>

<verification>
- Backend: Document model loads without import errors
- Frontend: TypeScript compilation passes with zero errors
- scope-filter.tsx: No SelectValue in ScopeTriggerContent
- App.tsx: Toaster component is rendered
</verification>

<success_criteria>
1. Document.tags relationship uses lazy="selectin" (grep confirms)
2. ScopeTriggerContent has zero SelectValue references
3. sonner is in package.json dependencies
4. Toaster is rendered in App.tsx
5. TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-document-creation-bug-fixes/04.1-01-SUMMARY.md`
</output>
